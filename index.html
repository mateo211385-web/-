<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>آزمونِتو</title>
<meta name="application-name" content="آزمونِتو">
<meta name="description" content="پیگیری درصد کنکور — آفلاین">
<meta name="theme-color" content="#141B2D">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="آزمونِتو">
<link id="pwa-icon-link" rel="apple-touch-icon">
<link rel="manifest" id="pwa-manifest-link">
<script>
(function(){
  var svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#141B2D"/><rect x="30" y="30" width="452" height="452" fill="#635BFF" rx="20"/><rect x="30" y="30" width="452" height="452" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="2" rx="20"/><polygon points="290,80 195,275 260,275 228,440 348,210 276,210 314,80" fill="white"/></svg>';
  var iconURL='data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(svg)));
  document.getElementById('pwa-icon-link').href=iconURL;
  var manifest=JSON.stringify({name:'آزمونِتو',short_name:'آزمونِتو',description:'پیگیری درصد کنکور',start_url:'./',display:'standalone',orientation:'any',background_color:'#141B2D',theme_color:'#141B2D',lang:'fa',dir:'rtl',icons:[{src:iconURL,sizes:'192x192',type:'image/svg+xml',purpose:'any maskable'},{src:iconURL,sizes:'512x512',type:'image/svg+xml',purpose:'any maskable'}]});
  var mBlob=new Blob([manifest],{type:'application/manifest+json'});
  document.getElementById('pwa-manifest-link').href=URL.createObjectURL(mBlob);
  var swCode="const C='az-v1';self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));self.addEventListener('fetch',e=>{e.respondWith(caches.open(C).then(c=>c.match(e.request).then(r=>r||fetch(e.request).then(res=>{c.put(e.request,res.clone());return res;}))));});";
  if('serviceWorker' in navigator){var b=new Blob([swCode],{type:'application/javascript'});navigator.serviceWorker.register(URL.createObjectURL(b),{scope:'./'}).catch(function(){});}
  // apply theme before render
  var t=localStorage.getItem('az_theme')||'pro';
  document.documentElement.setAttribute('data-theme',t);
})();
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap');

/* ═══════════════════════════════════════════════
   DASHBOARD PRO — Light, crisp, data-focused
   ═══════════════════════════════════════════════ */
:root, [data-theme="pro"] {
  /* ══ ARCTIC PRO — بلوط روشن، یخی، دقیق ══ */
  --bg:        #F2F5FF;
  --bg2:       #E8EDFF;
  --sur:       #FFFFFF;
  --sur2:      #F6F8FF;
  --sur3:      #EEF1FC;
  --sbg:       #0F1629;
  --sbg2:      #1A2440;
  --sbdr:      rgba(255,255,255,.08);
  --sbdr2:     rgba(255,255,255,.14);
  --bdr:       #DDE3F5;
  --bdr2:      #C4CCEC;
  --acc:       #4F46E5;
  --acc2:      #6D64FF;
  --acc-d:     rgba(79,70,229,.11);
  --acc-glow:  rgba(79,70,229,.35);
  --G:         #059669;
  --G-d:       rgba(5,150,105,.12);
  --P:         #DC2626;
  --P-d:       rgba(220,38,38,.11);
  --Y:         #D97706;
  --Y-d:       rgba(217,119,6,.12);
  --B:         #0EA5E9;
  --V:         #7C3AED;
  --txt:       #0F172A;
  --txt2:      #334155;
  --txt3:      #7C8BB0;
  --txt-inv:   #FFFFFF;
  --sha-sm:    0 1px 4px rgba(15,22,41,.07), 0 2px 10px rgba(15,22,41,.05);
  --sha:       0 2px 10px rgba(15,22,41,.08), 0 8px 28px rgba(15,22,41,.06);
  --sha-md:    0 6px 20px rgba(15,22,41,.10), 0 16px 48px rgba(15,22,41,.08);
  --sha-lg:    0 12px 40px rgba(15,22,41,.14), 0 28px 72px rgba(15,22,41,.12);
  --sha-acc:   0 4px 20px rgba(79,70,229,.40);
  --r:         16px;
  --rs:        10px;
  --chart-bg:  transparent;
  --chart-grid:#E4E9F8;
  --chart-lbl: #7C8BB0;
  --chart-dot: #FFFFFF;
  --td:        .20s;
  --td-slow:   .38s;
}

/* ═══════════════════════════════════════════════
   OBSIDIAN GLASS — فضای عمیق، درخشش کیهانی
   ═══════════════════════════════════════════════ */
[data-theme="glass"] {
  --bg:        #04050D;
  --bg2:       #080A17;
  --sur:       rgba(255,255,255,.045);
  --sur2:      rgba(255,255,255,.028);
  --sur3:      rgba(255,255,255,.015);
  --sbg:       rgba(255,255,255,.032);
  --sbg2:      rgba(255,255,255,.058);
  --sbdr:      rgba(255,255,255,.07);
  --sbdr2:     rgba(255,255,255,.13);
  --bdr:       rgba(255,255,255,.08);
  --bdr2:      rgba(255,255,255,.15);
  --acc:       #7C3AED;
  --acc2:      #9D68FE;
  --acc-d:     rgba(124,58,237,.18);
  --acc-glow:  rgba(124,58,237,.55);
  --G:         #10B981;
  --G-d:       rgba(16,185,129,.15);
  --P:         #F43F5E;
  --P-d:       rgba(244,63,94,.15);
  --Y:         #F59E0B;
  --Y-d:       rgba(245,158,11,.15);
  --B:         #06B6D4;
  --V:         #A855F7;
  --txt:       #F1F5FF;
  --txt2:      #94A3CC;
  --txt3:      #4A5280;
  --txt-inv:   #04050D;
  --sha-sm:    0 2px 10px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.06);
  --sha:       0 4px 20px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.07);
  --sha-md:    0 8px 36px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.08);
  --sha-lg:    0 18px 64px rgba(0,0,0,.75), inset 0 1px 0 rgba(255,255,255,.09);
  --sha-acc:   0 4px 28px rgba(124,58,237,.60), 0 0 60px rgba(124,58,237,.20);
  --r:         18px;
  --rs:        11px;
  --chart-bg:  transparent;
  --chart-grid:rgba(255,255,255,.05);
  --chart-lbl: #4A5280;
  --chart-dot: #04050D;
  --td:        .25s;
  --td-slow:   .45s;
}

/* ═══════════════════════════════════════════════
   MIDNIGHT EMBER — آتش در شب، گرم و عمیق
   ═══════════════════════════════════════════════ */
[data-theme="ember"] {
  --bg:        #0C0A0A;
  --bg2:       #120E0E;
  --sur:       rgba(255,120,60,.04);
  --sur2:      rgba(255,100,40,.025);
  --sur3:      rgba(255,80,20,.015);
  --sbg:       rgba(20,10,8,.95);
  --sbg2:      rgba(35,18,12,.95);
  --sbdr:      rgba(255,120,60,.10);
  --sbdr2:     rgba(255,140,80,.18);
  --bdr:       rgba(255,100,40,.12);
  --bdr2:      rgba(255,120,60,.22);
  --acc:       #F97316;
  --acc2:      #FB923C;
  --acc-d:     rgba(249,115,22,.16);
  --acc-glow:  rgba(249,115,22,.55);
  --G:         #22C55E;
  --G-d:       rgba(34,197,94,.14);
  --P:         #EF4444;
  --P-d:       rgba(239,68,68,.14);
  --Y:         #EAB308;
  --Y-d:       rgba(234,179,8,.14);
  --B:         #06B6D4;
  --V:         #A855F7;
  --txt:       #FDF0E8;
  --txt2:      #C4A08A;
  --txt3:      #6B4A38;
  --txt-inv:   #0C0A0A;
  --sha-sm:    0 2px 10px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,120,60,.06);
  --sha:       0 4px 20px rgba(0,0,0,.60), inset 0 1px 0 rgba(255,120,60,.07);
  --sha-md:    0 8px 36px rgba(0,0,0,.70), inset 0 1px 0 rgba(255,120,60,.08);
  --sha-lg:    0 18px 64px rgba(0,0,0,.80), inset 0 1px 0 rgba(255,120,60,.09);
  --sha-acc:   0 4px 28px rgba(249,115,22,.55), 0 0 50px rgba(249,115,22,.18);
  --r:         16px;
  --rs:        10px;
  --chart-bg:  transparent;
  --chart-grid:rgba(255,120,60,.07);
  --chart-lbl: #6B4A38;
  --chart-dot: #0C0A0A;
  --td:        .22s;
  --td-slow:   .42s;
}

/* ═══════════════════════════════════════════════
   AURORA — شفق قطبی، سبز و آبی رویایی
   ═══════════════════════════════════════════════ */
[data-theme="aurora"] {
  --bg:        #050C12;
  --bg2:       #07101A;
  --sur:       rgba(0,240,160,.038);
  --sur2:      rgba(0,200,140,.022);
  --sur3:      rgba(0,180,120,.013);
  --sbg:       rgba(0,12,20,.96);
  --sbg2:      rgba(0,20,32,.96);
  --sbdr:      rgba(0,240,160,.09);
  --sbdr2:     rgba(0,240,160,.16);
  --bdr:       rgba(0,200,140,.10);
  --bdr2:      rgba(0,240,160,.20);
  --acc:       #00D4AA;
  --acc2:      #00F0C0;
  --acc-d:     rgba(0,212,170,.16);
  --acc-glow:  rgba(0,212,170,.55);
  --G:         #00F0A0;
  --G-d:       rgba(0,240,160,.14);
  --P:         #FF4D6A;
  --P-d:       rgba(255,77,106,.14);
  --Y:         #FFD700;
  --Y-d:       rgba(255,215,0,.13);
  --B:         #00BFFF;
  --V:         #BF5FFF;
  --txt:       #E0FFF8;
  --txt2:      #80C8B8;
  --txt3:      #2A6050;
  --txt-inv:   #050C12;
  --sha-sm:    0 2px 10px rgba(0,0,0,.55), inset 0 1px 0 rgba(0,240,160,.06);
  --sha:       0 4px 20px rgba(0,0,0,.60), inset 0 1px 0 rgba(0,240,160,.07);
  --sha-md:    0 8px 36px rgba(0,0,0,.70), inset 0 1px 0 rgba(0,240,160,.08);
  --sha-lg:    0 18px 64px rgba(0,0,0,.80), inset 0 1px 0 rgba(0,240,160,.09);
  --sha-acc:   0 4px 28px rgba(0,212,170,.55), 0 0 60px rgba(0,212,170,.20);
  --r:         18px;
  --rs:        11px;
  --chart-bg:  transparent;
  --chart-grid:rgba(0,200,140,.07);
  --chart-lbl: #2A6050;
  --chart-dot: #050C12;
  --td:        .24s;
  --td-slow:   .44s;
}

/* GZ today panel */
.gz-today-inner { transition: max-height .35s ease; }


*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0 }
html { scroll-behavior: smooth }

body {
  font-family: 'Vazirmatn', sans-serif;
  background: var(--bg);
  color: var(--txt);
  min-height: 100vh;
  font-size: 14px;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
  transition: background var(--td-slow) ease, color var(--td-slow) ease;
}

[data-theme="glass"] body {
  background:
    radial-gradient(ellipse 100% 80% at 10% -10%, rgba(124,58,237,.30) 0%, transparent 50%),
    radial-gradient(ellipse 80% 70% at 90% 10%,  rgba(6,182,212,.22)  0%, transparent 45%),
    radial-gradient(ellipse 70% 60% at 45% 95%,  rgba(244,63,94,.18)  0%, transparent 50%),
    radial-gradient(ellipse 50% 40% at 80% 60%,  rgba(16,185,129,.12) 0%, transparent 40%),
    #04050D;
  background-attachment: fixed;
}

[data-theme="ember"] body {
  background:
    radial-gradient(ellipse 80% 60% at 20% 20%, rgba(249,115,22,.22) 0%, transparent 55%),
    radial-gradient(ellipse 60% 50% at 80% 80%, rgba(239,68,68,.18)  0%, transparent 50%),
    radial-gradient(ellipse 40% 30% at 60% 10%, rgba(234,179,8,.12)  0%, transparent 40%),
    #0C0A0A;
  background-attachment: fixed;
}

[data-theme="aurora"] body {
  background:
    radial-gradient(ellipse 100% 70% at 30% 0%,   rgba(0,212,170,.25) 0%, transparent 55%),
    radial-gradient(ellipse 70% 60% at 80% 20%,   rgba(0,191,255,.20) 0%, transparent 50%),
    radial-gradient(ellipse 50% 40% at 10% 80%,   rgba(191,95,255,.15) 0%, transparent 45%),
    radial-gradient(ellipse 60% 50% at 70% 90%,   rgba(0,240,160,.12)  0%, transparent 40%),
    #050C12;
  background-attachment: fixed;
}

/* ═══ ANIMATED AMBIENT ORBS (desktop only) ═════════════════════ */
@keyframes orb-float-1 {
  0%,100% { transform: translate(0,0) scale(1); }
  33%      { transform: translate(60px,-40px) scale(1.08); }
  66%      { transform: translate(-30px,50px) scale(.94); }
}
@keyframes orb-float-2 {
  0%,100% { transform: translate(0,0) scale(1); }
  40%      { transform: translate(-70px,30px) scale(1.06); }
  70%      { transform: translate(40px,-60px) scale(.96); }
}
@keyframes orb-float-3 {
  0%,100% { transform: translate(0,0) scale(1); }
  30%      { transform: translate(50px,40px) scale(.92); }
  70%      { transform: translate(-40px,-30px) scale(1.1); }
}
@keyframes pulse-glow {
  0%,100% { opacity:.7 }
  50%      { opacity:1 }
}

.ambient-orb {
  position: fixed; border-radius: 50%;
  filter: blur(80px); pointer-events: none; z-index: 0;
  animation: pulse-glow 8s ease-in-out infinite;
}
[data-theme="glass"] .ambient-orb-1 {
  width:500px; height:500px; top:-100px; right:10%;
  background: radial-gradient(circle, rgba(124,58,237,.18) 0%, transparent 70%);
  animation: orb-float-1 18s ease-in-out infinite, pulse-glow 8s ease-in-out infinite;
}
[data-theme="glass"] .ambient-orb-2 {
  width:400px; height:400px; bottom:5%; left:5%;
  background: radial-gradient(circle, rgba(6,182,212,.14) 0%, transparent 70%);
  animation: orb-float-2 22s ease-in-out infinite, pulse-glow 10s ease-in-out infinite;
}
[data-theme="glass"] .ambient-orb-3 {
  width:300px; height:300px; top:40%; left:40%;
  background: radial-gradient(circle, rgba(244,63,94,.10) 0%, transparent 70%);
  animation: orb-float-3 26s ease-in-out infinite, pulse-glow 12s ease-in-out infinite;
}
[data-theme="ember"] .ambient-orb-1 {
  width:500px; height:500px; top:-80px; right:15%;
  background: radial-gradient(circle, rgba(249,115,22,.16) 0%, transparent 70%);
  animation: orb-float-1 20s ease-in-out infinite, pulse-glow 9s ease-in-out infinite;
}
[data-theme="ember"] .ambient-orb-2 {
  width:380px; height:380px; bottom:10%; left:5%;
  background: radial-gradient(circle, rgba(239,68,68,.13) 0%, transparent 70%);
  animation: orb-float-2 24s ease-in-out infinite, pulse-glow 11s ease-in-out infinite;
}
[data-theme="ember"] .ambient-orb-3 {
  width:280px; height:280px; top:50%; right:30%;
  background: radial-gradient(circle, rgba(234,179,8,.09) 0%, transparent 70%);
  animation: orb-float-3 28s ease-in-out infinite, pulse-glow 13s ease-in-out infinite;
}
[data-theme="aurora"] .ambient-orb-1 {
  width:550px; height:550px; top:-120px; right:10%;
  background: radial-gradient(circle, rgba(0,212,170,.18) 0%, transparent 70%);
  animation: orb-float-1 19s ease-in-out infinite, pulse-glow 8s ease-in-out infinite;
}
[data-theme="aurora"] .ambient-orb-2 {
  width:420px; height:420px; bottom:5%; left:5%;
  background: radial-gradient(circle, rgba(0,191,255,.14) 0%, transparent 70%);
  animation: orb-float-2 23s ease-in-out infinite, pulse-glow 10s ease-in-out infinite;
}
[data-theme="aurora"] .ambient-orb-3 {
  width:320px; height:320px; top:35%; left:35%;
  background: radial-gradient(circle, rgba(191,95,255,.11) 0%, transparent 70%);
  animation: orb-float-3 27s ease-in-out infinite, pulse-glow 12s ease-in-out infinite;
}
[data-theme="pro"] .ambient-orb { display: none }

/* ═══ CARD HOVER GLOW ═══════════════════════════════════════════ */
[data-theme="glass"] .card:hover,
[data-theme="ember"] .card:hover,
[data-theme="aurora"] .card:hover {
  border-color: rgba(255,255,255,.14);
  box-shadow: var(--sha-md), 0 0 0 1px rgba(255,255,255,.05);
  transform: translateY(-2px);
}

/* ═══ ENHANCED SECTION TITLE ════════════════════════════════════ */
.ptitle {
  font-size: 28px; font-weight: 900; letter-spacing: -1.2px; line-height: 1.1;
  position: relative;
}
[data-theme="glass"] .ptitle,
[data-theme="ember"] .ptitle,
[data-theme="aurora"] .ptitle {
  text-shadow: 0 0 40px var(--acc-glow);
}

/* ═══ STAT VALUE GLOW ════════════════════════════════════════ */
[data-theme="glass"] .sv,
[data-theme="ember"] .sv,
[data-theme="aurora"] .sv {
  text-shadow: 0 0 20px var(--acc-glow);
}

/* ═══ BUTTON GLOW ENHANCED ══════════════════════════════════════ */
[data-theme="glass"] .bp:hover,
[data-theme="ember"] .bp:hover,
[data-theme="aurora"] .bp:hover {
  box-shadow: 0 8px 32px var(--acc-glow), 0 0 60px rgba(255,255,255,.05);
}

/* ═══ INPUT GLOW ════════════════════════════════════════════════ */
[data-theme="glass"] input:focus,
[data-theme="ember"] input:focus,
[data-theme="aurora"] input:focus,
[data-theme="glass"] select:focus,
[data-theme="ember"] select:focus,
[data-theme="aurora"] select:focus,
[data-theme="glass"] textarea:focus,
[data-theme="ember"] textarea:focus,
[data-theme="aurora"] textarea:focus {
  box-shadow: 0 0 0 3px var(--acc-d), 0 0 20px var(--acc-glow);
}

/* ═══ TABLE ROW GLOW ════════════════════════════════════════════ */
[data-theme="glass"] tbody tr:hover td,
[data-theme="ember"] tbody tr:hover td,
[data-theme="aurora"] tbody tr:hover td {
  background: var(--acc-d);
  box-shadow: inset 0 0 20px rgba(255,255,255,.02);
}

/* ═══ CT-DOT PULSE ANIMATION ════════════════════════════════════ */
@keyframes dot-pulse {
  0%,100% { box-shadow: 0 0 4px var(--acc-glow) }
  50%      { box-shadow: 0 0 12px var(--acc-glow), 0 0 24px var(--acc-glow) }
}
[data-theme="glass"] .ct-dot,
[data-theme="ember"] .ct-dot,
[data-theme="aurora"] .ct-dot {
  animation: dot-pulse 3s ease-in-out infinite;
}

/* ═══ SIDEBAR NAV ITEM HOVER GLOW ═══════════════════════════════ */
[data-theme="glass"] .ni:hover,
[data-theme="ember"] .ni:hover,
[data-theme="aurora"] .ni:hover {
  background: rgba(255,255,255,.065);
  box-shadow: inset 0 0 20px rgba(255,255,255,.02);
}

/* ═══ SCROLLBAR THEMING ══════════════════════════════════════ */
::-webkit-scrollbar { width: 5px; height: 5px }
::-webkit-scrollbar-track { background: transparent }
::-webkit-scrollbar-thumb { background: var(--bdr2); border-radius: 99px }
::-webkit-scrollbar-thumb:hover { background: var(--acc) }

/* ═══════════════════════════════════════════════ LAYOUT ═══ */
.app { display: flex; min-height: 100vh }

.sidebar {
  width: 244px;
  background: var(--sbg);
  border-left: 1px solid var(--sbdr);
  display: flex; flex-direction: column;
  position: fixed; right: 0; top: 0; bottom: 0; z-index: 100;
  transition: background var(--td-slow), border-color var(--td-slow);
}

[data-theme="glass"] .sidebar {
  backdrop-filter: blur(32px) saturate(200%);
  -webkit-backdrop-filter: blur(32px) saturate(200%);
  box-shadow: -4px 0 48px rgba(0,0,0,.5), inset -1px 0 0 rgba(255,255,255,.06);
}
[data-theme="ember"] .sidebar {
  backdrop-filter: blur(28px) saturate(160%);
  -webkit-backdrop-filter: blur(28px) saturate(160%);
  box-shadow: -4px 0 48px rgba(0,0,0,.6), inset -1px 0 0 rgba(249,115,22,.08);
}
[data-theme="aurora"] .sidebar {
  backdrop-filter: blur(32px) saturate(200%);
  -webkit-backdrop-filter: blur(32px) saturate(200%);
  box-shadow: -4px 0 48px rgba(0,0,0,.55), inset -1px 0 0 rgba(0,240,160,.08);
}
[data-theme="pro"] .sidebar {
  box-shadow: -4px 0 40px rgba(15,22,41,.22);
}

.main {
  margin-right: 244px;
  flex: 1;
  padding: 30px 28px;
  min-height: 100vh;
  transition: background var(--td-slow);
}

/* ═══════════════════════════════════════════════ LOGO ═══ */
.logo {
  padding: 22px 20px 18px;
  border-bottom: 1px solid var(--sbdr);
  position: relative; overflow: hidden;
  flex-shrink: 0;
}

/* top accent line */
.logo::before {
  content: '';
  position: absolute; top: 0; right: 0; left: 0; height: 2px;
}
[data-theme="pro"] .logo::before {
  background: linear-gradient(90deg, var(--acc), var(--B), var(--G));
  height: 2.5px;
}
[data-theme="glass"] .logo::before {
  background: linear-gradient(90deg, transparent 0%, var(--acc) 30%, var(--B) 70%, transparent 100%);
  opacity: .9;
}
[data-theme="ember"] .logo::before {
  background: linear-gradient(90deg, transparent 0%, var(--P) 20%, var(--acc) 50%, var(--Y) 80%, transparent 100%);
  opacity: .9;
}
[data-theme="aurora"] .logo::before {
  background: linear-gradient(90deg, transparent 0%, var(--acc) 30%, var(--B) 60%, var(--V) 90%, transparent 100%);
  opacity: .9;
}

.logo-inner { display: flex; align-items: center; gap: 12px }

.logo-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 17px;
  flex-shrink: 0;
  position: relative;
}
[data-theme="pro"] .logo-icon {
  background: linear-gradient(135deg, var(--acc), var(--acc2));
  box-shadow: 0 4px 16px var(--acc-glow);
}
[data-theme="glass"] .logo-icon {
  background: linear-gradient(135deg, rgba(124,58,237,.7), rgba(157,104,254,.4));
  border: 1px solid rgba(124,58,237,.4);
  box-shadow: 0 4px 24px var(--acc-glow), inset 0 1px 0 rgba(255,255,255,.18);
}
[data-theme="ember"] .logo-icon {
  background: linear-gradient(135deg, rgba(249,115,22,.7), rgba(251,146,60,.4));
  border: 1px solid rgba(249,115,22,.4);
  box-shadow: 0 4px 24px var(--acc-glow), inset 0 1px 0 rgba(255,255,255,.15);
}
[data-theme="aurora"] .logo-icon {
  background: linear-gradient(135deg, rgba(0,212,170,.7), rgba(0,240,192,.4));
  border: 1px solid rgba(0,212,170,.4);
  box-shadow: 0 4px 24px var(--acc-glow), inset 0 1px 0 rgba(255,255,255,.18);
}

.logo-text { display: flex; flex-direction: column; gap: 1px }
.logo h1 { font-size: 17px; font-weight: 900; color: #fff; letter-spacing: -.5px; line-height: 1 }
.logo p { font-size: 10px; color: var(--txt3); font-weight: 500; letter-spacing: .3px }

/* ═══════════════════════════════════════════════ NAV ═══ */
.nav { padding: 16px 12px; flex: 1; overflow-y: auto }

.nav-label {
  font-size: 9px; font-weight: 800; color: var(--txt3);
  letter-spacing: 1.2px; text-transform: uppercase;
  padding: 12px 10px 6px;
}

.ni {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px;
  border-radius: var(--rs);
  cursor: pointer;
  color: rgba(255,255,255,.44);
  font-size: 13px; font-weight: 600;
  margin-bottom: 2px;
  border: 1px solid transparent;
  background: transparent;
  width: 100%; text-align: right;
  font-family: 'Vazirmatn', sans-serif;
  transition: all var(--td);
  position: relative;
}

.ni-icon {
  width: 28px; height: 28px;
  border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  flex-shrink: 0;
  transition: all var(--td);
  background: rgba(255,255,255,.05);
}

.ni:hover { color: rgba(255,255,255,.82); background: rgba(255,255,255,.055) }
.ni:hover .ni-icon { background: rgba(255,255,255,.10) }

.ni.active { color: #fff; font-weight: 700 }

[data-theme="pro"] .ni.active {
  background: rgba(99,91,255,.12);
}
[data-theme="pro"] .ni.active .ni-icon {
  background: var(--acc);
  box-shadow: 0 4px 14px var(--acc-glow);
}
[data-theme="pro"] .ni.active::after {
  content: '';
  position: absolute; right: 0; top: 25%; bottom: 25%;
  width: 3px; border-radius: 3px; background: var(--acc);
}

[data-theme="glass"] .ni.active {
  background: rgba(124,58,237,.16);
  border: 1px solid rgba(124,58,237,.24);
}
[data-theme="glass"] .ni.active .ni-icon {
  background: rgba(124,58,237,.55);
  box-shadow: 0 4px 18px rgba(124,58,237,.55);
  border: 1px solid rgba(124,58,237,.4);
}
[data-theme="ember"] .ni.active {
  background: rgba(249,115,22,.14);
  border: 1px solid rgba(249,115,22,.22);
}
[data-theme="ember"] .ni.active .ni-icon {
  background: rgba(249,115,22,.55);
  box-shadow: 0 4px 18px rgba(249,115,22,.55);
  border: 1px solid rgba(249,115,22,.4);
}
[data-theme="ember"] .ni.active::after {
  content: '';
  position: absolute; right: 0; top: 25%; bottom: 25%;
  width: 3px; border-radius: 3px; background: var(--acc);
}
[data-theme="aurora"] .ni.active {
  background: rgba(0,212,170,.14);
  border: 1px solid rgba(0,212,170,.22);
}
[data-theme="aurora"] .ni.active .ni-icon {
  background: rgba(0,212,170,.55);
  box-shadow: 0 4px 18px rgba(0,212,170,.55);
  border: 1px solid rgba(0,212,170,.4);
}
[data-theme="aurora"] .ni.active::after {
  content: '';
  position: absolute; right: 0; top: 25%; bottom: 25%;
  width: 3px; border-radius: 3px; background: var(--acc);
}

/* ═══════════════════════════════════════════════ SIDEBAR FOOTER ═══ */
.sbfoot {
  padding: 14px;
  border-top: 1px solid var(--sbdr);
  flex-shrink: 0;
}

.msbox {
  border-radius: var(--rs);
  padding: 14px 12px;
  text-align: center;
  border: 1px solid var(--sbdr2);
  position: relative; overflow: hidden;
}

[data-theme="pro"] .msbox {
  background: rgba(99,91,255,.10);
}
[data-theme="glass"] .msbox {
  background: rgba(139,92,246,.10);
  backdrop-filter: blur(10px);
}

.msbox::before {
  content: '';
  position: absolute; top: -30px; left: -30px;
  width: 90px; height: 90px;
  background: var(--acc);
  border-radius: 50%;
  opacity: .09; filter: blur(25px);
  pointer-events: none;
}

.msbox .mn { font-size: 28px; font-weight: 900; color: #fff; line-height: 1; letter-spacing: -1px }
.msbox .ml { font-size: 10px; color: var(--txt3); margin-top: 3px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px }

/* ═══════════════════════════════════════════════ BUTTONS ═══ */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 10px 20px;
  font-family: 'Vazirmatn', sans-serif;
  font-size: 13px; font-weight: 700;
  border-radius: var(--rs);
  border: none; cursor: pointer;
  transition: all var(--td);
  letter-spacing: .2px;
  white-space: nowrap;
  position: relative; overflow: hidden;
}

/* ripple */
.btn::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,.15);
  border-radius: inherit;
  opacity: 0; transition: opacity .15s;
}
.btn:active::after { opacity: 1 }
.btn:active { transform: scale(.97) }

.bp {
  background: linear-gradient(135deg, var(--acc), var(--acc2));
  color: #fff;
  box-shadow: var(--sha-acc);
}
.bp:hover { transform: translateY(-2px); box-shadow: 0 8px 28px var(--acc-glow); filter: brightness(1.1) }

.bg {
  background: var(--sur2);
  color: var(--txt2);
  border: 1px solid var(--bdr);
}
.bg:hover { background: var(--sur3); color: var(--txt); transform: translateY(-1px); box-shadow: var(--sha-sm) }

.bd {
  background: var(--P-d);
  color: var(--P);
  border: 1px solid rgba(255,71,87,.2);
}
.bd:hover { background: rgba(255,71,87,.18); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,71,87,.22) }

.bsm { padding: 7px 14px; font-size: 12px }
.bxs { padding: 4px 10px; font-size: 11px }

/* ═══════════════════════════════════════════════ CARDS ═══ */
.card {
  background: var(--sur);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 22px;
  position: relative;
  transition: all var(--td);
}

[data-theme="pro"] .card { box-shadow: var(--sha) }

[data-theme="glass"] .card {
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  box-shadow: var(--sha);
}
[data-theme="ember"] .card {
  backdrop-filter: blur(20px) saturate(160%);
  -webkit-backdrop-filter: blur(20px) saturate(160%);
  box-shadow: var(--sha);
}
[data-theme="aurora"] .card {
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  box-shadow: var(--sha);
}

.card-hover:hover { transform: translateY(-3px); box-shadow: var(--sha-md) }

.ct {
  font-size: 10px; font-weight: 800;
  color: var(--txt3);
  margin-bottom: 18px;
  text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; gap: 8px;
}

.ct-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--acc);
  display: inline-block; flex-shrink: 0;
  box-shadow: 0 0 6px var(--acc-glow);
}

.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 18px }
.g4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 18px }

/* ═══════════════════════════════════════════════ STAT CARDS ═══ */
.stc {
  border-radius: var(--r);
  padding: 22px;
  position: relative; overflow: hidden;
  transition: all var(--td);
  cursor: default;
}

[data-theme="pro"] .stc {
  background: var(--sur);
  border: 1px solid var(--bdr);
  box-shadow: var(--sha);
}
[data-theme="pro"] .stc:hover { transform: translateY(-3px); box-shadow: var(--sha-md) }
[data-theme="pro"] .stc:nth-child(1) { border-top: 3px solid var(--acc) }
[data-theme="pro"] .stc.g { border-top: 3px solid var(--G) }
[data-theme="pro"] .stc.b { border-top: 3px solid var(--B) }
[data-theme="pro"] .stc.r { border-top: 3px solid var(--P) }

[data-theme="glass"] .stc {
  border: 1px solid var(--bdr);
  backdrop-filter: blur(28px) saturate(180%);
  -webkit-backdrop-filter: blur(28px) saturate(180%);
  box-shadow: var(--sha);
}
[data-theme="glass"] .stc:nth-child(1) { background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.24) }
[data-theme="glass"] .stc.g { background: rgba(16,185,129,.09);  border-color: rgba(16,185,129,.24) }
[data-theme="glass"] .stc.b { background: rgba(6,182,212,.09);   border-color: rgba(6,182,212,.24) }
[data-theme="glass"] .stc.r { background: rgba(244,63,94,.09);   border-color: rgba(244,63,94,.24) }
[data-theme="ember"] .stc {
  border: 1px solid var(--bdr);
  backdrop-filter: blur(22px) saturate(150%);
  -webkit-backdrop-filter: blur(22px) saturate(150%);
  box-shadow: var(--sha);
}
[data-theme="ember"] .stc:nth-child(1) { background: rgba(249,115,22,.10); border-color: rgba(249,115,22,.24) }
[data-theme="ember"] .stc.g { background: rgba(34,197,94,.09);   border-color: rgba(34,197,94,.22) }
[data-theme="ember"] .stc.b { background: rgba(6,182,212,.09);   border-color: rgba(6,182,212,.22) }
[data-theme="ember"] .stc.r { background: rgba(239,68,68,.09);   border-color: rgba(239,68,68,.22) }
[data-theme="aurora"] .stc {
  border: 1px solid var(--bdr);
  backdrop-filter: blur(28px) saturate(180%);
  -webkit-backdrop-filter: blur(28px) saturate(180%);
  box-shadow: var(--sha);
}
[data-theme="aurora"] .stc:nth-child(1) { background: rgba(0,212,170,.10); border-color: rgba(0,212,170,.24) }
[data-theme="aurora"] .stc.g { background: rgba(0,240,160,.09);  border-color: rgba(0,240,160,.22) }
[data-theme="aurora"] .stc.b { background: rgba(0,191,255,.09);  border-color: rgba(0,191,255,.22) }
[data-theme="aurora"] .stc.r { background: rgba(255,77,106,.09); border-color: rgba(255,77,106,.22) }

/* glow orb */
.stc::before {
  content: '';
  position: absolute; bottom: -20px; left: -20px;
  width: 80px; height: 80px;
  border-radius: 50%;
  opacity: .12; filter: blur(30px);
  pointer-events: none;
}
.stc:nth-child(1)::before { background: var(--acc) }
.stc.g::before { background: var(--G) }
.stc.b::before { background: var(--B) }
.stc.r::before { background: var(--P) }

.stc-emoji {
  position: absolute; bottom: 12px; left: 16px;
  font-size: 32px; opacity: .10; pointer-events: none;
  filter: grayscale(.5);
}

.sv { font-size: 32px; font-weight: 900; line-height: 1; margin-bottom: 5px; letter-spacing: -1.5px; transition: transform .2s }
.stc:hover .sv { transform: scale(1.04) }
.sv span { font-size: 16px; font-weight: 600; opacity: .5 }
.sl { font-size: 11px; color: var(--txt3); font-weight: 700; text-transform: uppercase; letter-spacing: .4px }

[data-theme="pro"] .stc:nth-child(1) .sv { color: var(--acc) }
[data-theme="pro"] .stc.g .sv { color: var(--G) }
[data-theme="pro"] .stc.b .sv { color: var(--B) }
[data-theme="pro"] .stc.r .sv { color: var(--P) }
[data-theme="glass"] .sv { color: #FFFFFF }

/* ═══════════════════════════════════════════════ TABLE ═══ */
.tw { overflow-x: auto }
table { width: 100%; border-collapse: collapse }

thead { position: sticky; top: 0; z-index: 2 }
th {
  text-align: right; padding: 12px 16px;
  font-size: 10px; font-weight: 800;
  color: var(--txt3);
  background: var(--sur2);
  border-bottom: 1px solid var(--bdr);
  letter-spacing: 1px; text-transform: uppercase;
  white-space: nowrap;
}

td {
  padding: 14px 16px;
  border-bottom: 1px solid var(--bdr);
  font-size: 13px; font-weight: 500;
  vertical-align: middle;
  transition: background var(--td);
}
tbody tr:hover td { background: var(--acc-d) }
tr:last-child td { border-bottom: none }
[data-theme="glass"] tbody tr:nth-child(even) td { background: rgba(255,255,255,.016) }

/* ═══════════════════════════════════════════════ BADGES ═══ */
.pbw {
  display: inline-flex; align-items: center;
  padding: 3px 11px; border-radius: 7px;
  font-size: 12px; font-weight: 800;
}
.p-hi { background: var(--G-d);  color: var(--G) }
.p-mi { background: var(--Y-d);  color: var(--Y) }
.p-lo { background: var(--P-d);  color: var(--P) }
.p-ne { background: var(--P-d);  color: var(--P); opacity: .7 }

.bdg {
  display: inline-flex; align-items: center;
  padding: 3px 10px; border-radius: 7px;
  font-size: 11px; font-weight: 700;
}
.by { background: var(--Y-d); color: var(--Y) }
.bb { background: var(--acc-d); color: var(--acc) }

/* ═══════════════════════════════════════════════ PROGRESS ═══ */
.prw { display: flex; align-items: center; gap: 10px }
.prt { flex: 1; height: 6px; background: var(--sur3); border-radius: 99px; overflow: hidden }
.prf { height: 100%; border-radius: 99px; transition: width .7s cubic-bezier(.4,0,.2,1) }

/* ═══════════════════════════════════════════════ DOT ═══ */
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0 }

/* ═══════════════════════════════════════════════ EMPTY ═══ */
.empty { text-align: center; padding: 60px 20px; color: var(--txt3) }
.ei { font-size: 54px; margin-bottom: 16px; display: block; opacity: .55 }
.empty h3 { font-size: 17px; color: var(--txt2); margin-bottom: 8px; font-weight: 800 }
.empty p { font-size: 13px; color: var(--txt3) }

/* ═══════════════════════════════════════════════ PAGE HEADERS ═══ */
.sec { display: none }
.sec.active { display: block }

.phr {
  display: flex; align-items: center;
  justify-content: space-between;
  margin-bottom: 28px; gap: 14px;
}

.ptitle { font-size: 26px; font-weight: 900; letter-spacing: -1px; line-height: 1.1 }

.ptitle span {
  background: linear-gradient(90deg, var(--acc), var(--acc2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* ═══════════════════════════════════════════════ MODALS ═══ */
.ov {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.55);
  z-index: 500;
  display: flex; align-items: center; justify-content: center;
  animation: fi .16s ease; padding: 16px;
}
[data-theme="glass"] .ov { background: rgba(0,0,0,.72) }

.modal {
  background: var(--sur);
  border: 1px solid var(--bdr2);
  border-radius: calc(var(--r) + 4px);
  padding: 30px;
  width: 100%; max-width: 800px;
  max-height: 92vh; overflow-y: auto;
  animation: su .22s cubic-bezier(.34,1.3,.64,1);
  position: relative;
}

[data-theme="pro"] .modal { box-shadow: var(--sha-lg) }
[data-theme="glass"] .modal {
  backdrop-filter: blur(52px) saturate(200%);
  -webkit-backdrop-filter: blur(52px) saturate(200%);
  background: rgba(8,10,25,.90);
  box-shadow: 0 24px 80px rgba(0,0,0,.70), inset 0 1px 0 rgba(255,255,255,.09);
}
[data-theme="ember"] .modal {
  backdrop-filter: blur(48px) saturate(180%);
  -webkit-backdrop-filter: blur(48px) saturate(180%);
  background: rgba(18,12,10,.92);
  box-shadow: 0 24px 80px rgba(0,0,0,.75), inset 0 1px 0 rgba(255,120,60,.08);
}
[data-theme="aurora"] .modal {
  backdrop-filter: blur(52px) saturate(200%);
  -webkit-backdrop-filter: blur(52px) saturate(200%);
  background: rgba(5,12,20,.92);
  box-shadow: 0 24px 80px rgba(0,0,0,.70), inset 0 1px 0 rgba(0,240,160,.08);
}

/* corner glow on modal */
[data-theme="glass"] .modal::before {
  content: '';
  position: absolute; top: -1px; right: -1px;
  width: 140px; height: 140px;
  border-radius: 0 calc(var(--r)+4px) 0 0;
  background: radial-gradient(ellipse at top right, rgba(124,58,237,.28), transparent 65%);
  pointer-events: none;
}
[data-theme="ember"] .modal::before {
  content: '';
  position: absolute; top: -1px; right: -1px;
  width: 140px; height: 140px;
  border-radius: 0 calc(var(--r)+4px) 0 0;
  background: radial-gradient(ellipse at top right, rgba(249,115,22,.22), transparent 65%);
  pointer-events: none;
}
[data-theme="aurora"] .modal::before {
  content: '';
  position: absolute; top: -1px; right: -1px;
  width: 140px; height: 140px;
  border-radius: 0 calc(var(--r)+4px) 0 0;
  background: radial-gradient(ellipse at top right, rgba(0,212,170,.22), transparent 65%);
  pointer-events: none;
}

.msm { max-width: 500px }

.mhd {
  font-size: 18px; font-weight: 900;
  margin-bottom: 24px;
  display: flex; align-items: center; justify-content: space-between;
  padding-bottom: 18px;
  border-bottom: 1px solid var(--bdr);
  letter-spacing: -.4px; gap: 12px;
}

.mcl {
  width: 32px; height: 32px;
  background: var(--sur2);
  border: 1px solid var(--bdr);
  border-radius: var(--rs);
  color: var(--txt3);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700;
  transition: all var(--td);
  flex-shrink: 0;
}
.mcl:hover {
  background: var(--P-d); color: var(--P);
  border-color: rgba(244,63,94,.25);
  transform: scale(1.08);
}

/* ═══════════════════════════════════════════════ FORMS ═══ */
.fg { margin-bottom: 18px }

label {
  display: block;
  font-size: 10px; color: var(--txt3);
  margin-bottom: 6px; font-weight: 800;
  text-transform: uppercase; letter-spacing: .8px;
}

input, select, textarea {
  width: 100%;
  background: var(--sur2);
  border: 1px solid var(--bdr);
  border-radius: var(--rs);
  color: var(--txt);
  padding: 11px 14px;
  font-family: 'Vazirmatn', sans-serif;
  font-size: 13px; font-weight: 500;
  outline: none;
  transition: all var(--td);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--acc);
  box-shadow: 0 0 0 3px var(--acc-d);
  background: var(--sur);
}
input[type=number] { text-align: center }
input[type=number]::-webkit-inner-spin-button { display: none }
textarea { resize: vertical; min-height: 60px }

/* ═══════════════════════════════════════════════ SUBJECT CARDS ═══ */
.scard {
  background: var(--sur2);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 18px; margin-bottom: 14px;
  transition: all var(--td);
}
[data-theme="glass"] .scard { backdrop-filter: blur(12px) }

.shead {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px; padding-bottom: 12px;
  border-bottom: 1px solid var(--bdr);
}
.sname { font-size: 14px; font-weight: 800; letter-spacing: -.3px }
.crow { display: grid; grid-template-columns: 1fr 1fr 1fr 90px; gap: 10px; align-items: end }
.cl { display: flex; flex-direction: column; gap: 4px }
.cl label { font-size: 10px }

.pbox {
  border-radius: var(--rs);
  padding: 12px; text-align: center;
  position: relative; overflow: hidden;
}
[data-theme="pro"] .pbox { background: var(--sbg); border: 1px solid rgba(255,255,255,.06) }
[data-theme="glass"] .pbox { background: rgba(139,92,246,.12); border: 1px solid rgba(139,92,246,.2) }

.pbox .pv {
  font-size: 20px; font-weight: 900;
  background: linear-gradient(135deg, var(--acc), var(--acc2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -.5px;
}
.pbox .pl2 { font-size: 9px; color: var(--txt3); margin-top: 1px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px }

/* ═══════════════════════════════════════════════ TODO ═══ */
.tdl { margin-top: 10px }
.tdi {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 0; border-bottom: 1px solid var(--bdr);
  transition: background var(--td);
}
.tdi:last-child { border-bottom: none }
.tdcb { width: 16px; height: 16px; accent-color: var(--acc); cursor: pointer; flex-shrink: 0 }
.tdt { flex: 1; font-size: 13px; font-weight: 500 }
.tdt.dn { text-decoration: line-through; color: var(--txt3); font-weight: 400 }
.tddl {
  background: none; border: none; color: var(--txt3);
  cursor: pointer; font-size: 14px; padding: 3px 6px;
  border-radius: 6px; transition: all var(--td); opacity: .5;
}
.tddl:hover { opacity: 1; color: var(--P); background: var(--P-d) }
.tdadd { display: flex; gap: 8px; margin-top: 12px }
.tdadd input { font-size: 12px; padding: 8px 12px }
.nta { font-size: 12px; padding: 10px; min-height: 58px }
.coll { overflow: hidden; transition: max-height .35s ease; max-height: 0 }
.coll.open { max-height: 2500px }
.togbtn {
  background: transparent; border: 1px solid var(--bdr);
  border-radius: var(--rs); padding: 6px 14px;
  font-size: 11px; font-weight: 700; color: var(--txt3);
  cursor: pointer; font-family: 'Vazirmatn', sans-serif;
  margin-top: 12px; letter-spacing: .2px; transition: all var(--td);
}
.togbtn:hover { background: var(--acc-d); color: var(--acc); border-color: var(--acc) }

/* ═══════════════════════════════════════════════ DROPZONE ═══ */
.dropz {
  border: 2px dashed var(--bdr2); border-radius: var(--r);
  padding: 30px; text-align: center;
  cursor: pointer; background: var(--sur2);
  transition: all var(--td);
}
.dropz:hover, .dropz.over {
  border-color: var(--acc); background: var(--acc-d);
  box-shadow: 0 0 0 4px var(--acc-d);
}

/* ═══════════════════════════════════════════════ FULLSCREEN ═══ */
#fso {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.97);
  z-index: 9999; display: none;
  flex-direction: column; align-items: center; justify-content: center;
}
#fso-img {
  max-width: 95vw; max-height: 90vh;
  object-fit: contain; border-radius: 8px;
  user-select: none;
  box-shadow: 0 20px 80px rgba(0,0,0,.9);
}
#fso-close {
  position: fixed; top: 16px; right: 16px;
  background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.18);
  border-radius: 10px; color: #fff; width: 38px; height: 38px;
  font-size: 15px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(12px); transition: all .2s;
}
#fso-close:hover { background: rgba(244,63,94,.4); border-color: rgba(244,63,94,.5) }
#fso-prev, #fso-next {
  position: fixed; top: 50%; transform: translateY(-50%);
  background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.14);
  border-radius: 12px; color: #fff; width: 50px; height: 50px;
  font-size: 28px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  backdrop-filter: blur(12px); transition: all .2s;
}
#fso-prev { right: 16px }
#fso-next { left: 16px }
#fso-prev:hover, #fso-next:hover {
  background: rgba(255,255,255,.16);
  transform: translateY(calc(-50% - 2px));
}
#fso-count {
  position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
  color: rgba(255,255,255,.6); font-size: 12px;
  font-family: 'Vazirmatn', sans-serif; font-weight: 700;
  background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.12);
  padding: 5px 18px; border-radius: 20px; backdrop-filter: blur(12px);
}

/* ═══════════════════════════════════════════════ IMAGE GRID ═══ */
.img-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); gap: 10px; margin-top: 12px }
.img-thumb {
  position: relative; border: 1px solid var(--bdr);
  border-radius: var(--rs); aspect-ratio: 4/3; overflow: hidden;
  box-shadow: var(--sha-sm);
}
.img-thumb img { width: 100%; height: 100%; object-fit: cover; display: block }
.img-thumb .rm {
  position: absolute; top: 5px; left: 5px;
  background: rgba(244,63,94,.85); border: none; border-radius: 6px;
  color: #fff; width: 22px; height: 22px; cursor: pointer; font-size: 11px;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s;
}
.img-thumb .rm:hover { background: var(--P); transform: scale(1.1) }
.img-thumb .num {
  position: absolute; bottom: 5px; right: 5px;
  background: rgba(0,0,0,.65); color: #fff; font-size: 10px;
  padding: 1px 7px; border-radius: 10px; font-weight: 700;
}
.add-thumb {
  border: 1px dashed var(--bdr2); border-radius: var(--rs);
  aspect-ratio: 4/3;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer; color: var(--txt3); font-size: 12px; font-weight: 700; gap: 5px;
  transition: all var(--td);
}
.add-thumb:hover { border-color: var(--acc); background: var(--acc-d); color: var(--acc) }

/* ═══════════════════════════════════════════════ Q CARDS ═══ */
.qcard {
  background: var(--sur); border: 1px solid var(--bdr);
  border-radius: var(--r); overflow: hidden;
  cursor: pointer; transition: all var(--td);
  box-shadow: var(--sha-sm);
}
.qcard:hover { transform: translateY(-4px); box-shadow: var(--sha-md); border-color: var(--acc) }
[data-theme="glass"] .qcard { backdrop-filter: blur(20px) }
.qcard-img { width: 100%; height: 155px; object-fit: cover; display: block; border-bottom: 1px solid var(--bdr) }
.qcard-body { padding: 12px }
.rev-btn {
  background: var(--sur2); color: var(--txt3);
  border: 1px solid var(--bdr); border-radius: 7px;
  padding: 4px 12px; font-size: 11px; font-weight: 700;
  cursor: pointer; font-family: 'Vazirmatn', sans-serif;
  transition: all var(--td); white-space: nowrap;
}
.rev-btn.has { background: var(--acc-d); color: var(--acc); border-color: rgba(99,91,255,.3) }
.rev-btn:hover { background: var(--acc); color: #fff; border-color: var(--acc); transform: translateY(-1px) }

/* ═══════════════════════════════════════════════ THEME SWITCHER ═══ */
.theme-cards { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-top: 4px }

.theme-card {
  border: 1.5px solid var(--bdr);
  border-radius: var(--r);
  padding: 16px;
  cursor: pointer;
  transition: all var(--td);
  position: relative; overflow: hidden;
}
.theme-card:hover { border-color: var(--acc); transform: translateY(-2px); box-shadow: var(--sha-md) }
.theme-card.active {
  border-color: var(--acc);
  box-shadow: 0 0 0 3px var(--acc-d), var(--sha-md);
}
.theme-card.active::after {
  content: '✓';
  position: absolute; top: 10px; left: 10px;
  width: 22px; height: 22px;
  background: var(--acc);
  color: #fff; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 900; line-height: 22px; text-align: center;
}

/* Preview thumbnails */
.theme-preview {
  height: 75px; border-radius: 9px; margin-bottom: 12px;
  overflow: hidden; border: 1px solid var(--bdr);
  display: flex; gap: 0;
}

.tp-pro { background: #F0F2F8 }
.tp-glass {
  background: linear-gradient(135deg, #04050D 0%, #080A17 100%);
  position: relative;
}
.tp-glass::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at 20% 50%, rgba(124,58,237,.40) 0%, transparent 55%),
              radial-gradient(ellipse at 80% 20%, rgba(6,182,212,.28) 0%, transparent 50%);
}
.tp-ember {
  background: linear-gradient(135deg, #0C0A0A 0%, #120E0E 100%);
  position: relative;
}
.tp-ember::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at 30% 50%, rgba(249,115,22,.38) 0%, transparent 55%),
              radial-gradient(ellipse at 80% 80%, rgba(239,68,68,.25) 0%, transparent 50%);
}
.tp-aurora {
  background: linear-gradient(135deg, #050C12 0%, #07101A 100%);
  position: relative;
}
.tp-aurora::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at 20% 30%, rgba(0,212,170,.38) 0%, transparent 55%),
              radial-gradient(ellipse at 80% 70%, rgba(0,191,255,.25) 0%, transparent 50%);
}

.tp-sidebar {
  width: 22px; height: 100%; flex-shrink: 0;
  position: relative;
}
.tp-pro .tp-sidebar { background: #0F1629 }
.tp-glass .tp-sidebar {
  background: rgba(255,255,255,.035);
  border-left: 1px solid rgba(255,255,255,.07);
  z-index: 1;
}
.tp-ember .tp-sidebar {
  background: rgba(20,10,8,.95);
  border-left: 1px solid rgba(249,115,22,.10);
  z-index: 1;
}
.tp-aurora .tp-sidebar {
  background: rgba(0,12,20,.96);
  border-left: 1px solid rgba(0,212,170,.10);
  z-index: 1;
}

/* nav dots in preview */
.tp-sidebar::before {
  content: '';
  position: absolute;
  top: 8px; left: 50%; transform: translateX(-50%);
  width: 10px; height: 10px; border-radius: 2px;
}
.tp-pro .tp-sidebar::before { background: #4F46E5 }
.tp-glass .tp-sidebar::before { background: rgba(124,58,237,.65) }
.tp-ember .tp-sidebar::before { background: rgba(249,115,22,.65) }
.tp-aurora .tp-sidebar::before { background: rgba(0,212,170,.65) }

.tp-content { flex: 1; padding: 8px 7px; display: flex; flex-direction: column; gap: 5px; position: relative; z-index: 1 }
.tp-bar { height: 7px; border-radius: 4px }
.tp-pro .tp-bar:nth-child(1) { background: #4F46E5; width: 65% }
.tp-pro .tp-bar:nth-child(2) { background: #DDE3F5; width: 45% }
.tp-pro .tp-bar:nth-child(3) { background: #DDE3F5; width: 80% }
.tp-glass .tp-bar:nth-child(1) { background: linear-gradient(90deg, #7C3AED, #06B6D4); width: 65% }
.tp-glass .tp-bar:nth-child(2) { background: rgba(255,255,255,.11); width: 45% }
.tp-glass .tp-bar:nth-child(3) { background: rgba(255,255,255,.11); width: 80% }
.tp-ember .tp-bar:nth-child(1) { background: linear-gradient(90deg, #F97316, #EF4444); width: 65% }
.tp-ember .tp-bar:nth-child(2) { background: rgba(255,120,60,.15); width: 45% }
.tp-ember .tp-bar:nth-child(3) { background: rgba(255,120,60,.15); width: 80% }
.tp-aurora .tp-bar:nth-child(1) { background: linear-gradient(90deg, #00D4AA, #00BFFF); width: 65% }
.tp-aurora .tp-bar:nth-child(2) { background: rgba(0,200,160,.15); width: 45% }
.tp-aurora .tp-bar:nth-child(3) { background: rgba(0,200,160,.15); width: 80% }

/* stat row in preview */
.tp-stats { display: flex; gap: 4px; margin-top: 2px }
.tp-stat { flex: 1; height: 14px; border-radius: 3px }
.tp-pro .tp-stat:nth-child(1) { background: rgba(99,91,255,.15) }
.tp-pro .tp-stat:nth-child(2) { background: rgba(0,199,129,.15) }
.tp-pro .tp-stat:nth-child(3) { background: rgba(0,200,255,.15) }
.tp-glass .tp-stat:nth-child(1) { background: rgba(124,58,237,.28) }
.tp-glass .tp-stat:nth-child(2) { background: rgba(16,185,129,.22) }
.tp-glass .tp-stat:nth-child(3) { background: rgba(6,182,212,.22) }
.tp-ember .tp-stat:nth-child(1) { background: rgba(249,115,22,.28) }
.tp-ember .tp-stat:nth-child(2) { background: rgba(34,197,94,.20) }
.tp-ember .tp-stat:nth-child(3) { background: rgba(6,182,212,.18) }
.tp-aurora .tp-stat:nth-child(1) { background: rgba(0,212,170,.28) }
.tp-aurora .tp-stat:nth-child(2) { background: rgba(0,191,255,.22) }
.tp-aurora .tp-stat:nth-child(3) { background: rgba(191,95,255,.20) }

.theme-card-name { font-size: 14px; font-weight: 800; margin-bottom: 3px; letter-spacing: -.3px }
.theme-card-desc { font-size: 11px; color: var(--txt3); line-height: 1.4 }
.theme-card-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 700; padding: 2px 8px;
  border-radius: 5px; margin-top: 6px;
}
[data-theme="pro"] #tc-pro .theme-card-badge { background: var(--acc-d); color: var(--acc) }
[data-theme="glass"] #tc-glass .theme-card-badge { background: var(--acc-d); color: var(--acc) }
.theme-card-badge { background: var(--sur3); color: var(--txt3) }

/* ═══ RESULT SUBJ CARD TABS ══════════════════════════════════════ */
.res-tab-card {
  background: var(--sur);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  overflow: hidden;
  transition: all var(--td);
  box-shadow: var(--sha);
}
[data-theme="glass"] .res-tab-card { backdrop-filter: blur(20px) }

.res-tab-head {
  display: flex;
  border-bottom: 1px solid var(--bdr);
  background: var(--sur2);
}
.res-tab-btn {
  flex: 1;
  padding: 10px 6px;
  font-size: 11px;
  font-weight: 700;
  font-family: 'Vazirmatn', sans-serif;
  border: none;
  background: transparent;
  color: var(--txt3);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all var(--td);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  letter-spacing: .2px;
}
.res-tab-btn:hover { color: var(--txt); background: rgba(0,0,0,.03) }
.res-tab-btn.active {
  color: var(--acc);
  border-bottom-color: var(--acc);
  background: transparent;
}
[data-theme="glass"] .res-tab-btn.active {
  background: rgba(139,92,246,.08);
}

.res-tab-pane { display: none; padding: 16px }
.res-tab-pane.active { display: block }

.res-tab-subj-hd {
  display: flex;
  align-items: center;
  gap: 9px;
  padding: 13px 16px;
  background: var(--sur2);
  border-bottom: 1px solid var(--bdr);
}

/* ═══ INLINE Q GRID ════════════════════════════════════════════ */
.pb-q-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 8px;
  margin-top: 10px;
}
.pb-q-thumb {
  position: relative;
  border: 1px solid var(--bdr);
  border-radius: var(--rs);
  aspect-ratio: 1;
  overflow: hidden;
  cursor: pointer;
  transition: all var(--td);
}
.pb-q-thumb img { width:100%; height:100%; object-fit:cover; display:block }
.pb-q-thumb:hover { border-color: var(--acc); transform: scale(1.04) }
.pb-q-thumb .rm {
  position: absolute; top: 4px; left: 4px;
  background: rgba(244,63,94,.85); border: none; border-radius: 5px;
  color: #fff; width: 20px; height: 20px; cursor: pointer; font-size: 10px;
  display: flex; align-items: center; justify-content: center;
}
.pb-q-add-btn {
  aspect-ratio: 1;
  border: 1.5px dashed var(--bdr2);
  border-radius: var(--rs);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  cursor: pointer; color: var(--txt3);
  font-size: 11px; font-weight: 700;
  gap: 4px; transition: all var(--td);
  background: var(--sur2);
}
.pb-q-add-btn:hover { border-color: var(--acc); background: var(--acc-d); color: var(--acc) }
.pb-q-saved-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--sur2);
  border-radius: var(--rs);
  border: 1px solid var(--bdr);
  margin-bottom: 6px;
  cursor: pointer;
  transition: all var(--td);
}
.pb-q-saved-item:hover { border-color: var(--acc); background: var(--acc-d) }

/* ═══ IMPROVED GLOBAL UI ══════════════════════════════════════ */

/* Richer stat cards */
.stc {
  border-radius: var(--r);
  padding: 22px;
  position: relative; overflow: hidden;
  transition: all var(--td);
  cursor: default;
}
[data-theme="pro"] .stc {
  background: linear-gradient(145deg, var(--sur), var(--sur2));
  border: 1px solid var(--bdr);
  box-shadow: var(--sha);
}
[data-theme="pro"] .stc:hover { transform: translateY(-3px); box-shadow: var(--sha-md) }

/* Glowing border-top accent on stat cards */
[data-theme="pro"] .stc::before {
  content: '';
  position: absolute; top: 0; right: 0; left: 0; height: 3px;
  background: linear-gradient(90deg, var(--acc), var(--acc2));
  border-radius: var(--r) var(--r) 0 0;
}
[data-theme="pro"] .stc.g::before { background: linear-gradient(90deg, var(--G), #00e691) }
[data-theme="pro"] .stc.b::before { background: linear-gradient(90deg, var(--B), #00a8ff) }
[data-theme="pro"] .stc.r::before { background: linear-gradient(90deg, var(--P), #ff6b81) }

/* Better section headers */
.phr {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--bdr);
  flex-wrap: wrap; gap: 12px;
}

.ptitle {
  font-size: 22px;
  font-weight: 900;
  letter-spacing: -.6px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Better todo items */
.tdi {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px;
  border-radius: var(--rs);
  transition: background var(--td);
  margin-bottom: 3px;
}
.tdi:hover { background: var(--sur2) }

/* Better gz day cards */
.gz-day-card {
  background: var(--sur);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  overflow: hidden;
  margin-bottom: 12px;
  transition: all var(--td);
  box-shadow: var(--sha-sm);
}
.gz-day-card:hover { box-shadow: var(--sha); border-color: var(--bdr2) }

.gz-day-hd {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  cursor: pointer;
  user-select: none;
  transition: background var(--td);
  background: var(--sur);
}
.gz-day-hd:hover { background: var(--sur2) }

.gz-day-date {
  font-size: 14px; font-weight: 800; letter-spacing: -.3px;
}
.gz-day-meta {
  display: flex; align-items: center; gap: 10px;
  font-size: 12px; font-weight: 700; color: var(--txt2);
  flex-wrap: wrap;
}
.gz-day-body {
  padding: 16px 18px;
  border-top: 1px solid var(--bdr);
  background: var(--sur2);
  max-height: 0; overflow: hidden;
  transition: max-height .35s ease;
}
.gz-day-body.open { max-height: 1200px }

/* Better badge */
.bdg {
  display: inline-flex; align-items: center;
  font-size: 11px; font-weight: 700;
  padding: 3px 10px; border-radius: 7px;
  background: var(--sur3); color: var(--txt2);
  border: 1px solid var(--bdr);
}
.by { background: var(--Y-d); color: var(--Y); border-color: rgba(255,176,32,.2) }
.bb { background: var(--acc-d); color: var(--acc); border-color: rgba(99,91,255,.2) }

/* Nicer empty states */
.empty {
  text-align: center;
  padding: 48px 24px;
  color: var(--txt3);
}
.empty .ei { font-size: 48px; margin-bottom: 14px; line-height: 1 }
.empty h3 { font-size: 16px; font-weight: 800; color: var(--txt2); margin-bottom: 6px }
.empty p { font-size: 13px; line-height: 1.6 }

/* Better pbw percentage badges */
.pbw {
  display: inline-flex; align-items: center; justify-content: center;
  min-width: 64px; padding: 4px 12px;
  border-radius: 8px;
  font-size: 13px; font-weight: 900;
  letter-spacing: -.3px;
  border: 1px solid transparent;
}
.pc-g { background: var(--G-d); color: var(--G); border-color: rgba(0,199,129,.2) }
.pc-y { background: var(--Y-d); color: var(--Y); border-color: rgba(255,176,32,.2) }
.pc-r { background: var(--P-d); color: var(--P); border-color: rgba(255,71,87,.2) }
.pc-b { background: var(--acc-d); color: var(--acc); border-color: rgba(99,91,255,.2) }
.pc-0 { background: var(--sur3); color: var(--txt3); border-color: var(--bdr) }

/* Sidebar improvements */
.sidebar {
  width: 250px;
  background: var(--sbg);
  border-left: 1px solid var(--sbdr);
  display: flex; flex-direction: column;
  position: fixed; right: 0; top: 0; bottom: 0; z-index: 100;
  transition: background var(--td-slow), border-color var(--td-slow);
}
.main { margin-right: 250px }

/* Better nav items */
.ni {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 14px;
  border-radius: var(--rs);
  cursor: pointer;
  color: rgba(255,255,255,.45);
  font-size: 13px; font-weight: 600;
  margin-bottom: 3px;
  border: none; background: transparent;
  width: 100%; text-align: right;
  font-family: 'Vazirmatn', sans-serif;
  transition: all var(--td);
  position: relative;
}
.ni-icon {
  width: 30px; height: 30px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  transition: all var(--td);
  background: rgba(255,255,255,.06);
}

/* Input improvements */
input, select, textarea {
  width: 100%;
  background: var(--sur2);
  border: 1.5px solid var(--bdr);
  border-radius: var(--rs);
  color: var(--txt);
  padding: 11px 14px;
  font-family: 'Vazirmatn', sans-serif;
  font-size: 13px; font-weight: 500;
  outline: none;
  transition: all var(--td);
}
input:focus, select:focus, textarea:focus {
  border-color: var(--acc);
  box-shadow: 0 0 0 3px var(--acc-d);
  background: var(--sur);
}

/* Better card */
.card {
  background: var(--sur);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 22px;
  position: relative;
  transition: all var(--td);
}
[data-theme="pro"] .card { box-shadow: var(--sha-sm) }
[data-theme="glass"] .card {
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  box-shadow: var(--sha);
}
.card-hover:hover { transform: translateY(-3px); box-shadow: var(--sha-md) }

@media (max-width: 768px) {
  .sidebar { transform: translateX(100%); width: 250px }
  .main { margin-right: 0 }
  .g4 { grid-template-columns: 1fr 1fr }
  .g2 { grid-template-columns: 1fr }
  .crow { grid-template-columns: 1fr 1fr }
  .theme-cards { grid-template-columns: 1fr }
}
.td-standalone-badge {
  font-size:10px;font-weight:700;padding:2px 8px;border-radius:6px;
  background:var(--acc-d);color:var(--acc);
}
.btn-add-todo-subj {
  display:inline-flex;align-items:center;gap:5px;padding:5px 12px;
  background:var(--acc-d);color:var(--acc);border:1px solid rgba(99,91,255,.25);
  border-radius:var(--rs);font-size:11px;font-weight:700;cursor:pointer;
  font-family:'Vazirmatn',sans-serif;transition:all var(--td);
}
.btn-add-todo-subj:hover { background:var(--acc);color:#fff }

/* ═══ SCREENSHOT / DAILY REPORT ════════════════════════════════ */
.daily-report-card {
  background: var(--sur);
  border: 1px solid var(--bdr);
  border-radius: var(--r);
  padding: 28px;
  max-width: 600px;
  margin: 0 auto;
}
.daily-header {
  text-align:center;
  border-bottom:2px solid var(--acc);
  padding-bottom:18px;
  margin-bottom:22px;
}
.daily-header .app-name {
  font-size:13px;font-weight:800;color:var(--acc);letter-spacing:.5px;text-transform:uppercase;margin-bottom:6px;
}
.daily-header .daily-date {
  font-size:22px;font-weight:900;color:var(--txt);letter-spacing:-.5px;
}
.daily-stat-row {
  display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px;
}
.daily-stat-item {
  text-align:center;background:var(--sur2);border-radius:var(--rs);padding:12px 8px;border:1px solid var(--bdr);
}
.daily-stat-item .sv { font-size:22px;font-weight:900;color:var(--acc);line-height:1 }
.daily-stat-item .sl { font-size:10px;color:var(--txt3);font-weight:700;margin-top:4px;text-transform:uppercase;letter-spacing:.3px }
.daily-subj-list { display:flex;flex-direction:column;gap:8px;margin-bottom:16px }
.daily-subj-item {
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:var(--sur2);border-radius:var(--rs);border:1px solid var(--bdr);
}
.daily-note-box {
  background:var(--sur2);border-radius:var(--rs);padding:12px 14px;
  font-size:13px;color:var(--txt2);border:1px solid var(--bdr);line-height:1.6;
  margin-bottom:10px;
}
.daily-goal-box {
  background:var(--acc-d);border-radius:var(--rs);padding:12px 14px;
  font-size:13px;color:var(--acc);font-weight:700;border:1px solid rgba(99,91,255,.2);
}
.screenshot-overlay {
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9000;
  display:flex;align-items:center;justify-content:center;
  padding:16px;animation:fi .15s ease;
}
.screenshot-modal {
  background:var(--sur);border:1px solid var(--bdr2);border-radius:calc(var(--r)+4px);
  padding:28px;width:100%;max-width:640px;max-height:92vh;overflow-y:auto;
  animation:su .22s cubic-bezier(.34,1.3,.64,1);
}
[data-theme="glass"] .screenshot-modal {
  backdrop-filter:blur(48px);background:rgba(12,14,28,.92);
  box-shadow:0 24px 80px rgba(0,0,0,.7);
}

/* ═══ GZ ANALYTICS ══════════════════════════════════════════════ */
.gz-analytics-grid {
  display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px;
}
@media(max-width:600px){.gz-analytics-grid{grid-template-columns:1fr;}}
.gz-analytics-full {
  margin-bottom:18px;
}
.gz-heatmap {
  display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px;
}
.gz-heatmap-cell {
  aspect-ratio:1;border-radius:4px;background:var(--sur3);border:1px solid var(--bdr);
  display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;
  color:var(--txt3);cursor:default;position:relative;
  transition:transform .15s;
}
.gz-heatmap-cell:hover { transform:scale(1.15);z-index:2 }
.gz-heatmap-cell.h1 { background:rgba(99,91,255,.25);color:var(--acc);border-color:rgba(99,91,255,.3) }
.gz-heatmap-cell.h2 { background:rgba(99,91,255,.45);color:#fff;border-color:rgba(99,91,255,.5) }
.gz-heatmap-cell.h3 { background:rgba(99,91,255,.7);color:#fff;border-color:rgba(99,91,255,.75) }
.gz-heatmap-cell.h4 { background:var(--acc);color:#fff;box-shadow:0 2px 8px var(--acc-glow);border-color:var(--acc) }
.gz-heatmap-cell.future { opacity:.25;pointer-events:none }
.gz-heatmap-day-lbl { font-size:9px;color:var(--txt3);font-weight:800;text-align:center;padding:2px 0;letter-spacing:.3px }
.gz-week-bar-wrap { display:flex;align-items:flex-end;gap:6px;height:90px;margin-top:10px }
.gz-week-bar { flex:1;border-radius:5px 5px 0 0;position:relative;min-height:2px;cursor:default;transition:opacity .15s }
.gz-week-bar:hover { opacity:.8 }
.gz-week-bar-lbl { font-size:9px;color:var(--txt3);text-align:center;margin-top:4px;font-weight:700 }

/* ═══ PASAKHBARG SELECTED Qs ════════════════════════════════════ */
.pb-save-q-row {
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;background:var(--sur2);border-radius:var(--rs);
  border:1px solid var(--bdr);margin-bottom:8px;
}
.pb-save-q-badge {
  font-size:11px;padding:3px 10px;border-radius:7px;font-weight:700;
  background:var(--P-d);color:var(--P);
}

/* ═══ WEEKLY GOAL ═══════════════════════════════════════════ */
.wg-bar-track { height:10px;background:var(--sur3);border-radius:10px;overflow:hidden;margin:8px 0 4px }
.wg-bar-fill { height:100%;border-radius:10px;transition:width .6s cubic-bezier(.4,0,.2,1);background:linear-gradient(90deg,var(--acc),var(--acc2)) }
.wg-bar-fill.done { background:linear-gradient(90deg,var(--G),#00e5a0) }
.wg-bar-fill.over { background:linear-gradient(90deg,var(--Y),#ffcd3c) }

/* ═══ WEEK COMPARE ══════════════════════════════════════════ */
.wc-grid { display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px }
.wc-stat { background:var(--sur2);border:1px solid var(--bdr);border-radius:var(--rs);padding:12px;text-align:center }
.wc-val { font-size:22px;font-weight:900;color:var(--acc) }
.wc-lbl { font-size:10px;color:var(--txt3);font-weight:700;margin-top:2px }
.wc-diff { font-size:11px;font-weight:800;margin-top:4px }
.wc-diff.up { color:var(--G) }
.wc-diff.dn { color:var(--P) }
.wc-diff.eq { color:var(--txt3) }

/* ═══ JALALI CALENDAR ═══════════════════════════════════════ */
.jcal-grid { display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:8px }
.jcal-cell { aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;cursor:default;border:1px solid transparent;transition:transform .1s }
.jcal-cell.empty { background:transparent;border-color:transparent }
.jcal-cell.today { border-color:var(--acc);color:var(--acc) }
.jcal-cell.has-rec { background:var(--acc);color:#fff;cursor:pointer;box-shadow:0 2px 6px var(--acc-glow) }
.jcal-cell.has-rec:hover { transform:scale(1.1);z-index:2 }
.jcal-cell.no-rec { background:var(--sur3);color:var(--txt3) }
.jcal-cell.future { opacity:.3;pointer-events:none }
.jcal-day-hdr { font-size:9px;color:var(--txt3);font-weight:800;text-align:center;padding:3px 0 }
.jcal-nav { display:flex;align-items:center;justify-content:space-between;margin-bottom:4px }
.jcal-nav-btn { background:var(--sur2);border:1px solid var(--bdr);border-radius:var(--rs);
  padding:4px 12px;font-size:12px;cursor:pointer;color:var(--txt);font-family:Vazirmatn,sans-serif;
  transition:background .15s }
.jcal-nav-btn:hover { background:var(--acc-d);color:var(--acc) }
.jcal-title { font-size:13px;font-weight:800;color:var(--txt) }

/* ═══ WEEKLY PLAN ════════════════════════════════════════════ */
.wplan-grid { display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px }
.wplan-day { background:var(--sur2);border:1px solid var(--bdr);border-radius:var(--rs);padding:8px 6px;min-height:80px }
.wplan-day.today { border-color:var(--acc);background:var(--acc-d) }
.wplan-day-name { font-size:10px;font-weight:800;color:var(--txt3);text-align:center;margin-bottom:6px }
.wplan-day.today .wplan-day-name { color:var(--acc) }
.wplan-item { font-size:10px;background:var(--sur);border:1px solid var(--bdr);border-radius:5px;
  padding:3px 6px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;gap:4px }
.wplan-item-del { background:none;border:none;color:var(--txt3);cursor:pointer;font-size:11px;padding:0;line-height:1 }
.wplan-item-del:hover { color:var(--P) }
.wplan-add-inp { width:100%;font-size:10px;padding:3px 5px;border-radius:4px;border:1px solid var(--bdr);
  background:var(--sur);color:var(--txt);font-family:Vazirmatn,sans-serif;margin-top:2px;box-sizing:border-box }
@media(max-width:700px){
  .wplan-grid{grid-template-columns:repeat(4,1fr)}
}
@media(max-width:480px){
  .wplan-grid{grid-template-columns:repeat(2,1fr)}
}

/* ═══ PWA INSTALL GUIDE ══════════════════════════════════════ */
.pwa-guide-step { display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--bdr) }
.pwa-guide-step:last-child { border-bottom:none }
.pwa-guide-num { min-width:24px;height:24px;background:var(--acc);color:#fff;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900 }
.pwa-guide-txt { font-size:12px;color:var(--txt2);line-height:1.5 }

/* ═══════════════════════════════════════════════ ANIMATIONS ═══ */
@keyframes fi { from { opacity: 0 } to { opacity: 1 } }
@keyframes su { from { transform: translateY(22px) scale(.97); opacity: 0 } to { transform: none; opacity: 1 } }

/* ═══════════════════════════════════════════════ RESPONSIVE ═══ */
@media (max-width: 768px) {
  .sidebar { transform: translateX(100%) }
  .main { margin-right: 0 }
  .g4 { grid-template-columns: 1fr 1fr }
  .g2 { grid-template-columns: 1fr }
  .crow { grid-template-columns: 1fr 1fr }
  .theme-cards { grid-template-columns: 1fr }
}

/* ═══════════════════════════════════════════════ PASAKHBARG ═══ */

/* Timer bar */
.pb-timer-wrap {
  display: flex; align-items: center; gap: 16px;
  background: var(--sur); border: 1px solid var(--bdr);
  border-radius: var(--r); padding: 14px 20px;
  margin-bottom: 22px; box-shadow: var(--sha);
  position: sticky; top: 0; z-index: 10;
  transition: background var(--td), border-color var(--td);
  flex-wrap: wrap;
}
[data-theme="glass"] .pb-timer-wrap { backdrop-filter: blur(20px) }
.pb-timer-section { display: flex; flex-direction: column; gap: 3px }
.pb-timer-lbl { font-size: 10px; color: var(--txt3); font-weight: 800; text-transform: uppercase; letter-spacing: .5px }
.pb-timer-display {
  font-size: 30px; font-weight: 900; letter-spacing: -1px;
  line-height: 1; color: var(--txt); transition: color .3s;
  font-variant-numeric: tabular-nums;
}
.pb-timer-display.warning { color: var(--Y) }
.pb-timer-display.danger  { color: var(--P); animation: pb-pulse .7s infinite }
.pb-timer-bar-track { flex: 1; height: 8px; background: var(--sur3); border-radius: 99px; overflow: hidden; min-width: 100px }
.pb-timer-bar-fill  { height: 100%; border-radius: 99px; background: linear-gradient(90deg, var(--G), var(--acc)); transition: width 1s linear, background .5s }
.pb-live-info { font-size: 22px; font-weight: 900; color: var(--acc); letter-spacing: -1px }

/* Answer circles */
.pb-circle {
  width: 36px; height: 36px; border-radius: 50%;
  border: 2px solid var(--bdr2);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 800;
  cursor: pointer; transition: all .15s;
  color: var(--txt3); background: var(--sur2);
  flex-shrink: 0; user-select: none;
}
.pb-circle:hover { border-color: var(--acc); color: var(--acc); transform: scale(1.12) }
.pb-circle.sel {
  background: var(--acc); border-color: var(--acc);
  color: #fff; box-shadow: 0 2px 12px var(--acc-glow);
  transform: scale(1.1);
}
/* result states */
.pb-circle.res-correct { background: var(--G) !important; border-color: var(--G) !important; color: #fff !important; transform: scale(1.05) }
.pb-circle.res-wrong   { background: var(--P) !important; border-color: var(--P) !important; color: #fff !important }
.pb-circle.res-key     { background: transparent !important; border: 2.5px solid var(--G) !important; color: var(--G) !important; font-weight: 900 }
.pb-circle.res-late-sel { background: rgba(120,120,120,.35) !important; border-color: #777 !important; color: #ccc !important }
.pb-circle.res-late-key { background: transparent !important; border: 2.5px dashed #777 !important; color: #888 !important }
.pb-circle.res-blank   { opacity: .25 }

/* Question row */
.pb-qrow {
  display: flex; align-items: center; gap: 12px;
  padding: 9px 14px; border-radius: var(--rs);
  border: 1px solid var(--bdr); margin-bottom: 7px;
  background: var(--sur); transition: all .15s;
}
[data-theme="glass"] .pb-qrow { backdrop-filter: blur(8px) }
.pb-qrow:not(.no-hover):hover { background: var(--acc-d); border-color: var(--acc) }
.pb-qrow.answered { border-color: var(--acc); background: var(--acc-d) }
.pb-qrow.answered-late { border-style: dashed; border-color: #777; background: rgba(120,120,120,.06); opacity: .8 }
/* result rows */
.pb-qrow.res-correct  { border-color: var(--G); background: var(--G-d) }
.pb-qrow.res-wrong    { border-color: var(--P); background: var(--P-d) }
.pb-qrow.res-unanswered { border-color: var(--Y); background: var(--Y-d) }
.pb-qrow.res-late     { border-color: #666; border-style: dashed; background: rgba(100,100,100,.07); opacity: .8 }

.pb-qnum { font-size: 12px; font-weight: 800; color: var(--txt3); min-width: 54px; text-align: right; flex-shrink: 0 }
.pb-circles { display: flex; gap: 8px; align-items: center }

/* Subject header in answer sheet */
.pb-subj-hd {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 16px; margin-bottom: 10px; margin-top: 20px;
  border-radius: var(--rs); font-size: 14px; font-weight: 800;
}
.pb-subj-hd:first-child { margin-top: 0 }

/* Setup table */
.pb-setup-tbl { width: 100%; border-collapse: collapse; margin-bottom: 4px }
.pb-setup-tbl th {
  font-size: 10px; color: var(--txt3); font-weight: 800;
  text-transform: uppercase; letter-spacing: .8px;
  padding: 10px 14px; background: var(--sur2);
  border-bottom: 1px solid var(--bdr); text-align: right;
  white-space: nowrap;
}
.pb-setup-tbl td { padding: 10px 14px; border-bottom: 1px solid var(--bdr); vertical-align: middle }
.pb-setup-tbl tr:last-child td { border-bottom: none }
.pb-setup-tbl tbody tr:hover td { background: var(--acc-d) }
.pb-ni  { font-size: 12px; padding: 5px 9px; border-radius: 7px; width: auto; display: inline }
.pb-nf  { width: 68px; font-size: 12px; padding: 5px 8px; border-radius: 7px; text-align: center; display: inline }

/* Key entry grid */
.pb-key-grid  { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 8px }
.pb-key-row   {
  display: flex; align-items: center; gap: 7px;
  background: var(--sur2); border: 1px solid var(--bdr);
  border-radius: var(--rs); padding: 7px 12px;
}
.pb-key-num   { font-size: 12px; font-weight: 800; color: var(--txt3); min-width: 48px; flex-shrink: 0 }
.pb-key-circ  {
  width: 30px; height: 30px; border-radius: 50%;
  border: 2px solid var(--bdr2);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; cursor: pointer;
  color: var(--txt3); background: var(--sur);
  transition: all .13s; flex-shrink: 0;
}
.pb-key-circ:hover { border-color: var(--G); color: var(--G); transform: scale(1.1) }
.pb-key-circ.sel   { background: var(--G); border-color: var(--G); color: #fff }

/* Stats row */
.pb-stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 18px }
.pb-stat-box  { border-radius: var(--rs); padding: 16px; text-align: center; border: 1px solid var(--bdr) }
.pb-stat-val  { font-size: 26px; font-weight: 900; letter-spacing: -1px; line-height: 1 }
.pb-stat-lbl  { font-size: 10px; color: var(--txt3); font-weight: 700; text-transform: uppercase; margin-top: 4px; letter-spacing: .4px }

/* Late badge */
.pb-late-badge {
  font-size: 10px; padding: 2px 7px; border-radius: 5px;
  background: rgba(120,120,120,.18); color: #888;
  font-weight: 700; white-space: nowrap; flex-shrink: 0;
}

/* Time-up overlay */
.pb-timeup-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 800; display: flex; align-items: center; justify-content: center;
  animation: fi .2s ease;
}
.pb-timeup-box {
  background: var(--sur); border: 2px solid var(--P);
  border-radius: calc(var(--r) + 4px);
  padding: 36px 44px; text-align: center;
  box-shadow: var(--sha-lg);
  animation: su .25s cubic-bezier(.34,1.3,.64,1);
  max-width: 400px; width: 90%;
}

@keyframes pb-pulse { 0%,100%{opacity:1} 50%{opacity:.35} }

/* ═══ QUESTION FLAGS (وقت‌گیر / شک‌دار) ═══ */
.pb-flags {
  display: flex; gap: 5px; flex-wrap: wrap; align-items: center;
  margin-right: 6px;
}
.pb-flag-btn {
  font-size: 10px; font-weight: 700; padding: 3px 8px;
  border-radius: 6px; border: 1.5px solid var(--bdr2);
  cursor: pointer; background: var(--sur2); color: var(--txt3);
  font-family: 'Vazirmatn', sans-serif; transition: all .15s;
  white-space: nowrap; line-height: 1.2;
}
.pb-flag-btn:hover { border-color: var(--acc); color: var(--acc); background: var(--acc-d); }
.pb-flag-btn.flag-time.active { background: var(--Y-d); border-color: var(--Y); color: var(--Y); }
.pb-flag-btn.flag-doubt.active { background: rgba(168,85,247,.18); border-color: var(--V); color: var(--V); }
.pb-doubt-opts {
  display: none; gap: 4px; align-items: center; flex-wrap: wrap; margin-top: 4px; margin-right: 50px;
}
.pb-doubt-opts.show { display: flex; }
.pb-doubt-opt {
  width: 26px; height: 26px; border-radius: 50%;
  border: 1.5px solid var(--bdr2); background: var(--sur2); color: var(--txt3);
  font-size: 11px; font-weight: 800; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .13s; font-family: 'Vazirmatn', sans-serif;
}
.pb-doubt-opt:hover { border-color: var(--V); color: var(--V); }
.pb-doubt-opt.sel { background: var(--V); border-color: var(--V); color: #fff; }
.pb-qrow-wrap { margin-bottom: 2px; }

/* key view — late questions correct/wrong shown */
.res-late-correct { background: rgba(0,199,129,.15); border-color: var(--G); color: var(--G); }
.res-late-wrong   { background: rgba(255,71,87,.15);  border-color: var(--P); color: var(--P); }
.res-late-key-mark { background: transparent; border-color: var(--G); color: var(--G); }

/* Spider chart section */
/* ═══ GOZARESH KAR ═══ */
.gz-day-card { background:var(--sur); border:1px solid var(--bdr); border-radius:var(--r); overflow:hidden; margin-bottom:14px; box-shadow:var(--sha-sm); }
.gz-day-hd { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--bdr); cursor:pointer; gap:10px; flex-wrap:wrap; transition:background var(--td); }
.gz-day-hd:hover { background:var(--sur2); }
.gz-day-date { font-size:15px; font-weight:900; letter-spacing:-.4px; }
.gz-day-meta { font-size:11px; color:var(--txt3); font-weight:600; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.gz-day-body { padding:16px 18px; display:none; }
.gz-day-body.open { display:block; }
.gz-subj-row { display:grid; grid-template-columns:120px 65px 65px 80px 1fr; gap:8px; align-items:center; padding:8px 0; border-bottom:1px solid var(--bdr); }
.gz-subj-row:last-child { border-bottom:none; }
.gz-subj-name { font-size:12px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.gz-inp-lbl { font-size:9px; color:var(--txt3); font-weight:700; text-transform:uppercase; letter-spacing:.5px; display:block; margin-bottom:2px; }
.gz-inp { width:100%; background:var(--sur2); border:1px solid var(--bdr); border-radius:var(--rs); color:var(--txt); padding:6px 9px; font-family:'Vazirmatn',sans-serif; font-size:12px; font-weight:600; outline:none; transition:all var(--td); }
.gz-inp:focus { border-color:var(--acc); box-shadow:0 0 0 3px var(--acc-d); }
.gz-inp[type=number] { text-align:center; }
.gz-inp[type=number]::-webkit-inner-spin-button { display:none; }
.gz-mood-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.gz-mb { width:34px; height:34px; border-radius:50%; border:2px solid var(--bdr2); background:var(--sur2); cursor:pointer; font-size:17px; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.gz-mb:hover { transform:scale(1.15); border-color:var(--acc); }
.gz-mb.sel { border-color:var(--acc); background:var(--acc-d); transform:scale(1.1); }
@media (max-width:640px) { .gz-subj-row { grid-template-columns:1fr 1fr; } }
</style>
</head>
<body>
<!-- Ambient Orbs -->
<div class="ambient-orb ambient-orb-1"></div>
<div class="ambient-orb ambient-orb-2"></div>
<div class="ambient-orb ambient-orb-3"></div>

<div class="app">

<!-- ══════════════════════ SIDEBAR ══════════════════════ -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-inner">
      <div class="logo-icon">⚡</div>
      <div class="logo-text">
        <h1>آزمونِتو</h1>
        <p>پیگیری درصد کنکور</p>
      </div>
    </div>
  </div>
  <nav class="nav">
    <div class="nav-label">اصلی</div>
    <button class="ni active" onclick="go('dashboard')"><div class="ni-icon">🏠</div>داشبورد</button>
    <button class="ni" onclick="go('exams')"><div class="ni-icon">📝</div>آزمون‌ها</button>
    <button class="ni" onclick="go('charts')"><div class="ni-icon">📈</div>نمودارها</button>
    <button class="ni" onclick="go('subjects')"><div class="ni-icon">📚</div>تحلیل دروس</button>
    <div class="nav-label">ابزار</div>
    <button class="ni" onclick="go('todos')"><div class="ni-icon">✅</div>وظایف</button>
    <button class="ni" onclick="go('notes')"><div class="ni-icon">📓</div>یادداشت‌ها</button>
    <button class="ni" onclick="go('gozaresh')"><div class="ni-icon">📊</div>گزارش کار</button>
    <button class="ni" onclick="go('questions')"><div class="ni-icon">🖼️</div>سوالات منتخب</button>
    <button class="ni" onclick="go('pasakhbarg')"><div class="ni-icon">📋</div>پاسخبرگ</button>
    <div class="nav-label">سیستم</div>
    <button class="ni" onclick="go('settings')"><div class="ni-icon">⚙️</div>تنظیمات</button>
  </nav>
  <div class="sbfoot">
    <div class="msbox">
      <div class="mn" id="sb-n">۰</div>
      <div class="ml">آزمون ثبت‌شده</div>
    </div>
    <button id="pwa-install-btn" onclick="installPWA()" style="display:none;width:100%;margin-top:10px;background:var(--acc);color:#fff;border:none;border-radius:var(--rs);padding:9px;font-family:Vazirmatn,sans-serif;font-size:12px;font-weight:700;cursor:pointer;letter-spacing:.3px;box-shadow:var(--sha-acc)">⬇️ نصب آزمونیتو</button>
    <div id="pwa-installed-msg" style="display:none;margin-top:8px;text-align:center;font-size:10px;color:var(--G);font-weight:700">✓ اپ نصب شد</div>
  </div>
</aside>

<!-- ══════════════════════ MAIN ══════════════════════ -->
<main class="main">

<!-- DASHBOARD -->
<section class="sec active" id="sec-dashboard">
  <div class="phr">
    <div class="ptitle">داشبورد <span>کنکور</span></div>
    <button class="btn bp" onclick="openAdd()">+ افزودن آزمون</button>
  </div>
  <div class="g4" style="margin-bottom:20px">
    <div class="stc"><div class="stc-emoji">📊</div><div class="sv" id="d-total">۰</div><div class="sl">آزمون ثبت‌شده</div></div>
    <div class="stc g"><div class="stc-emoji">🏆</div><div class="sv" id="d-best">—</div><div class="sl">بهترین درصد کل</div></div>
    <div class="stc b"><div class="stc-emoji">📈</div><div class="sv" id="d-avg">—</div><div class="sl">میانگین درصد کل</div></div>
    <div class="stc r"><div class="stc-emoji">⚠️</div><div class="sv" id="d-weak" style="font-size:18px">—</div><div class="sl">ضعیف‌ترین درس</div></div>
  </div>
  <div class="g2" style="margin-bottom:18px">
    <div class="card"><div class="ct"><span class="ct-dot"></span>آخرین آزمون</div><div id="d-last"></div></div>
    <div class="card"><div class="ct"><span class="ct-dot" style="background:var(--G)"></span>درصد دروس — آخرین آزمون</div><div id="d-bars"></div></div>
  </div>
  <div class="card"><div class="ct"><span class="ct-dot" style="background:var(--B)"></span>روند درصد کل — ۶ آزمون اخیر</div><canvas id="c-mini" height="130"></canvas></div>
</section>

<!-- EXAMS -->
<section class="sec" id="sec-exams">
  <div class="phr">
    <div class="ptitle">📝 <span>آزمون‌ها</span></div>
    <button class="btn bp" onclick="openAdd()">+ افزودن آزمون</button>
  </div>
  <div class="card">
    <div class="tw">
      <table>
        <thead id="et-head"><tr><th>تاریخ</th><th>نام آزمون</th><th>درصد کل</th><th>دروس</th><th>TODO</th><th>عملیات</th></tr></thead>
        <tbody id="et-body"></tbody>
      </table>
    </div>
    <div id="et-empty" class="empty" style="display:none">
      <div class="ei">📝</div><h3>هنوز آزمونی ثبت نشده</h3>
      <p style="margin-bottom:16px">اولین آزمونت را ثبت کن</p>
      <button class="btn bp" onclick="openAdd()">+ افزودن آزمون</button>
    </div>
  </div>
</section>

<!-- CHARTS -->
<section class="sec" id="sec-charts">
  <div class="phr"><div class="ptitle">📈 <span>نمودارها</span></div></div>
  <div class="card" style="margin-bottom:18px">
    <div class="ct"><span class="ct-dot"></span>درصد کل در همه آزمون‌ها</div>
    <canvas id="c-total" height="190"></canvas>
  </div>
  <div class="card" style="margin-bottom:18px">
    <div class="ct"><span class="ct-dot" style="background:var(--G)"></span>
      پیشرفت درس:
      <select id="subj-sel" onchange="drawSubjChart()" style="width:auto;display:inline-block;margin-right:8px;padding:5px 10px;font-size:12px;border-radius:7px"></select>
    </div>
    <canvas id="c-subj" height="190"></canvas>
  </div>
  <div class="card" id="c-spider-card">
    <div class="ct"><span class="ct-dot" style="background:var(--V)"></span>نمودار عنکبوتی — میانگین درصد دروس (همه آزمون‌ها)</div>
    <div id="c-spider-empty" class="empty" style="display:none;padding:32px 0">
      <div class="ei" style="font-size:36px">🕸️</div>
      <h3>داده کافی نیست</h3>
      <p>برای نمایش نمودار عنکبوتی حداقل ۳ درس با داده لازم است</p>
    </div>
    <canvas id="c-spider" width="500" height="420" style="display:block;margin:0 auto"></canvas>
  </div>
</section>

<!-- SUBJECTS -->
<section class="sec" id="sec-subjects">
  <div class="phr"><div class="ptitle">📚 تحلیل <span>دروس</span></div></div>
  <div id="subj-wrap"></div>
</section>

<!-- TODOS -->
<section class="sec" id="sec-todos">
  <div class="phr">
    <div class="ptitle">✅ <span>وظایف</span></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn bp bsm" onclick="openAddStandaloneTodo()">+ وظیفه جدید</button>
      <select id="td-subj-filter" onchange="renderTodos()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
        <option value="all">همه دروس</option>
      </select>
      <select id="td-filter" onchange="renderTodos()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
        <option value="all">همه</option>
        <option value="pending">باقی‌مانده</option>
        <option value="done">انجام‌شده</option>
      </select>
    </div>
  </div>
  <div id="td-stats" style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap"></div>
  <div id="td-wrap"></div>
</section>

<!-- STANDALONE TODO MODAL -->
<div class="ov" id="m-standalone-todo" style="display:none" onclick="if(event.target===this)closeM('m-standalone-todo')">
  <div class="modal msm">
    <div class="mhd"><span>➕ افزودن وظیفه جدید</span><button class="mcl" onclick="closeM('m-standalone-todo')">✕</button></div>
    <div class="fg">
      <label>درس</label>
      <select id="std-todo-subj"></select>
    </div>
    <div class="fg">
      <label>متن وظیفه</label>
      <input type="text" id="std-todo-text" placeholder="مثلاً: حل تمرین‌های فصل ۵..." onkeydown="if(event.key==='Enter')saveStandaloneTodo()">
    </div>
    <div class="fg">
      <label>اولویت</label>
      <select id="std-todo-priority">
        <option value="normal">معمولی</option>
        <option value="high">مهم 🔴</option>
        <option value="low">کم‌اهمیت ⬇️</option>
      </select>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:4px">
      <button class="btn bg" onclick="closeM('m-standalone-todo')">انصراف</button>
      <button class="btn bp" onclick="saveStandaloneTodo()">💾 ذخیره</button>
    </div>
  </div>
</div>

<!-- NOTES -->
<section class="sec" id="sec-notes">
  <div class="phr"><div class="ptitle">📓 <span>یادداشت‌ها</span></div></div>
  <div style="display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap">
    <select id="notes-subj-filter" onchange="renderNotes()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="all">همه دروس</option>
    </select>
  </div>
  <div id="notes-wrap"></div>
</section>

<!-- GOZARESH KAR -->
<section class="sec" id="sec-gozaresh">
  <div class="phr">
    <div class="ptitle">📊 <span>گزارش کار</span></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn bg bsm" onclick="openGzSubjMgr()">⚙️ درس‌های گزارش کار</button>
      <button class="btn bg bsm" onclick="openDailyReport()">📸 گزارش روزانه</button>
      <button class="btn bp" onclick="gzOpenAdd()">+ ثبت روز جدید</button>
    </div>
  </div>
  <!-- TODAY QUICK ENTRY PANEL -->
  <div class="card" id="gz-today-panel" style="margin-bottom:20px;border-right:4px solid var(--acc)">
    <div class="ct" style="justify-content:space-between;margin-bottom:10px">
      <span><span class="ct-dot"></span>📅 گزارش امروز — <span id="gz-today-date" style="color:var(--acc);font-size:12px"></span></span>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="gz-back-today-btn" onclick="gzTodayInit()" style="display:none;font-size:10px;font-weight:700;color:var(--acc);padding:2px 8px;background:var(--acc-d);border:none;border-radius:7px;cursor:pointer">← بازگشت به امروز</button>
        <span id="gz-today-saved-badge" style="display:none;font-size:10px;font-weight:700;color:var(--G);padding:2px 8px;background:var(--G-d);border-radius:7px">✓ ذخیره‌شده</span>
        <button class="btn bp bsm" id="gz-today-save-btn" onclick="gzTodaySave()" style="font-size:11px">💾 ذخیره امروز</button>
      </div>
    </div>
    <!-- mood -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
      <span style="font-size:11px;color:var(--txt3);font-weight:700">حال امروز:</span>
      <div class="gz-mood-row" id="gz-today-moodrow">
        <button class="gz-mb" data-v="5" onclick="gzTodayMood(5)">🔥</button>
        <button class="gz-mb" data-v="4" onclick="gzTodayMood(4)">😊</button>
        <button class="gz-mb" data-v="3" onclick="gzTodayMood(3)">😐</button>
        <button class="gz-mb" data-v="2" onclick="gzTodayMood(2)">😴</button>
        <button class="gz-mb" data-v="1" onclick="gzTodayMood(1)">😓</button>
      </div>
    </div>
    <!-- subject rows -->
    <div class="card" style="padding:0;overflow:hidden;margin-bottom:10px">
      <div style="display:grid;grid-template-columns:120px 65px 65px 80px 1fr;gap:8px;padding:8px 14px;background:var(--sur2);border-bottom:1px solid var(--bdr)">
        <span style="font-size:10px;font-weight:800;color:var(--txt3)">درس</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3)">⏱ ساعت</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3)">🕐 دقیقه</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3)">📝 تست</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3)">✏️ فعالیت</span>
      </div>
      <div id="gz-today-rows" style="padding:4px 14px 10px"></div>
    </div>
    <!-- note and goal -->
    <div class="g2" style="gap:10px">
      <div class="fg" style="margin-bottom:0">
        <label>📝 یادداشت</label>
        <textarea id="gz-today-note" class="nta" placeholder="امروز چه کردی؟..." style="min-height:52px"></textarea>
      </div>
      <div class="fg" style="margin-bottom:0">
        <label>🎯 هدف فردا</label>
        <input type="text" id="gz-today-goal" placeholder="فردا چیکار می‌کنی؟">
      </div>
    </div>
  </div>

  <!-- ── هدف هفتگی ── -->
  <div class="card" id="gz-weekly-goal-card" style="margin-bottom:20px;border-right:4px solid var(--Y)">
    <div class="ct" style="justify-content:space-between;margin-bottom:10px">
      <span><span class="ct-dot" style="background:var(--Y)"></span>🎯 هدف هفتگی مطالعه</span>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="gz-wg-done-lbl" style="font-size:11px;color:var(--txt3)">این هفته: <b id="gz-wg-done" style="color:var(--acc)">۰</b> ساعت</span>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:200px">
        <div class="wg-bar-track"><div class="wg-bar-fill" id="gz-wg-bar" style="width:0%"></div></div>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--txt3)">
          <span id="gz-wg-pct">۰٪ انجام‌شده</span>
          <span>هدف: <b id="gz-wg-target-lbl" style="color:var(--Y)">۳۵</b> ساعت</span>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <label style="font-size:11px;color:var(--txt3);white-space:nowrap">هدف هفتگی:</label>
        <input type="number" id="gz-wg-inp" min="1" max="100" step="1" value="35"
          style="width:64px;font-size:13px;font-weight:800;padding:5px 8px;border-radius:var(--rs)"
          oninput="gzWgSave()" placeholder="ساعت">
        <span style="font-size:11px;color:var(--txt3)">ساعت</span>
      </div>
    </div>
  </div>

    <div class="g4" style="margin-bottom:20px">
    <div class="stc"><div class="stc-emoji">📅</div><div class="sv" id="gz-days">۰</div><div class="sl">روز ثبت‌شده</div></div>
    <div class="stc g"><div class="stc-emoji">⏱️</div><div class="sv" id="gz-hours">۰</div><div class="sl">کل ساعت مطالعه</div></div>
    <div class="stc b"><div class="stc-emoji">📝</div><div class="sv" id="gz-tests">۰</div><div class="sl">کل تست زده‌شده</div></div>
    <div class="stc r"><div class="stc-emoji">🔥</div><div class="sv" id="gz-streak" style="font-size:20px">۰ روز</div><div class="sl">streak فعلی</div></div>
  </div>
  <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap">
    <select id="gz-range" onchange="renderGz()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="7">۷ روز اخیر</option>
      <option value="14">۱۴ روز اخیر</option>
      <option value="30" selected>۳۰ روز اخیر</option>
      <option value="90">۳ ماه اخیر</option>
      <option value="0">همه</option>
    </select>
    <select id="gz-fsubj" onchange="renderGz()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="all">همه دروس</option>
    </select>
    <select id="gz-fsort" onchange="renderGz()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="new">جدیدترین اول</option>
      <option value="old">قدیمی‌ترین اول</option>
      <option value="h">بیشترین ساعت</option>
      <option value="t">بیشترین تست</option>
    </select>
  </div>
  <div class="g2" style="margin-bottom:18px">
    <div class="card"><div class="ct"><span class="ct-dot"></span>ساعت مطالعه — ۱۴ روز اخیر</div><canvas id="gz-hchart" height="150"></canvas></div>
    <div class="card"><div class="ct"><span class="ct-dot" style="background:var(--G)"></span>تعداد تست — ۱۴ روز اخیر</div><canvas id="gz-tchart" height="150"></canvas></div>
  </div>
  <div class="card" style="margin-bottom:18px">
    <div class="ct"><span class="ct-dot" style="background:var(--V)"></span>جمع مطالعه به تفکیک درس</div>
    <div id="gz-subjbars"></div>
  </div>

  <!-- ── نمودار و تحلیل ── -->
    <div class="card" style="margin-bottom:18px">
    <div class="ct"><span class="ct-dot" style="background:var(--Y)"></span>🗓️ هیت‌مپ ۵ هفته اخیر</div>
    <div style="font-size:10px;color:var(--txt3);margin-bottom:8px">هر خانه = ۱ روز. رنگ بر اساس ساعت مطالعه | هفته از شنبه شروع می‌شه</div>
    <div class="gz-heatmap" id="gz-heatmap-days"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
      <span style="font-size:10px;color:var(--txt3)">کمتر</span>
      <div style="width:14px;height:14px;border-radius:3px;background:var(--sur3);border:1px solid var(--bdr)"></div>
      <div style="width:14px;height:14px;border-radius:3px;background:rgba(99,91,255,.2)"></div>
      <div style="width:14px;height:14px;border-radius:3px;background:rgba(99,91,255,.45)"></div>
      <div style="width:14px;height:14px;border-radius:3px;background:var(--acc)"></div>
      <span style="font-size:10px;color:var(--txt3)">بیشتر</span>
    </div>
  </div>

  <div class="gz-analytics-grid">
    <div class="card">
      <div class="ct"><span class="ct-dot" style="background:var(--B)"></span>📅 میانگین روزانه هر هفته</div>
      <div id="gz-weekly-wrap">
        <div class="gz-week-bar-wrap" id="gz-weekly-bars"></div>
        <div style="display:flex;gap:6px;margin-top:4px" id="gz-weekly-lbls"></div>
      </div>
    </div>
    <div class="card">
      <div class="ct"><span class="ct-dot" style="background:var(--P)"></span>😊 روند خلق و انرژی</div>
      <canvas id="gz-mood-chart" height="130"></canvas>
    </div>
  </div>

  <div class="card gz-analytics-full">
    <div class="ct"><span class="ct-dot" style="background:var(--G)"></span>📊 تحلیل جامع</div>
    <div id="gz-summary-stats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:4px"></div>
  </div>

  <!-- ── مقایسه هفته به هفته ── -->
  <div class="g2" style="margin-bottom:18px">
    <div class="card">
      <div class="ct"><span class="ct-dot" style="background:var(--B)"></span>📊 مقایسه این هفته با هفته قبل</div>
      <div class="wc-grid" id="gz-week-compare"></div>
    </div>
    <div class="card">
      <div class="ct"><span class="ct-dot" style="background:var(--acc)"></span>📅 تقویم جلالی</div>
      <div class="jcal-nav">
        <button class="jcal-nav-btn" onclick="jCalPrev()">◀ قبل</button>
        <span class="jcal-title" id="jcal-title">—</span>
        <button class="jcal-nav-btn" onclick="jCalNext()">بعد ▶</button>
      </div>
      <div class="jcal-grid" id="jcal-grid"></div>
      <div style="font-size:10px;color:var(--txt3);margin-top:8px;display:flex;gap:10px;flex-wrap:wrap">
        <span><span style="display:inline-block;width:10px;height:10px;background:var(--acc);border-radius:2px;vertical-align:middle;margin-left:4px"></span>روز ثبت‌شده</span>
        <span><span style="display:inline-block;width:10px;height:10px;background:var(--sur3);border:1px solid var(--bdr);border-radius:2px;vertical-align:middle;margin-left:4px"></span>ثبت‌نشده</span>
      </div>
    </div>
  </div>

  <!-- ── برنامه هفتگی درسی ── -->
  <div class="card gz-analytics-full" style="margin-bottom:18px">
    <div class="ct" style="justify-content:space-between">
      <span><span class="ct-dot" style="background:var(--G)"></span>🗓️ برنامه هفتگی درسی</span>
      <button class="btn bg bsm" onclick="wplanReset()">🔄 پاک کردن هفته</button>
    </div>
    <div style="font-size:11px;color:var(--txt3);margin-bottom:6px">روی هر روز فعالیت برنامه‌ریزی‌شده بنویس. Enter = ثبت</div>
    <div class="wplan-grid" id="wplan-grid"></div>
  </div>

  <div id="gz-list"></div>
</section>

<!-- DAILY REPORT SCREENSHOT MODAL -->
<div class="screenshot-overlay" id="m-daily-report" style="display:none" onclick="if(event.target===this)document.getElementById('m-daily-report').style.display='none'">
  <div class="screenshot-modal">
    <div class="mhd">
      <span>📸 گزارش روزانه</span>
      <div style="display:flex;gap:8px">
        <select id="dr-date-sel" onchange="renderDailyReport()" style="width:auto;padding:6px 10px;font-size:12px;border-radius:var(--rs);background:var(--sur2);border:1px solid var(--bdr);color:var(--txt);font-family:Vazirmatn,sans-serif"></select>
        <button class="mcl" onclick="document.getElementById('m-daily-report').style.display='none'">✕</button>
      </div>
    </div>
    <div id="daily-report-content"></div>
    <div style="margin-top:16px;text-align:center;font-size:12px;color:var(--txt3)">برای اسکرین‌شات از قسمت محتوای بالا عکس بگیر 📷</div>
  </div>
</div>

<!-- GZ Subjects Manager Modal -->
<div class="ov" id="m-gz-subj" style="display:none" onclick="if(event.target===this)closeM('m-gz-subj')">
  <div class="modal msm">
    <div class="mhd"><span>⚙️ مدیریت درس‌های گزارش کار</span><button class="mcl" onclick="closeM('m-gz-subj')">✕</button></div>
    <div style="font-size:12px;color:var(--txt3);margin-bottom:12px;padding:10px;background:var(--sur2);border-radius:var(--rs);border:1px solid var(--bdr)">
      درس‌های گزارش کار می‌توانند با درس‌های آزمون فرق داشته باشند. با "همگام با آزمون" می‌توانی آن‌ها را یکی کنی.
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <button class="btn bg bsm" onclick="gzSubjSyncWithMain()">🔄 همگام با درس‌های آزمون</button>
      <button class="btn bg bsm" onclick="gzSubjCopyFromMain()">📋 کپی از درس‌های آزمون</button>
    </div>
    <div id="gz-subj-mgr-list" style="margin-bottom:12px"></div>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <input id="new-gz-subj-inp" type="text" placeholder="نام درس جدید..." style="flex:1;font-size:13px;padding:8px 12px" onkeydown="if(event.key==='Enter')addGzSubjItem()">
      <button class="btn bp bsm" onclick="addGzSubjItem()">+ افزودن</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn bg" onclick="closeM('m-gz-subj')">انصراف</button>
      <button class="btn bp" onclick="saveGzSubjs()">💾 ذخیره</button>
    </div>
  </div>
</div>

<div class="ov" id="m-gz" style="display:none" onclick="if(event.target===this)closeM('m-gz')">
  <div class="modal" style="max-width:780px">
    <div class="mhd"><span id="gz-modal-ttl">📊 ثبت گزارش روز</span><button class="mcl" onclick="closeM('m-gz')">✕</button></div>
    <div class="g2" style="margin-bottom:16px">
      <div class="fg">
        <label>تاریخ</label>
        <input type="text" id="gz-date" placeholder="مثلاً: ۱۴۰۴/۰۳/۱۵">
        <div style="font-size:10px;color:var(--txt3);margin-top:3px" id="gz-datehint"></div>
      </div>
      <div class="fg">
        <label>حال و انرژی امروز</label>
        <div class="gz-mood-row" id="gz-moodrow">
          <button class="gz-mb" data-v="5" onclick="gzMood(5)">🔥</button>
          <button class="gz-mb" data-v="4" onclick="gzMood(4)">😊</button>
          <button class="gz-mb" data-v="3" onclick="gzMood(3)">😐</button>
          <button class="gz-mb" data-v="2" onclick="gzMood(2)">😴</button>
          <button class="gz-mb" data-v="1" onclick="gzMood(1)">😓</button>
        </div>
        <div style="font-size:10px;color:var(--txt3);margin-top:4px" id="gz-moodlbl"></div>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden;margin-bottom:14px">
      <div style="display:grid;grid-template-columns:120px 65px 65px 80px 1fr;gap:8px;padding:10px 16px;background:var(--sur2);border-bottom:1px solid var(--bdr)">
        <span style="font-size:10px;font-weight:800;color:var(--txt3);text-transform:uppercase">درس</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3);text-transform:uppercase">⏱ ساعت</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3);text-transform:uppercase">🕐 دقیقه</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3);text-transform:uppercase">📝 تست</span>
        <span style="font-size:10px;font-weight:800;color:var(--txt3);text-transform:uppercase">✏️ فعالیت</span>
      </div>
      <div id="gz-rows" style="padding:4px 16px 10px"></div>
    </div>
    <div class="fg" style="margin-bottom:12px">
      <label>📝 یادداشت کلی روز</label>
      <textarea id="gz-note" class="nta" placeholder="امروز چه کردی؟ چه احساسی داشتی؟..." style="min-height:66px"></textarea>
    </div>
    <div class="fg" style="margin-bottom:14px">
      <label>🎯 هدف فردا</label>
      <input type="text" id="gz-goal" placeholder="فردا قراره چیکار کنی؟">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:14px;border-top:1px solid var(--bdr)">
      <button class="btn bg" onclick="closeM('m-gz')">انصراف</button>
      <button class="btn bp" onclick="gzSave()">💾 ذخیره گزارش</button>
    </div>
  </div>
</div>

<!-- QUESTIONS -->
<section class="sec" id="sec-questions">
  <div class="phr">
    <div class="ptitle">🖼️ سوالات <span>منتخب</span></div>
    <button class="btn bp" onclick="openAddQ()">+ افزودن سوال</button>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap">
    <select id="qf-subj" onchange="renderQs()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="all">همه دروس</option>
    </select>
    <select id="qf-exam" onchange="renderQs()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="all">همه آزمون‌ها</option>
    </select>
    <select id="qf-sort" onchange="renderQs()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="date-new">جدیدترین اول</option>
      <option value="date-old">قدیمی‌ترین اول</option>
      <option value="rev-most">بیشترین مرور</option>
      <option value="rev-least">کمترین مرور</option>
    </select>
    <select id="qf-rev" onchange="renderQs()" style="width:auto;padding:7px 12px;font-size:12px;border-radius:var(--rs)">
      <option value="all">همه مرورها</option>
      <option value="0">مرور نشده (۰)</option>
      <option value="1-3">۱ تا ۳ مرور</option>
      <option value="4+">۴+ مرور</option>
    </select>
  </div>
  <div id="q-wrap"></div>
</section>

<!-- SETTINGS -->
<section class="sec" id="sec-settings">
  <div class="phr"><div class="ptitle">⚙️ <span>تنظیمات</span></div></div>

  <!-- Theme Switcher — full width -->
  <div class="card" style="margin-bottom:18px">
    <div class="ct"><span class="ct-dot" style="background:var(--V)"></span>انتخاب تم ظاهری</div>
    <div class="theme-cards" id="theme-cards">

      <div class="theme-card active" id="tc-pro" onclick="setTheme('pro')">
        <div class="theme-preview tp-pro">
          <div class="tp-sidebar"></div>
          <div class="tp-content">
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-stats">
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
            </div>
          </div>
        </div>
        <div class="theme-card-name">Dashboard Pro</div>
        <div class="theme-card-desc">روشن، تمیز، داده‌محور — طراحی حرفه‌ای برای تمرکز روی اعداد</div>
        <div class="theme-card-badge" id="tcb-pro">● فعال</div>
      </div>

      <div class="theme-card" id="tc-glass" onclick="setTheme('glass')">
        <div class="theme-preview tp-glass">
          <div class="tp-sidebar"></div>
          <div class="tp-content">
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-stats">
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
            </div>
          </div>
        </div>
        <div class="theme-card-name">Obsidian Glass</div>
        <div class="theme-card-desc">فضای عمیق، بلور مشکی، درخشش کیهانی</div>
        <div class="theme-card-badge" id="tcb-glass">● انتخاب</div>
      </div>

      <div class="theme-card" id="tc-ember" onclick="setTheme('ember')">
        <div class="theme-preview tp-ember">
          <div class="tp-sidebar"></div>
          <div class="tp-content">
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-stats">
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
            </div>
          </div>
        </div>
        <div class="theme-card-name">Midnight Ember</div>
        <div class="theme-card-desc">آتش در دل شب — نارنجی و قرمز، گرم و خطرناک</div>
        <div class="theme-card-badge" id="tcb-ember">● انتخاب</div>
      </div>

      <div class="theme-card" id="tc-aurora" onclick="setTheme('aurora')">
        <div class="theme-preview tp-aurora">
          <div class="tp-sidebar"></div>
          <div class="tp-content">
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-bar"></div>
            <div class="tp-stats">
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
              <div class="tp-stat"></div>
            </div>
          </div>
        </div>
        <div class="theme-card-name">Aurora</div>
        <div class="theme-card-desc">شفق قطبی — فیروزه‌ای و آبی، سرد و رویایی</div>
        <div class="theme-card-badge" id="tcb-aurora">● انتخاب</div>
      </div>

    </div>
  </div>

  <!-- ── نصب به عنوان اپ ── -->
  <div class="card" style="margin-bottom:18px;border-right:4px solid var(--acc)">
    <div class="ct"><span class="ct-dot" style="background:var(--acc)"></span>📲 نصب به عنوان وب‌اپ (PWA)</div>
    <div id="pwa-status-area">
      <div id="pwa-auto-install" style="display:none;margin-bottom:12px">
        <button onclick="installPWA()" style="width:100%;background:linear-gradient(135deg,var(--acc),var(--acc2));color:#fff;border:none;border-radius:var(--rs);padding:12px;font-family:Vazirmatn,sans-serif;font-size:14px;font-weight:800;cursor:pointer;box-shadow:var(--sha-acc);letter-spacing:.3px">
          ⬇️ نصب آزمونِتو روی این دستگاه
        </button>
        <div style="font-size:11px;color:var(--txt3);text-align:center;margin-top:6px">مرورگر شما نصب خودکار را پشتیبانی می‌کند</div>
      </div>
      <div id="pwa-installed-msg" style="display:none;padding:12px;background:var(--G-d);border-radius:var(--rs);border:1px solid var(--G);font-size:13px;font-weight:700;color:var(--G)">
        ✅ آزمونِتو روی دستگاه شما نصب شده است
      </div>
      <div id="pwa-manual-guide">
        <div style="font-size:12px;font-weight:700;color:var(--txt2);margin-bottom:10px">راهنمای نصب دستی:</div>
        <div id="pwa-guide-chrome" style="display:none">
          <div style="font-size:11px;font-weight:800;color:var(--acc);margin-bottom:8px">Chrome دسکتاپ:</div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۱</div><div class="pwa-guide-txt">در نوار آدرس، آیکون ⊕ یا 💻 را در سمت راست پیدا کن</div></div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۲</div><div class="pwa-guide-txt">روی «نصب» یا «Install آزمونِتو» کلیک کن</div></div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۳</div><div class="pwa-guide-txt">در پنجره تأیید، روی Install کلیک کن — اپ روی دسکتاپ ظاهر می‌شود</div></div>
        </div>
        <div id="pwa-guide-ios" style="display:none">
          <div style="font-size:11px;font-weight:800;color:var(--acc);margin-bottom:8px">Safari (iPhone/iPad):</div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۱</div><div class="pwa-guide-txt">دکمه اشتراک‌گذاری (□↑) پایین صفحه را لمس کن</div></div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۲</div><div class="pwa-guide-txt">گزینه «Add to Home Screen» را انتخاب کن</div></div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۳</div><div class="pwa-guide-txt">روی «Add» کلیک کن — آیکون آزمونِتو در هوم‌اسکرین ظاهر می‌شود</div></div>
        </div>
        <div id="pwa-guide-android" style="display:none">
          <div style="font-size:11px;font-weight:800;color:var(--acc);margin-bottom:8px">Chrome Android:</div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۱</div><div class="pwa-guide-txt">منوی سه‌نقطه (⋮) بالای مرورگر را باز کن</div></div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۲</div><div class="pwa-guide-txt">گزینه «Add to Home screen» را انتخاب کن</div></div>
          <div class="pwa-guide-step"><div class="pwa-guide-num">۳</div><div class="pwa-guide-txt">روی «Add» کلیک کن</div></div>
        </div>
        <div style="margin-top:8px;padding:8px 12px;background:var(--Y-d);border-radius:var(--rs);font-size:11px;color:var(--txt2)">
          ⚠️ <b>مهم:</b> برای نصب به عنوان PWA، فایل باید از یک سرور (مثل GitHub Pages، Netlify، یا localhost) سرو بشه. از مسیر <code>file://</code> نصب کار نمی‌کنه.
        </div>
      </div>
    </div>
  </div>

  <div class="g2">
    <div class="card">
      <div class="ct"><span class="ct-dot"></span>رشته و دروس</div>
      <div class="fg">
        <label>رشته تحصیلی</label>
        <select id="field-sel" onchange="changeField()">
          <option value="tajrobi">تجربی</option>
          <option value="riazi">ریاضی</option>
          <option value="ensani">انسانی</option>
        </select>
      </div>
      <button class="btn bg" style="width:100%;justify-content:center" onclick="openSubjMgr()">✏️ ویرایش دروس</button>
    </div>
    <div class="card">
      <div class="ct"><span class="ct-dot" style="background:var(--B)"></span>مدیریت داده</div>
      <button class="btn bg" onclick="exportData()" style="width:100%;justify-content:center;margin-bottom:10px">📤 صادرکردن (JSON)</button>
      <button class="btn bg" onclick="exportCSV()" style="width:100%;justify-content:center;margin-bottom:10px">📊 خروجی CSV (اکسل)</button>
      <button class="btn bg" onclick="document.getElementById('imp-f').click()" style="width:100%;justify-content:center;margin-bottom:10px">📥 وارد کردن</button>
      <input type="file" id="imp-f" accept=".json" style="display:none" onchange="importData(event)">
      <button class="btn bd" onclick="clearAll()" style="width:100%;justify-content:center">🗑️ حذف همه داده‌ها</button>
    </div>
  </div>
</section>

<!-- PASAKHBARG -->
<section class="sec" id="sec-pasakhbarg">

  <!-- ── مرحله ۱: تنظیمات ── -->
  <div id="pb-setup">
    <div class="phr">
      <div class="ptitle">📋 <span>پاسخبرگ</span></div>
    </div>

    <!-- Subject table -->
    <div class="card" style="margin-bottom:18px">
      <div class="ct"><span class="ct-dot"></span>دروس و تنظیم سوالات</div>
      <div style="overflow-x:auto">
        <table class="pb-setup-tbl">
          <thead>
            <tr>
              <th>✓</th>
              <th>درس</th>
              <th>تعداد سوال</th>
              <th>نوع شماره‌گذاری</th>
              <th>پارامترها</th>
            </tr>
          </thead>
          <tbody id="pb-subj-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Timer + link -->
    <div class="g2" style="margin-bottom:22px">
      <div class="card">
        <div class="ct"><span class="ct-dot" style="background:var(--Y)"></span>تایمر</div>
        <div class="fg">
          <label>مدت زمان (دقیقه) — صفر یعنی بدون محدودیت</label>
          <input type="number" id="pb-timer-min" value="60" min="0" max="480" placeholder="دقیقه">
        </div>
      </div>
      <div class="card">
        <div class="ct"><span class="ct-dot" style="background:var(--G)"></span>اتصال به آزمون (اختیاری)</div>
        <div class="fg">
          <label>آزمون ثبت‌شده</label>
          <select id="pb-link-exam" onchange="pbLinkExamChange()"><option value="">— مستقل —</option><option value="__new__">➕ ایجاد آزمون جدید</option></select>
        </div>
        <div id="pb-new-exam-wrap" style="display:none;margin-top:10px;padding:12px;background:var(--acc-d);border-radius:var(--rs);border:1px solid rgba(99,91,255,.25)">
          <div class="fg" style="margin-bottom:10px">
            <label>نام آزمون جدید</label>
            <input type="text" id="pb-new-exam-name" placeholder="مثلاً: آزمون جامع ۱۴">
          </div>
          <div class="fg" style="margin-bottom:0">
            <label>تاریخ</label>
            <input type="text" id="pb-new-exam-date" placeholder="مثلاً: ۱۴۰۴/۰۳/۱۵">
          </div>
        </div>
        <div style="font-size:11px;color:var(--txt3);margin-top:4px" id="pb-link-hint">در صورت انتخاب، نتیجه قابل ذخیره در آزمون است</div>
      </div>
    </div>

    <div style="text-align:center">
      <button class="btn bp" style="font-size:15px;padding:14px 40px;letter-spacing:.2px" onclick="pbStartExam()">
        ▶ شروع آزمون
      </button>
    </div>
  </div>

  <!-- ── مرحله ۲: پاسخ‌دهی ── -->
  <div id="pb-answer" style="display:none">
    <!-- timer bar -->
    <div class="pb-timer-wrap" id="pb-timer-wrap">
      <div class="pb-timer-section">
        <div class="pb-timer-lbl">زمان باقی‌مانده</div>
        <div class="pb-timer-display" id="pb-timer-disp">--:--</div>
      </div>
      <div class="pb-timer-bar-track">
        <div class="pb-timer-bar-fill" id="pb-timer-bar" style="width:100%"></div>
      </div>
      <div class="pb-timer-section">
        <div class="pb-timer-lbl">پاسخ داده شد</div>
        <div class="pb-live-info" id="pb-live-info">۰ / ۰</div>
      </div>
      <button class="btn bg bsm" onclick="pbGoToKey()">پایان و ورود کلید ←</button>
    </div>
    <!-- questions -->
    <div id="pb-answer-body"></div>
    <div style="text-align:center;margin-top:24px">
      <button class="btn bp" style="padding:12px 32px" onclick="pbGoToKey()">پایان آزمون و ورود کلید ←</button>
    </div>
  </div>

  <!-- ── مرحله ۳: ورود کلید ── -->
  <div id="pb-key" style="display:none">
    <div class="phr">
      <div class="ptitle">🔑 ورود <span>کلید جواب</span></div>
      <button class="btn bp" onclick="pbShowResults()">نمایش نتایج ←</button>
    </div>
    <div class="card" style="margin-bottom:16px;background:var(--Y-d);border-color:var(--Y)">
      <div style="font-size:13px;color:var(--txt2)">📌 برای هر سوال گزینه <b>صحیح</b> را انتخاب کن. اگر سوال کلید ندارد، هیچ دایره‌ای را انتخاب نکن.</div>
    </div>
    <div id="pb-key-body"></div>
    <div style="text-align:center;margin-top:22px">
      <button class="btn bp" style="padding:12px 32px" onclick="pbShowResults()">نمایش نتایج ←</button>
    </div>
  </div>

  <!-- ── مرحله ۴: نتایج ── -->
  <div id="pb-result" style="display:none">
    <div class="phr">
      <div class="ptitle">📊 <span>نتایج آزمون</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn bg" onclick="pbRestart()">🔄 آزمون جدید</button>
        <button class="btn bg" onclick="pbGoToKey()">✏️ ویرایش کلید</button>
        <button class="btn bp" id="pb-save-btn" style="display:none" onclick="pbSaveToExams()">💾 ذخیره در آزمون‌ها</button>
      </div>
    </div>
    <div id="pb-result-body"></div>
    <!-- doubt analysis -->
    <div id="pb-doubt-analysis" style="display:none;margin-top:24px">
      <div class="card" style="margin-bottom:18px">
        <div class="ct"><span class="ct-dot" style="background:var(--V)"></span>تحلیل سوالات شک‌دار</div>
        <div id="pb-doubt-stats-body"></div>
      </div>
    </div>
    <!-- spider chart -->
    <div id="pb-spider-wrap" style="display:none;margin-top:18px">
      <div class="card">
        <div class="ct"><span class="ct-dot" style="background:var(--B)"></span>نمودار عنکبوتی — درصد دروس</div>
        <canvas id="pb-spider-canvas" width="460" height="380"></canvas>
      </div>
    </div>
    <!-- todo + notes per subject -->
    <div style="margin-top:24px" id="pb-result-notes-section">
      <div class="phr" style="margin-bottom:16px">
        <div style="font-size:18px;font-weight:900;letter-spacing:-.5px">📝 یادداشت، وظایف و سوالات</div>
        <button class="btn bp bsm" onclick="pbSaveResultNotes()">💾 ذخیره همه</button>
      </div>
      <!-- general note -->
      <div class="card" style="margin-bottom:16px;border-right:4px solid var(--acc)">
        <div class="ct"><span class="ct-dot"></span>یادداشت کلی آزمون</div>
        <textarea id="pb-result-note-general" class="nta" placeholder="یادداشت کلی این آزمون..." style="min-height:64px"></textarea>
      </div>
      <!-- per-subject cards with tabs -->
      <div id="pb-result-subj-notes"></div>
      <!-- hidden file input for inline Q upload -->
      <input type="file" id="pb-inline-q-file" accept="image/*" multiple style="display:none" onchange="pbInlineQFile(event)">
    </div>
  </div>

</section>

</main>
</div>

<!-- ══════════════════════ MODALS ══════════════════════ -->

<!-- Add/Edit Exam -->
<div class="ov" id="m-exam" style="display:none" onclick="if(event.target===this)closeM('m-exam')">
  <div class="modal" style="max-width:920px">
    <div class="mhd">
      <span id="m-exam-ttl">➕ افزودن آزمون</span>
      <button class="mcl" onclick="closeM('m-exam')">✕</button>
    </div>
    <div class="g2" style="margin-bottom:16px">
      <div class="fg"><label>نام آزمون</label><input id="ex-name" type="text" placeholder="مثلاً: آزمون آبان ماه"></div>
      <div class="fg">
        <label>تاریخ شمسی</label>
        <input id="ex-date" type="text" placeholder="۱۴۰۳/۰۸/۱۵" maxlength="10">
        <div id="ex-hint" style="font-size:10px;color:var(--txt3);margin-top:4px"></div>
      </div>
    </div>
    <!-- Exam type toggle -->
    <div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;background:var(--sur2);border-radius:var(--rs);padding:12px 16px;flex-wrap:wrap;border:1px solid var(--bdr)">
      <span style="font-size:11px;color:var(--txt3);font-weight:700;text-transform:uppercase;letter-spacing:.5px">نوع آزمون:</span>
      <div style="display:flex;gap:6px">
        <button id="typ-full" class="btn bp bsm" onclick="setExamType('full')">📚 همه دروس</button>
        <button id="typ-single" class="btn bg bsm" onclick="setExamType('single')">📖 تک‌درس</button>
      </div>
      <div id="single-subj-wrap" style="display:none;flex:1;min-width:180px">
        <select id="single-subj" onchange="buildSubjInputs(null)" style="font-size:13px;padding:8px 12px"></select>
      </div>
    </div>
    <div style="font-size:12px;color:var(--txt3);margin-bottom:12px;padding:10px 14px;background:var(--sur2);border-radius:var(--rs);border:1px solid var(--bdr);display:flex;gap:16px;flex-wrap:wrap">
      <span>📌 <b style="color:var(--G)">صحیح = کل − غلط − نزده</b></span>
      <span><b style="color:var(--acc)">درصد = (صحیح×۳ − غلط) ÷ (کل×۳) × ۱۰۰</b></span>
    </div>
    <div id="subj-inputs"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px;padding-top:16px;border-top:1px solid var(--bdr)">
      <button class="btn bg" onclick="closeM('m-exam')">انصراف</button>
      <button class="btn bp" onclick="saveExam()">💾 ذخیره آزمون</button>
    </div>
  </div>
</div>

<!-- View Exam -->
<div class="ov" id="m-view" style="display:none" onclick="if(event.target===this)closeM('m-view')">
  <div class="modal" style="max-width:920px">
    <div class="mhd"><span id="m-view-ttl">جزئیات آزمون</span><button class="mcl" onclick="closeM('m-view')">✕</button></div>
    <div id="m-view-body"></div>
  </div>
</div>

<!-- Add Question -->
<div class="ov" id="m-qadd" style="display:none" onclick="if(event.target===this)closeM('m-qadd')">
  <div class="modal msm">
    <div class="mhd"><span>🖼️ افزودن سوال منتخب</span><button class="mcl" onclick="closeM('m-qadd')">✕</button></div>
    <div class="fg"><label>درس</label><select id="q-subj"></select></div>
    <div class="fg"><label>آزمون (اختیاری)</label><select id="q-exam"><option value="">— بدون آزمون —</option></select></div>
    <div class="fg"><label>یادداشت (اختیاری)</label><input type="text" id="q-note" placeholder="مثلاً: اشتباه کردم، مفهوم مهم..."></div>
    <div class="fg">
      <label>تصاویر سوال <span style="color:var(--txt3);font-weight:400">(بدون محدودیت — کلیک · کشیدن · Ctrl+V)</span></label>
      <div class="dropz" id="q-dropz"
        onclick="document.getElementById('q-file').click()"
        ondragover="event.preventDefault();this.classList.add('over')"
        ondragleave="this.classList.remove('over')"
        ondrop="onQDrop(event)">
        <div style="font-size:28px;margin-bottom:8px">📷</div>
        <div style="font-size:13px;color:var(--txt2);font-weight:600">کلیک، کشیدن یا Ctrl+V</div>
        <div style="font-size:11px;color:var(--txt3);margin-top:4px">PNG · JPG · WEBP</div>
      </div>
      <input type="file" id="q-file" accept="image/*" multiple style="display:none" onchange="onQFile(event)">
      <div class="img-grid" id="q-grid"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn bg" onclick="closeM('m-qadd')">انصراف</button>
      <button class="btn bp" onclick="saveQ()">💾 ذخیره</button>
    </div>
  </div>
</div>

<!-- View Question -->
<div class="ov" id="m-qview" style="display:none" onclick="if(event.target===this)closeM('m-qview')">
  <div class="modal" style="max-width:680px">
    <div class="mhd"><span id="m-qview-ttl">سوال</span><button class="mcl" onclick="closeM('m-qview')">✕</button></div>
    <div id="m-qview-body"></div>
  </div>
</div>

<!-- Subject Manager -->
<div class="ov" id="m-subj" style="display:none" onclick="if(event.target===this)closeM('m-subj')">
  <div class="modal msm">
    <div class="mhd"><span>📚 مدیریت دروس</span><button class="mcl" onclick="closeM('m-subj')">✕</button></div>
    <div id="subj-mgr-list"></div>
    <div style="display:flex;gap:8px;margin-top:14px">
      <input id="new-subj-inp" placeholder="نام درس جدید" style="flex:1">
      <button class="btn bp bsm" onclick="addSubjItem()">+ افزودن</button>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;padding-top:14px;border-top:1px solid var(--bdr)">
      <button class="btn bg" onclick="closeM('m-subj')">بستن</button>
      <button class="btn bp" onclick="saveSubjs()">💾 ذخیره</button>
    </div>
  </div>
</div>

<!-- Fullscreen Viewer -->
<div id="fso">
  <button id="fso-close" onclick="closeFS()">✕</button>
  <div id="fso-count"></div>
  <button id="fso-prev" onclick="fsNav(-1)">›</button>
  <img id="fso-img" alt="">
  <button id="fso-next" onclick="fsNav(1)">‹</button>
</div>

<script>
// ════════════════════════════════════════════════════════
// JALALI DATE
// ════════════════════════════════════════════════════════
function toJalali(gy,gm,gd){
  let g_d_no,j_d_no,j_np,i;
  let g_y=gy-1600,g_m=gm-1,g_d=gd-1;
  g_d_no=365*g_y+Math.floor((g_y+3)/4)-Math.floor((g_y+99)/100)+Math.floor((g_y+399)/400);
  for(i=0;i<g_m;i++)g_d_no+=[31,28+(g_y%4==0&&(g_y%100!=0||g_y%400==0)?1:0),31,30,31,30,31,31,30,31,30,31][i];
  g_d_no+=g_d;j_d_no=g_d_no-79;
  j_np=Math.floor(j_d_no/12053);j_d_no%=12053;
  let jy=979+33*j_np+4*Math.floor(j_d_no/1461);j_d_no%=1461;
  if(j_d_no>=366){jy+=Math.floor((j_d_no-1)/365);j_d_no=(j_d_no-1)%365;}
  for(i=0;i<11&&j_d_no>=[31,31,31,31,31,31,30,30,30,30,30,29][i];i++)j_d_no-=[31,31,31,31,31,31,30,30,30,30,30,29][i];
  return{jy,jm:i+1,jd:j_d_no+1};
}
function todayJ(){
  const d=new Date(),{jy,jm,jd}=toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
  return`${jy}/${String(jm).padStart(2,'0')}/${String(jd).padStart(2,'0')}`;
}
function tomorrowJ(){
  const d=new Date();d.setDate(d.getDate()+1);
  const{jy,jm,jd}=toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
  return`${jy}/${String(jm).padStart(2,'0')}/${String(jd).padStart(2,'0')}`;
}
function pN(n){return String(n).replace(/\d/g,d=>'۰۱۲۳۴۵۶۷۸۹'[d]);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ════════════════════════════════════════════════════════
// DATA STORE
// ════════════════════════════════════════════════════════
const FIELDS={
  tajrobi:['زیست‌شناسی','فیزیک','ریاضی','شیمی','زمین‌شناسی'],
  riazi:['ریاضی','فیزیک','شیمی','زبان فارسی','عربی','دین و زندگی','زبان انگلیسی'],
  ensani:['ادبیات','عربی','دین و زندگی','زبان','تاریخ','جغرافیا','اقتصاد','منطق','فلسفه'],
};
const CLR=['#635BFF','#00C781','#00C8FF','#F43F5E','#FBBF24','#A855F7','#F97316','#34D399','#38BDF8','#FB7185'];

let S={
  exams: JSON.parse(localStorage.getItem('az_exams')||'[]'),
  subjects: JSON.parse(localStorage.getItem('az_subjects')||'null')||[...FIELDS.tajrobi],
  field: localStorage.getItem('az_field')||'tajrobi',
  gz: JSON.parse(localStorage.getItem('az_gz')||'[]'),
  gzSubjects: JSON.parse(localStorage.getItem('az_gz_subjects')||'null')||null, // null = sync with S.subjects
};
// helper: get gz subjects (can be independent or same as main subjects)
function getGzSubjects(){ return S.gzSubjects||S.subjects; }

function saveS(){
  localStorage.setItem('az_exams',JSON.stringify(S.exams));
  localStorage.setItem('az_subjects',JSON.stringify(S.subjects));
  localStorage.setItem('az_field',S.field);
  localStorage.setItem('az_gz',JSON.stringify(S.gz));
  if(S.gzSubjects!==null)localStorage.setItem('az_gz_subjects',JSON.stringify(S.gzSubjects));
  else localStorage.removeItem('az_gz_subjects');
}
// ════════════════════════════════════════════════════════
// INDEXEDDB — ذخیره بدون محدودیت برای سوالات و عکس‌ها
// ════════════════════════════════════════════════════════
let _db=null;
function openDB(){
  if(_db)return Promise.resolve(_db);
  return new Promise((res,rej)=>{
    const req=indexedDB.open('az_questions_db',1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('questions'))
        db.createObjectStore('questions',{keyPath:'id'});
    };
    req.onsuccess=e=>{_db=e.target.result;res(_db);};
    req.onerror=e=>rej(e.target.error);
  });
}
function loadQs(){
  // این تابع همزمان (sync) برای سازگاری با کد قدیمی — از نسخه cached استفاده می‌کند
  return window._qsCache||[];
}
function saveQs(qs){
  window._qsCache=qs;
  openDB().then(db=>{
    const tx=db.transaction('questions','readwrite');
    const store=tx.objectStore('questions');
    store.clear();
    qs.forEach(q=>store.put(q));
  });
}
async function loadQsAsync(){
  // migrate از localStorage اگر داده قدیمی وجود داشت
  const old=localStorage.getItem('az_qs');
  if(old){
    try{
      const parsed=JSON.parse(old);
      if(parsed&&parsed.length){
        await openDB();
        saveQs(parsed);
        localStorage.removeItem('az_qs');
      }
    }catch(e){}
  }
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction('questions','readonly');
    const store=tx.objectStore('questions');
    const req=store.getAll();
    req.onsuccess=e=>{
      window._qsCache=e.target.result||[];
      res(window._qsCache);
    };
    req.onerror=e=>rej(e.target.error);
  });
}

// ════════════════════════════════════════════════════════
// HELPERS
// ════════════════════════════════════════════════════════
function calcPct(tot,wr,un){
  tot=parseInt(tot)||0;wr=parseInt(wr)||0;un=parseInt(un)||0;
  if(tot<=0)return null;
  const cor=tot-wr-un;
  if(cor<0||cor>tot)return null;
  return(cor*3-wr)/(tot*3)*100;
}
function examTotal(exam){
  const vals=S.subjects.map(s=>exam.subjects?.[s]?.pct).filter(v=>v!=null&&!isNaN(v));
  return vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:null;
}
function pCls(v){if(v==null)return'';if(v>=50)return'p-hi';if(v>=25)return'p-mi';if(v>=0)return'p-lo';return'p-ne';}
function pClr(v){
  const s=getComputedStyle(document.documentElement);
  if(v==null)return s.getPropertyValue('--txt3').trim();
  if(v>=50)return s.getPropertyValue('--G').trim();
  if(v>=25)return s.getPropertyValue('--Y').trim();
  return s.getPropertyValue('--P').trim();
}
function fP(v){return v==null?'—':v.toFixed(1)+'%';}

// ════════════════════════════════════════════════════════
// NAV
// ════════════════════════════════════════════════════════
const SECS=['dashboard','exams','charts','subjects','todos','notes','gozaresh','questions','pasakhbarg','settings'];
function go(name){
  document.querySelectorAll('.sec').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.querySelectorAll('.ni')[SECS.indexOf(name)].classList.add('active');
  if(name==='charts')setTimeout(()=>{drawTotalChart();drawSubjChart();drawSpiderChart();},50);
  if(name==='subjects')renderSubjAnalysis();
  if(name==='todos'){populateTodoSubjFilter();renderTodos();}
  if(name==='notes'){populateNotesFilter();renderNotes();}
  if(name==='gozaresh'){gzInit();gzTodayInit();renderGz();gzWgRender();jCalRender();renderWeekPlan();}
  if(name==='questions'){populateQFilters();renderQs();}
  if(name==='pasakhbarg'){ if(PB.phase==='setup')pbInitSetup(); }
  if(name==='settings'){
    pwaDetectAndShowGuide();
    document.getElementById('field-sel').value=S.field;
    const t=document.documentElement.getAttribute('data-theme')||'pro';
    document.getElementById('tc-pro').classList.toggle('active',t==='pro');
    document.getElementById('tc-glass').classList.toggle('active',t==='glass');
    updateThemeBadges(t);
  }
}

// ════════════════════════════════════════════════════════
// MODAL
// ════════════════════════════════════════════════════════
function closeM(id){document.getElementById(id).style.display='none';}

// ════════════════════════════════════════════════════════
// ADD / EDIT EXAM
// ════════════════════════════════════════════════════════
let editId=null, tmpTodos=[], examType='full';

function openAdd(id=null){
  editId=id;
  const exam=id?S.exams.find(e=>e.id===id):null;
  document.getElementById('m-exam-ttl').textContent=id?'✏️ ویرایش آزمون':'➕ افزودن آزمون';
  document.getElementById('ex-name').value=exam?exam.name:'';
  document.getElementById('ex-date').value=exam?exam.date:todayJ();
  document.getElementById('ex-hint').textContent='امروز: '+todayJ();
  tmpTodos=S.subjects.map((s,i)=>(exam?.subjects?.[s]?.todos||[]).map(t=>({...t})));
  const ss=document.getElementById('single-subj');
  ss.innerHTML=S.subjects.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
  const type=exam?.examType||'full';
  if(exam?.singleSubj)ss.value=exam.singleSubj;
  setExamType(type,true);
  buildSubjInputs(exam);
  document.getElementById('m-exam').style.display='flex';
}

function setExamType(type,silent=false){
  examType=type;
  document.getElementById('typ-full').className='btn bsm '+(type==='full'?'bp':'bg');
  document.getElementById('typ-single').className='btn bsm '+(type==='single'?'bp':'bg');
  document.getElementById('single-subj-wrap').style.display=type==='single'?'':'none';
  if(!silent)buildSubjInputs(editId?S.exams.find(e=>e.id===editId):null);
}

function getActiveSubjects(){
  if(examType==='single'){
    const sel=document.getElementById('single-subj').value;
    return S.subjects.filter(s=>s===sel);
  }
  return S.subjects;
}

function buildSubjInputs(exam){
  const wrap=document.getElementById('subj-inputs');
  wrap.innerHTML='';
  const activeSubjs=getActiveSubjects();
  activeSubjs.forEach(s=>{
    const i=S.subjects.indexOf(s);
    const clr=CLR[i%CLR.length];
    const sd=exam?.subjects?.[s]||{};
    const pct=sd.pct!=null?sd.pct.toFixed(1):'—';
    const todos=tmpTodos[i]||[];
    const todosHtml=todos.map((t,ti)=>`
      <div class="tdi" id="tdi-${i}-${ti}">
        <input type="checkbox" class="tdcb" ${t.done?'checked':''} onchange="chkTodo(${i},${ti},this.checked)">
        <span class="tdt ${t.done?'dn':''}">${esc(t.text)}</span>
        <button class="tddl" onclick="delTodo(${i},${ti})">✕</button>
      </div>`).join('');
    wrap.innerHTML+=`
    <div class="scard">
      <div class="shead">
        <div class="sname" style="color:${clr}"><span class="dot" style="background:${clr};margin-left:7px"></span>${esc(s)}</div>
        <span class="pbw ${pCls(sd.pct)}" id="rpb-${i}">${fP(sd.pct)}</span>
      </div>
      <div class="crow">
        <div class="cl"><label>📋 کل سوالات</label><input type="number" id="t-${i}" min="0" placeholder="0" value="${sd.total||''}" oninput="rcalc(${i})"></div>
        <div class="cl"><label>❌ غلط</label><input type="number" id="w-${i}" min="0" placeholder="0" value="${sd.wrong||''}" oninput="rcalc(${i})"></div>
        <div class="cl"><label>⭕ نزده</label><input type="number" id="u-${i}" min="0" placeholder="0" value="${sd.unanswered||''}" oninput="rcalc(${i})"></div>
        <div class="pbox"><div class="pv" id="rv-${i}">${pct}</div><div class="pl2">درصد</div></div>
      </div>
      <button class="togbtn" onclick="togColl('nc-${i}')">📝 یادداشت + TODO ${(sd.notes||todos.length)?'(دارد)':''}</button>
      <div class="coll ${(sd.notes||todos.length)?'open':''}" id="nc-${i}">
        <div style="margin-top:12px">
          <label style="font-size:10px;margin-bottom:5px;display:block">📝 یادداشت</label>
          <textarea id="nt-${i}" class="nta" placeholder="یادداشت برای ${esc(s)}...">${esc(sd.notes||'')}</textarea>
          <div style="margin-top:12px">
            <label style="font-size:10px;margin-bottom:7px;display:block">✅ لیست وظایف</label>
            <div class="tdl" id="tdl-${i}">${todosHtml}</div>
            <div class="tdadd">
              <input id="tdinp-${i}" placeholder="وظیفه جدید..." onkeydown="if(event.key==='Enter')addTodoItem(${i})">
              <button class="btn bp bxs" onclick="addTodoItem(${i})">+ افزودن</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  });
}

function togColl(id){document.getElementById(id).classList.toggle('open');}

function rcalc(i){
  const pct=calcPct(
    document.getElementById('t-'+i).value,
    document.getElementById('w-'+i).value,
    document.getElementById('u-'+i).value
  );
  document.getElementById('rv-'+i).textContent=pct==null?'—':pct.toFixed(1)+'%';
  document.getElementById('rpb-'+i).textContent=fP(pct);
  document.getElementById('rpb-'+i).className='pbw '+pCls(pct);
}

function chkTodo(i,ti,done){
  if(tmpTodos[i]&&tmpTodos[i][ti])tmpTodos[i][ti].done=done;
  const sp=document.querySelector(`#tdi-${i}-${ti} .tdt`);
  if(sp)sp.className='tdt'+(done?' dn':'');
}
function delTodo(i,ti){tmpTodos[i].splice(ti,1);rebuildTdl(i);}
function addTodoItem(i){
  const inp=document.getElementById('tdinp-'+i);
  const txt=inp.value.trim();if(!txt)return;
  tmpTodos[i].push({text:txt,done:false});inp.value='';rebuildTdl(i);
}
function rebuildTdl(i){
  document.getElementById('tdl-'+i).innerHTML=(tmpTodos[i]||[]).map((t,ti)=>`
    <div class="tdi" id="tdi-${i}-${ti}">
      <input type="checkbox" class="tdcb" ${t.done?'checked':''} onchange="chkTodo(${i},${ti},this.checked)">
      <span class="tdt ${t.done?'dn':''}">${esc(t.text)}</span>
      <button class="tddl" onclick="delTodo(${i},${ti})">✕</button>
    </div>`).join('');
}

function saveExam(){
  const name=document.getElementById('ex-name').value.trim();
  const date=document.getElementById('ex-date').value.trim();
  if(!name){alert('نام آزمون را وارد کن');return;}
  if(!date){alert('تاریخ را وارد کن');return;}
  const activeSubjs=getActiveSubjects();
  const singleSubj=examType==='single'?document.getElementById('single-subj').value:null;
  let subjects=editId?{...(S.exams.find(e=>e.id===editId)?.subjects||{})}:{};
  activeSubjs.forEach(s=>{
    const i=S.subjects.indexOf(s);
    const tot=document.getElementById('t-'+i)?.value||'0';
    const wr=document.getElementById('w-'+i)?.value||'0';
    const un=document.getElementById('u-'+i)?.value||'0';
    subjects[s]={
      total:parseInt(tot)||0,wrong:parseInt(wr)||0,unanswered:parseInt(un)||0,
      pct:calcPct(tot,wr,un),
      notes:document.getElementById('nt-'+i)?.value||'',
      todos:[...(tmpTodos[i]||[])],
    };
  });
  const examData={name,date,subjects,examType,singleSubj};
  if(editId){
    const idx=S.exams.findIndex(e=>e.id===editId);
    if(idx>-1)S.exams[idx]={...S.exams[idx],...examData};
  }else{
    S.exams.push({id:Date.now().toString(),...examData});
  }
  S.exams.sort((a,b)=>a.date.localeCompare(b.date));
  saveS();closeM('m-exam');refresh();
}

function deleteExam(id){
  if(!confirm('این آزمون حذف شود؟'))return;
  S.exams=S.exams.filter(e=>e.id!==id);saveS();refresh();
}

// ════════════════════════════════════════════════════════
// VIEW EXAM
// ════════════════════════════════════════════════════════
function viewExam(id){
  const exam=S.exams.find(e=>e.id===id);if(!exam)return;
  const total=examTotal(exam);
  const css=getComputedStyle(document.documentElement);
  document.getElementById('m-view-ttl').textContent=`📋 ${esc(exam.name)} — ${exam.date}`;
  let html=`<div style="margin-bottom:16px"><span class="bdg by" style="font-size:13px;padding:5px 14px">درصد کل: ${fP(total)}</span></div>`;
  S.subjects.forEach((s,i)=>{
    const sd=exam.subjects?.[s];if(!sd)return;
    const clr=CLR[i%CLR.length];
    const cor=sd.total-sd.wrong-sd.unanswered;
    const pend=(sd.todos||[]).filter(t=>!t.done).length;
    html+=`<div class="scard">
      <div class="shead">
        <div class="sname" style="color:${clr}"><span class="dot" style="background:${clr};margin-left:7px"></span>${esc(s)}</div>
        <span class="pbw ${pCls(sd.pct)}">${fP(sd.pct)}</span>
      </div>
      <div style="display:flex;gap:16px;font-size:12px;flex-wrap:wrap;margin-bottom:12px">
        <span>کل: <b>${pN(sd.total)}</b></span>
        <span style="color:${css.getPropertyValue('--G')}">صحیح: <b>${pN(cor)}</b></span>
        <span style="color:${css.getPropertyValue('--P')}">غلط: <b>${pN(sd.wrong)}</b></span>
        <span style="color:var(--txt3)">نزده: <b style="color:var(--txt)">${pN(sd.unanswered)}</b></span>
      </div>
      <div class="prw" style="margin-bottom:10px">
        <div class="prt"><div class="prf" style="width:${Math.max(0,sd.pct||0)}%;background:${clr}"></div></div>
      </div>
      ${sd.notes?`<div style="background:var(--sur3);border-radius:var(--rs);padding:10px;font-size:12px;color:var(--txt2);margin-bottom:8px;border:1px solid var(--bdr)">📝 ${esc(sd.notes)}</div>`:''}
      ${sd.todos&&sd.todos.length?`<div style="font-size:11px;color:var(--txt3);margin-bottom:6px;font-weight:700">✅ TODO — ${pN(pend)} باقی‌مانده</div>${sd.todos.map(t=>`<div style="font-size:12px;padding:4px 0;display:flex;gap:8px;align-items:center"><span style="color:${t.done?css.getPropertyValue('--G'):'var(--txt3)'};font-size:14px">${t.done?'☑':'☐'}</span><span style="${t.done?'text-decoration:line-through;color:var(--txt3)':''}">${esc(t.text)}</span></div>`).join('')}`:''}
    </div>`;
  });
  document.getElementById('m-view-body').innerHTML=html;
  document.getElementById('m-view').style.display='flex';
}

// ════════════════════════════════════════════════════════
// DASHBOARD
// ════════════════════════════════════════════════════════
function refresh(){
  renderDash();renderExamsTable();
  populateSubjSel();
  document.getElementById('sb-n').textContent=pN(S.exams.length);
}

function renderDash(){
  const css=getComputedStyle(document.documentElement);
  document.getElementById('d-total').textContent=pN(S.exams.length);
  if(!S.exams.length){
    ['d-best','d-avg'].forEach(id=>document.getElementById(id).textContent='—');
    document.getElementById('d-weak').textContent='—';
    document.getElementById('d-last').innerHTML=`<div class="empty" style="padding:28px 0"><div class="ei">📭</div><p>هنوز آزمونی ثبت نشده</p></div>`;
    document.getElementById('d-bars').innerHTML='';
    drawMiniChart();return;
  }
  const tots=S.exams.map(e=>examTotal(e)).filter(v=>v!=null);
  if(tots.length){
    document.getElementById('d-best').innerHTML=Math.max(...tots).toFixed(1)+'<span>%</span>';
    document.getElementById('d-avg').innerHTML=(tots.reduce((a,b)=>a+b,0)/tots.length).toFixed(1)+'<span>%</span>';
  }
  const sAvg={};
  S.subjects.forEach(s=>{
    const vs=S.exams.map(e=>e.subjects?.[s]?.pct).filter(v=>v!=null&&!isNaN(v));
    if(vs.length)sAvg[s]=vs.reduce((a,b)=>a+b,0)/vs.length;
  });
  const wk=Object.entries(sAvg).sort((a,b)=>a[1]-b[1])[0];
  document.getElementById('d-weak').textContent=wk?wk[0]:'—';

  const last=S.exams[S.exams.length-1];
  const lt=examTotal(last);
  const tdRem=S.subjects.reduce((a,s)=>a+(last.subjects?.[s]?.todos||[]).filter(t=>!t.done).length,0);
  const accClr=css.getPropertyValue('--acc').trim();
  document.getElementById('d-last').innerHTML=`
    <div style="margin-bottom:12px">
      <div style="font-size:16px;font-weight:800;margin-bottom:3px">${esc(last.name)}</div>
      <div style="font-size:11px;color:var(--txt3);font-weight:600">${last.date}</div>
    </div>
    <div style="font-size:32px;font-weight:900;color:${accClr};letter-spacing:-1.5px">${fP(lt)}</div>
    <div style="font-size:11px;color:var(--txt3);margin-top:3px;font-weight:600;text-transform:uppercase;letter-spacing:.4px">میانگین درصد کل</div>
    ${tdRem?`<div class="bdg bb" style="margin-top:10px;font-size:12px">${pN(tdRem)} وظیفه باقی‌مانده</div>`:''}`;

  let bars='';
  S.subjects.forEach((s,i)=>{
    const v=last.subjects?.[s]?.pct;if(v==null)return;
    bars+=`<div class="prw" style="margin-bottom:10px">
      <span style="width:90px;font-size:11px;color:${CLR[i%CLR.length]};font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s)}</span>
      <div class="prt"><div class="prf" style="width:${Math.max(0,v)}%;background:${CLR[i%CLR.length]}"></div></div>
      <span style="font-size:11px;font-weight:800;min-width:38px;text-align:center;color:${CLR[i%CLR.length]}">${v.toFixed(0)}%</span>
    </div>`;
  });
  document.getElementById('d-bars').innerHTML=bars||'<p style="color:var(--txt3);font-size:12px">درصدی ثبت نشده</p>';
  drawMiniChart();
}

function renderExamsTable(){
  const tbody=document.getElementById('et-body');
  const empty=document.getElementById('et-empty');
  const thead=document.getElementById('et-head');
  if(!S.exams.length){tbody.innerHTML='';thead.style.display='none';empty.style.display='block';return;}
  thead.style.display='';empty.style.display='none';
  tbody.innerHTML=[...S.exams].reverse().map(ex=>{
    const t=examTotal(ex);
    const sc=S.subjects.filter(s=>ex.subjects?.[s]?.pct!=null).length;
    const tdR=S.subjects.reduce((a,s)=>a+(ex.subjects?.[s]?.todos||[]).filter(t=>!t.done).length,0);
    const hasN=S.subjects.some(s=>ex.subjects?.[s]?.notes);
    const isSingle=ex.examType==='single';
    return`<tr>
      <td style="color:var(--txt3);white-space:nowrap;font-size:12px;font-weight:600">${ex.date}</td>
      <td style="font-weight:700">${esc(ex.name)} ${isSingle?`<span class="bdg" style="background:rgba(56,189,248,.12);color:var(--B);font-size:10px;margin-right:4px">📖 ${esc(ex.singleSubj)}</span>`:''}</td>
      <td><span class="pbw ${pCls(t)}">${fP(t)}</span></td>
      <td>${isSingle?`<span class="bdg" style="background:rgba(56,189,248,.10);color:var(--B)">تک‌درس</span>`:`<span class="bdg by">${pN(sc)} درس</span>`}</td>
      <td>${tdR?`<span class="bdg bb">${pN(tdR)} TODO</span> `:''}${hasN?'<span class="bdg by" style="font-size:10px">📝</span>':''} ${!tdR&&!hasN?'<span style="color:var(--txt3);font-size:11px">—</span>':''}</td>
      <td style="white-space:nowrap;display:flex;gap:6px">
        <button class="btn bg bsm" onclick="viewExam('${ex.id}')">👁 مشاهده</button>
        <button class="btn bg bsm" onclick="openAdd('${ex.id}')">✏️</button>
        <button class="btn bd bsm" onclick="deleteExam('${ex.id}')">🗑️</button>
      </td>
    </tr>`;
  }).join('');
}

function renderSubjAnalysis(){
  if(!S.exams.length){document.getElementById('subj-wrap').innerHTML=`<div class="empty"><div class="ei">📚</div><p>ابتدا چند آزمون ثبت کن</p></div>`;return;}
  const css=getComputedStyle(document.documentElement);
  let html='<div class="g2">';
  S.subjects.forEach((s,i)=>{
    const clr=CLR[i%CLR.length];
    const vs=S.exams.map(e=>e.subjects?.[s]?.pct).filter(v=>v!=null&&!isNaN(v));
    if(!vs.length)return;
    const avg=vs.reduce((a,b)=>a+b,0)/vs.length;
    const best=Math.max(...vs),worst=Math.min(...vs);
    const trend=vs.length>1?vs[vs.length-1]-vs[vs.length-2]:null;
    const pend=S.exams.reduce((a,e)=>a+(e.subjects?.[s]?.todos||[]).filter(t=>!t.done).length,0);
    const trendBg=trend!=null?(trend>=0?css.getPropertyValue('--G-d'):css.getPropertyValue('--P-d')):'';
    const trendClr=trend!=null?(trend>=0?css.getPropertyValue('--G'):css.getPropertyValue('--P')):'';
    html+=`<div class="card card-hover">
      <div class="ct" style="color:${clr}"><span class="dot" style="background:${clr};box-shadow:0 0 8px ${clr}55"></span>${esc(s)}</div>
      <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px">
        <div>
          <div style="font-size:28px;font-weight:900;letter-spacing:-1px">${avg.toFixed(1)}<span style="font-size:14px;color:var(--txt3);font-weight:600">%</span></div>
          <div style="font-size:10px;color:var(--txt3);font-weight:700;text-transform:uppercase;letter-spacing:.4px">میانگین (${pN(vs.length)} آزمون)</div>
        </div>
        <div style="display:flex;gap:14px">
          <div style="text-align:center">
            <div style="font-size:16px;font-weight:800;color:${css.getPropertyValue('--G')}">${best.toFixed(1)}%</div>
            <div style="font-size:9px;color:var(--txt3);font-weight:700">بهترین</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:16px;font-weight:800;color:${css.getPropertyValue('--P')}">${worst.toFixed(1)}%</div>
            <div style="font-size:9px;color:var(--txt3);font-weight:700">ضعیف‌ترین</div>
          </div>
        </div>
      </div>
      <div class="prw" style="margin-bottom:10px"><div class="prt"><div class="prf" style="width:${Math.max(0,avg)}%;background:${clr}"></div></div></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${trend!=null?`<span style="font-size:11px;padding:3px 10px;border-radius:7px;background:${trendBg};color:${trendClr};font-weight:700">${trend>=0?'▲':'▼'} ${Math.abs(trend).toFixed(1)}%</span>`:''}
        ${pend?`<span class="bdg bb">${pN(pend)} وظیفه باقی‌مانده</span>`:''}
      </div>
    </div>`;
  });
  html+='</div>';
  document.getElementById('subj-wrap').innerHTML=html;
}

// ════════════════════════════════════════════════════════
// TODOS
// ════════════════════════════════════════════════════════
function populateTodoSubjFilter(){
  var sel=document.getElementById('td-subj-filter');
  if(!sel)return;
  sel.innerHTML=`<option value="all">همه دروس</option>`+S.subjects.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
  // also update standalone todo subject select
  var sel2=document.getElementById('std-todo-subj');
  if(sel2)sel2.innerHTML=S.subjects.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
}

function renderTodos(){
  const filter=document.getElementById('td-filter').value;
  const subjFilter=document.getElementById('td-subj-filter')?.value||'all';
  const wrap=document.getElementById('td-wrap');
  const stats=document.getElementById('td-stats');
  const css=getComputedStyle(document.documentElement);
  let tot=0,done=0,pend=0;
  const bySub={};
  S.subjects.forEach(s=>{bySub[s]=[];});
  S.exams.forEach(exam=>{
    S.subjects.forEach(s=>{
      (exam.subjects?.[s]?.todos||[]).forEach((t,ti)=>{
        tot++;t.done?done++:pend++;
        bySub[s].push({...t,examId:exam.id,examName:exam.name,examDate:exam.date,ti});
      });
    });
  });
  stats.innerHTML=`
    <span class="bdg by" style="padding:5px 14px;font-size:12px">📋 کل: ${pN(tot)}</span>
    <span class="bdg bb" style="padding:5px 14px;font-size:12px">⏳ باقی‌مانده: ${pN(pend)}</span>
    <span class="bdg" style="background:var(--G-d);color:var(--G);padding:5px 14px;font-size:12px;font-weight:700">✅ انجام‌شده: ${pN(done)}</span>`;
  if(!tot){wrap.innerHTML=`<div class="empty"><div class="ei">✅</div><h3>هیچ وظیفه‌ای ثبت نشده</h3></div>`;return;}
  let html='<div class="g2">',shown=false;
  const subjsToShow=subjFilter==='all'?S.subjects:S.subjects.filter(s=>s===subjFilter);
  subjsToShow.forEach((s,idx)=>{
    const i=S.subjects.indexOf(s);
    const clr=CLR[i%CLR.length];
    let items=bySub[s]||[];
    if(filter==='pending')items=items.filter(t=>!t.done);
    if(filter==='done')items=items.filter(t=>t.done);
    if(!items.length)return;
    shown=true;
    const p=items.filter(t=>!t.done).length,d=items.filter(t=>t.done).length;
    html+=`<div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--bdr)">
        <div style="display:flex;align-items:center;gap:9px">
          <span class="dot" style="background:${clr};box-shadow:0 0 8px ${clr}55;width:10px;height:10px"></span>
          <span style="font-size:14px;font-weight:800;color:${clr}">${esc(s)}</span>
        </div>
        <div style="display:flex;gap:6px">
          ${p?`<span class="bdg bb">${pN(p)} باقی</span>`:''}
          ${d?`<span class="bdg" style="background:var(--G-d);color:var(--G)">${pN(d)} انجام‌شده</span>`:''}
        </div>
      </div>`;
    items.forEach(t=>{
      const doneBadge=t.done?`background:var(--G-d);color:var(--G)`:`background:var(--acc-d);color:var(--acc)`;
      html+=`<div class="tdi" style="padding:9px 4px">
        <input type="checkbox" class="tdcb" ${t.done?'checked':''} onchange="globalChkTodo('${t.examId}','${esc(s)}',${t.ti},this.checked)">
        <div style="flex:1">
          <div class="tdt ${t.done?'dn':''}" style="font-size:13px">${esc(t.text)}</div>
          <div style="font-size:10px;color:var(--txt3);margin-top:2px;font-weight:600">📝 ${esc(t.examName)} — ${t.examDate}</div>
        </div>
        <span style="font-size:10px;white-space:nowrap;padding:3px 9px;border-radius:7px;${doneBadge};font-weight:700">${t.done?'✅':'⏳'}</span>
      </div>`;
    });
    html+=`</div>`;
  });
  html+='</div>';
  wrap.innerHTML=shown?html:`<div class="empty"><div class="ei">🔍</div><h3>موردی پیدا نشد</h3></div>`;
}

function globalChkTodo(examId,subj,ti,done){
  const exam=S.exams.find(e=>e.id===examId);
  if(!exam||!exam.subjects?.[subj]?.todos)return;
  exam.subjects[subj].todos[ti].done=done;
  saveS();renderTodos();
}

// ════════════════════════════════════════════════════════
// NOTES — جمع‌آوری یادداشت‌ها به تفکیک درس
// ════════════════════════════════════════════════════════
function populateNotesFilter(){
  const sel=document.getElementById('notes-subj-filter');
  if(!sel)return;
  sel.innerHTML=`<option value="all">همه دروس</option>`+S.subjects.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
}

function renderNotes(){
  const wrap=document.getElementById('notes-wrap');
  const subjFilter=document.getElementById('notes-subj-filter')?.value||'all';
  if(!wrap)return;

  // collect notes per subject from exams
  const notesBySubj={};
  S.subjects.forEach(s=>{notesBySubj[s]=[];});

  S.exams.forEach(exam=>{
    S.subjects.forEach(s=>{
      const sd=exam.subjects?.[s];
      if(sd?.notes && sd.notes.trim()){
        if(!notesBySubj[s])notesBySubj[s]=[];
        notesBySubj[s].push({examId:exam.id,examName:exam.name,examDate:exam.date,note:sd.notes,subj:s});
      }
    });
    // also collect _pbNotes if present (پاسخبرگ مستقل)
    if(exam._pbNotes?.note && exam._pbNotes.note.trim()){
      const k='__general__';
      if(!notesBySubj[k])notesBySubj[k]=[];
      notesBySubj[k].push({examId:exam.id,examName:exam.name,examDate:exam.date,note:exam._pbNotes.note,subj:'یادداشت کلی'});
    }
    // per-subject notes from _pbNotes
    if(exam._pbNotes?.bySubj){
      Object.entries(exam._pbNotes.bySubj).forEach(([s,data])=>{
        if(data.note&&data.note.trim()){
          if(!notesBySubj[s])notesBySubj[s]=[];
          notesBySubj[s].push({examId:exam.id,examName:exam.name,examDate:exam.date,note:data.note,subj:s});
        }
      });
    }
  });

  const allSubjs=subjFilter==='all'?[...S.subjects,'__general__']:[subjFilter];
  let html='',hasAny=false;

  allSubjs.forEach(s=>{
    const items=(notesBySubj[s]||[]);
    if(!items.length)return;
    hasAny=true;
    const i=S.subjects.indexOf(s);
    const clr=s==='__general__'?'#888':CLR[(i>=0?i:0)%CLR.length];
    const label=s==='__general__'?'📝 یادداشت‌های کلی پاسخبرگ':s;
    html+=`<div style="margin-bottom:26px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
        <span class="dot" style="background:${clr};width:11px;height:11px;box-shadow:0 0 8px ${clr}66"></span>
        <span style="font-size:17px;font-weight:800;color:${clr}">${esc(label)}</span>
        <span class="bdg by">${pN(items.length)} یادداشت</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px">`;
    items.forEach(n=>{
      html+=`<div class="card card-hover" style="padding:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--bdr)">
          <span style="font-size:12px;font-weight:700;color:var(--acc)">${esc(n.examName)}</span>
          <span style="font-size:10px;color:var(--txt3);font-weight:600">${n.examDate}</span>
        </div>
        <p style="font-size:13px;color:var(--txt2);line-height:1.65;white-space:pre-wrap">${esc(n.note)}</p>
      </div>`;
    });
    html+=`</div></div>`;
  });

  wrap.innerHTML=hasAny?html:`<div class="empty"><div class="ei">📓</div><h3>یادداشتی ثبت نشده</h3><p>از طریق ویرایش آزمون یا نتایج پاسخبرگ یادداشت اضافه کنید</p></div>`;
}

// ════════════════════════════════════════════════════════
// CHARTS
// ════════════════════════════════════════════════════════
function populateSubjSel(){
  document.getElementById('subj-sel').innerHTML=S.subjects.map((s,i)=>`<option value="${i}">${esc(s)}</option>`).join('');
}

function getCSSVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}

function noData(ctx,W,H){
  ctx.fillStyle=getCSSVar('--chart-lbl')||'#888';
  ctx.font='13px Vazirmatn,sans-serif';ctx.textAlign='center';
  ctx.fillText('داده کافی وجود ندارد',W/2,H/2);
}

function lineChart(ctx,W,H,labels,data,color){
  const pad={top:28,right:22,bottom:48,left:52};
  const cW=W-pad.left-pad.right,cH=H-pad.top-pad.bottom;
  const vs=data.filter(v=>v!=null&&!isNaN(v));
  if(!vs.length)return;
  const mn=Math.min(...vs,-5),mx=Math.max(...vs,100),rng=mx-mn||1;
  const gridClr=getCSSVar('--chart-grid')||'#eee';
  const lblClr=getCSSVar('--chart-lbl')||'#888';
  const dotClr=getCSSVar('--chart-dot')||'#fff';

  // grid lines
  for(let i=0;i<=5;i++){
    const y=pad.top+(cH/5)*i;
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cW,y);ctx.stroke();
    ctx.fillStyle=lblClr;ctx.font='10px Vazirmatn,sans-serif';ctx.textAlign='right';
    ctx.fillText((mx-(rng/5)*i).toFixed(0)+'%',pad.left-6,y+4);
  }
  // x labels
  ctx.fillStyle=lblClr;ctx.textAlign='center';ctx.font='10px Vazirmatn,sans-serif';
  labels.forEach((l,i)=>{
    const x=pad.left+(labels.length>1?(cW/(labels.length-1))*i:cW/2);
    ctx.fillText(l,x,H-pad.bottom+14);
  });

  const pts=data.map((v,i)=>({
    x:pad.left+(labels.length>1?(cW/(labels.length-1))*i:cW/2),
    y:v!=null&&!isNaN(v)?pad.top+cH-((v-mn)/rng)*cH:null
  }));
  const valid=pts.filter(p=>p.y!=null);
  if(valid.length<2)return;

  // gradient fill
  ctx.beginPath();let st=false;
  pts.forEach(p=>{if(p.y==null){st=false;return;}if(!st){ctx.moveTo(p.x,p.y);st=true;}else ctx.lineTo(p.x,p.y);});
  ctx.lineTo(valid[valid.length-1].x,pad.top+cH);ctx.lineTo(valid[0].x,pad.top+cH);ctx.closePath();
  const g=ctx.createLinearGradient(0,pad.top,0,pad.top+cH);
  g.addColorStop(0,color+'55');g.addColorStop(1,color+'00');
  ctx.fillStyle=g;ctx.fill();

  // line
  ctx.beginPath();st=false;
  pts.forEach(p=>{if(p.y==null){st=false;return;}if(!st){ctx.moveTo(p.x,p.y);st=true;}else ctx.lineTo(p.x,p.y);});
  ctx.strokeStyle=color;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.lineCap='round';ctx.stroke();

  // dots + labels
  pts.forEach((p,pi)=>{
    if(p.y==null||data[pi]==null)return;
    // outer dot
    ctx.beginPath();ctx.arc(p.x,p.y,5.5,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();
    // inner dot
    ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle=dotClr;ctx.fill();
    // value label
    ctx.fillStyle=color;ctx.font='bold 10px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText(data[pi].toFixed(1)+'%',p.x,p.y-10);
  });
}

function drawMiniChart(){
  const c=document.getElementById('c-mini');const ctx=c.getContext('2d');
  c.width=c.offsetWidth||600;ctx.clearRect(0,0,c.width,c.height);
  const last=S.exams.slice(-6);
  if(last.length<2){noData(ctx,c.width,c.height);return;}
  lineChart(ctx,c.width,c.height,last.map(e=>e.date.slice(5)),last.map(e=>examTotal(e)),getCSSVar('--acc'));
}
function drawTotalChart(){
  const c=document.getElementById('c-total');const ctx=c.getContext('2d');
  c.width=c.offsetWidth||700;ctx.clearRect(0,0,c.width,c.height);
  if(S.exams.length<2){noData(ctx,c.width,c.height);return;}
  lineChart(ctx,c.width,c.height,S.exams.map(e=>e.date.slice(5)),S.exams.map(e=>examTotal(e)),getCSSVar('--acc'));
}
function drawSubjChart(){
  const i=parseInt(document.getElementById('subj-sel').value)||0;
  const s=S.subjects[i];
  const c=document.getElementById('c-subj');const ctx=c.getContext('2d');
  c.width=c.offsetWidth||700;ctx.clearRect(0,0,c.width,c.height);
  const exs=S.exams.filter(e=>e.subjects?.[s]?.pct!=null);
  if(exs.length<2){noData(ctx,c.width,c.height);return;}
  lineChart(ctx,c.width,c.height,exs.map(e=>e.date.slice(5)),exs.map(e=>e.subjects[s].pct),CLR[i%CLR.length]);
}

function drawSpiderChart(){
  const canvas=document.getElementById('c-spider');
  const emptyEl=document.getElementById('c-spider-empty');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');

  // build average per subject across ALL exams (including single-subject)
  const subjectData=S.subjects.map((s,i)=>{
    const vals=S.exams.map(e=>e.subjects?.[s]?.pct).filter(v=>v!=null&&!isNaN(v));
    return{subj:s,idx:i,avg:vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:null,count:vals.length};
  }).filter(d=>d.avg!=null);

  canvas.width=canvas.offsetWidth||500;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(subjectData.length<3){
    if(emptyEl){emptyEl.style.display='block';canvas.style.display='none';}
    return;
  }
  if(emptyEl){emptyEl.style.display='none';canvas.style.display='block';}

  const W=canvas.width,H=canvas.height;
  const cx=W/2,cy=H/2;
  const R=Math.min(W,H)/2-68;
  const n=subjectData.length;
  const css=getComputedStyle(document.documentElement);
  const accClr=getCSSVar('--acc');
  const gridClr=getCSSVar('--chart-grid');
  const lblClr=getCSSVar('--chart-lbl');

  // grid rings
  const levels=5;
  for(let l=1;l<=levels;l++){
    const r=R*(l/levels);
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const a=(i/n)*Math.PI*2-Math.PI/2;
      const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;ctx.stroke();
    // pct label on top axis
    ctx.fillStyle=lblClr;ctx.font='9px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText(Math.round(l/levels*100)+'%',cx+2,cy-r-3);
  }
  // axes
  for(let i=0;i<n;i++){
    const a=(i/n)*Math.PI*2-Math.PI/2;
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R*Math.cos(a),cy+R*Math.sin(a));
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;ctx.stroke();
  }

  // data polygon
  ctx.beginPath();
  subjectData.forEach((d,i)=>{
    const a=(i/n)*Math.PI*2-Math.PI/2;
    const r=R*(Math.max(0,Math.min(100,d.avg))/100);
    i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
  });
  ctx.closePath();
  ctx.fillStyle=accClr+'28';ctx.fill();
  ctx.strokeStyle=accClr;ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.stroke();

  // dots + value labels + subject labels
  subjectData.forEach((d,i)=>{
    const a=(i/n)*Math.PI*2-Math.PI/2;
    const pct=Math.max(0,Math.min(100,d.avg));
    const r=R*(pct/100);
    const dx=cx+r*Math.cos(a),dy=cy+r*Math.sin(a);
    const clr=CLR[d.idx%CLR.length];

    // dot
    ctx.beginPath();ctx.arc(dx,dy,5.5,0,Math.PI*2);ctx.fillStyle=accClr;ctx.fill();
    ctx.beginPath();ctx.arc(dx,dy,3,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();

    // value label near dot
    const vx=cx+(r+16)*Math.cos(a),vy=cy+(r+16)*Math.sin(a);
    ctx.fillStyle=accClr;ctx.font='bold 10px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText(pct.toFixed(1)+'%',vx,vy+3);

    // subject label on axis tip
    const lx=cx+(R+42)*Math.cos(a),ly=cy+(R+42)*Math.sin(a);
    const name=d.subj.length>7?d.subj.slice(0,7)+'…':d.subj;
    ctx.fillStyle=clr;ctx.font='bold 11px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText(name,lx,ly+4);
    // count label
    ctx.fillStyle=lblClr;ctx.font='9px Vazirmatn,sans-serif';
    ctx.fillText('('+pN(d.count)+')',lx,ly+15);
  });
}

// ════════════════════════════════════════════════════════
// QUESTIONS
// ════════════════════════════════════════════════════════
let qImgs=[];

function openAddQ(){
  qImgs=[];
  document.getElementById('q-subj').innerHTML=S.subjects.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
  document.getElementById('q-exam').innerHTML=`<option value="">— بدون آزمون —</option>`+
    [...S.exams].reverse().map(e=>`<option value="${e.id}">${esc(e.name)} (${e.date})</option>`).join('');
  document.getElementById('q-note').value='';
  renderQGrid();
  document.getElementById('m-qadd').style.display='flex';
}

function renderQGrid(){
  const grid=document.getElementById('q-grid');
  grid.innerHTML=qImgs.map((src,i)=>`
    <div class="img-thumb">
      <img src="${src}" style="cursor:pointer" onclick="openFS(${i})">
      <button class="rm" onclick="removeQImg(${i})">✕</button>
      <div class="num">${pN(i+1)}</div>
    </div>`).join('')+
    `<div class="add-thumb" onclick="document.getElementById('q-file').click()"><span style="font-size:24px">+</span><span>افزودن</span></div>`;
}
function removeQImg(i){qImgs.splice(i,1);renderQGrid();}
function readFile(file){return new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});}
async function onQFile(e){
  for(const f of Array.from(e.target.files).filter(f=>f.type.startsWith('image/'))){
    qImgs.push(await readFile(f));
  }
  renderQGrid();e.target.value='';
}
async function onQDrop(e){
  e.preventDefault();e.currentTarget.classList.remove('over');
  for(const f of Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'))){
    qImgs.push(await readFile(f));
  }
  renderQGrid();
}
function saveQ(){
  if(!qImgs.length){alert('لطفاً حداقل یک تصویر اضافه کن');return;}
  const subj=document.getElementById('q-subj').value;
  const examId=document.getElementById('q-exam').value;
  const note=document.getElementById('q-note').value.trim();
  const exam=examId?S.exams.find(e=>e.id===examId):null;
  const qs=loadQs();
  qs.push({id:Date.now().toString(),subj,examId,examName:exam?exam.name:'',examDate:exam?exam.date:'',note,imgs:[...qImgs],date:todayJ(),reviews:0});
  saveQs(qs);closeM('m-qadd');renderQs();
}
function deleteQ(id){
  if(!confirm('این سوال حذف شود؟'))return;
  saveQs(loadQs().filter(q=>q.id!==id));renderQs();
}
function addReview(id,event){
  event.stopPropagation();
  const qs=loadQs();const q=qs.find(q=>q.id===id);if(!q)return;
  q.reviews=(q.reviews||0)+1;saveQs(qs);
  document.querySelectorAll('.rv-'+id).forEach(el=>{
    el.textContent='🔁 '+pN(q.reviews);el.className='rev-btn has rv-'+id;
  });
}

function viewQ(id){
  const q=loadQs().find(q=>q.id===id);if(!q)return;
  const imgs=q.imgs||(q.img?[q.img]:[]);
  const rev=q.reviews||0;
  document.getElementById('m-qview-ttl').textContent=`🖼️ ${esc(q.subj)}${q.examName?' — '+esc(q.examName):''}`;
  fsContext=imgs;
  document.getElementById('m-qview-body').innerHTML=`
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
      <span class="bdg by">${esc(q.subj)}</span>
      ${q.examName?`<span class="bdg bb">${esc(q.examName)} — ${q.examDate}</span>`:''}
      <span style="font-size:11px;color:var(--txt3)">ثبت: ${q.date}</span>
      <span class="bdg" style="background:var(--sur2);color:var(--txt2)">${pN(imgs.length)} تصویر</span>
      <span class="rev-btn ${rev>0?'has':''} rv-${q.id}">${rev>0?'🔁 '+pN(rev):'🔁 ۰'}</span>
      <button onclick="addReview('${q.id}',event)" class="btn bp bsm">+ مرور کردم</button>
    </div>
    ${q.note?`<div style="background:var(--sur2);border-radius:var(--rs);padding:12px;font-size:13px;color:var(--txt2);margin-bottom:16px;border:1px solid var(--bdr)">📝 ${esc(q.note)}</div>`:''}
    <div style="display:flex;flex-direction:column;gap:16px">
      ${imgs.map((src,i)=>`
        <div>
          <div style="font-size:11px;color:var(--txt3);margin-bottom:6px;display:flex;align-items:center;gap:8px;font-weight:700">
            <span>${i===0?'📄 سوال':i===imgs.length-1&&imgs.length>1?'✅ پاسخ':'📎 تصویر '+pN(i+1)}</span>
            <button onclick="openFS(${i})" style="background:var(--sur2);border:1px solid var(--bdr);border-radius:7px;padding:3px 10px;font-size:10px;cursor:pointer;color:var(--txt3);font-family:Vazirmatn,sans-serif;font-weight:700;transition:.2s">⛶ فول‌اسکرین</button>
          </div>
          <img src="${src}" style="width:100%;border-radius:var(--rs);border:1px solid var(--bdr);display:block;cursor:zoom-in" onclick="openFS(${i})">
        </div>`).join('')}
    </div>`;
  document.getElementById('m-qview').style.display='flex';
}

function populateQFilters(){
  document.getElementById('qf-subj').innerHTML=`<option value="all">همه دروس</option>`+S.subjects.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('');
  document.getElementById('qf-exam').innerHTML=`<option value="all">همه آزمون‌ها</option>`+[...S.exams].reverse().map(e=>`<option value="${e.id}">${esc(e.name)}</option>`).join('');
}

function renderQs(){
  const wrap=document.getElementById('q-wrap');
  let qs=loadQs();
  const fs=document.getElementById('qf-subj')?.value||'all';
  const fe=document.getElementById('qf-exam')?.value||'all';
  const fsort=document.getElementById('qf-sort')?.value||'date-new';
  const frev=document.getElementById('qf-rev')?.value||'all';
  if(fs!=='all')qs=qs.filter(q=>q.subj===fs);
  if(fe!=='all')qs=qs.filter(q=>q.examId===fe);
  // review count filter
  if(frev==='0')qs=qs.filter(q=>(q.reviews||0)===0);
  else if(frev==='1-3')qs=qs.filter(q=>{const r=q.reviews||0;return r>=1&&r<=3;});
  else if(frev==='4+')qs=qs.filter(q=>(q.reviews||0)>=4);
  // sort
  if(fsort==='date-old')qs=[...qs]; // already oldest first from storage
  else if(fsort==='date-new')qs=[...qs].reverse();
  else if(fsort==='rev-most')qs=[...qs].sort((a,b)=>(b.reviews||0)-(a.reviews||0));
  else if(fsort==='rev-least')qs=[...qs].sort((a,b)=>(a.reviews||0)-(b.reviews||0));

  if(!qs.length){wrap.innerHTML=`<div class="empty"><div class="ei">🖼️</div><h3>سوالی ثبت نشده</h3><p>اسکرین‌شات سوالات منتخب را اینجا آپلود کن</p></div>`;return;}

  // group by subject
  const grouped={};
  S.subjects.forEach(s=>{grouped[s]={};});
  qs.forEach(q=>{
    if(!grouped[q.subj])grouped[q.subj]={};
    const k=q.examId||'__none__';
    if(!grouped[q.subj][k])grouped[q.subj][k]={name:q.examName||'بدون آزمون',date:q.examDate||'',items:[]};
    grouped[q.subj][k].items.push(q);
  });

  // if sorting by reviews, sort within each exam group too
  const sortItems=items=>{
    if(fsort==='rev-most')return[...items].sort((a,b)=>(b.reviews||0)-(a.reviews||0));
    if(fsort==='rev-least')return[...items].sort((a,b)=>(a.reviews||0)-(b.reviews||0));
    if(fsort==='date-old')return[...items];
    return[...items].reverse();
  };

  let html='';
  Object.entries(grouped).forEach(([subj,exams])=>{
    const total=Object.values(exams).reduce((a,ex)=>a+ex.items.length,0);
    if(!total)return;
    const si=S.subjects.indexOf(subj);
    const clr=CLR[(si>=0?si:0)%CLR.length];
    // total reviews for this subject
    const totalRevs=Object.values(exams).reduce((a,ex)=>a+ex.items.reduce((b,q)=>b+(q.reviews||0),0),0);
    html+=`<div style="margin-bottom:30px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
        <span class="dot" style="background:${clr};width:12px;height:12px;box-shadow:0 0 10px ${clr}66"></span>
        <span style="font-size:18px;font-weight:800;color:${clr}">${esc(subj)}</span>
        <span class="bdg by">${pN(total)} سوال</span>
        <span class="bdg" style="background:var(--acc-d);color:var(--acc);border-color:rgba(99,91,255,.2)">🔁 ${pN(totalRevs)} مرور</span>
      </div>`;
    Object.values(exams).forEach(exg=>{
      const sortedItems=sortItems(exg.items);
      html+=`<div style="margin-bottom:20px">
        <div style="font-size:12px;color:var(--txt3);margin-bottom:12px;font-weight:700">
          <span style="background:var(--sur3);padding:4px 12px;border-radius:7px;border:1px solid var(--bdr)">📝 ${esc(exg.name)}${exg.date?' — '+exg.date:''}</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px">`;
      sortedItems.forEach(q=>{
        const imgs=q.imgs||(q.img?[q.img]:[]);
        const thumb=imgs[0]||'';const rev=q.reviews||0;
        html+=`<div class="qcard" onclick="viewQ('${q.id}')">
          <div style="position:relative">
            <img class="qcard-img" src="${thumb}" alt="">
            ${imgs.length>1?`<span style="position:absolute;top:7px;left:7px;background:rgba(0,0,0,.7);color:#fff;font-size:10px;padding:2px 8px;border-radius:7px;font-weight:700;backdrop-filter:blur(4px)">${pN(imgs.length)} تصویر</span>`:''}
            ${rev>0?`<span style="position:absolute;bottom:7px;right:7px;background:rgba(99,91,255,.85);color:#fff;font-size:10px;padding:2px 8px;border-radius:7px;font-weight:700">🔁 ${pN(rev)}</span>`:''}
          </div>
          <div class="qcard-body">
            ${q.note?`<div style="font-size:11px;color:var(--txt2);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(q.note)}</div>`:''}
            <div style="display:flex;align-items:center;justify-content:space-between;gap:6px">
              <button class="rev-btn ${rev>0?'has':''} rv-${q.id}" onclick="addReview('${q.id}',event)">🔁 ${rev>0?pN(rev)+' مرور':'مرور'}</button>
              <button class="btn bd bxs" onclick="event.stopPropagation();deleteQ('${q.id}')">🗑️</button>
            </div>
          </div>
        </div>`;
      });
      html+=`</div></div>`;
    });
    html+=`</div>`;
  });
  wrap.innerHTML=html||`<div class="empty"><div class="ei">🔍</div><h3>موردی پیدا نشد</h3></div>`;
}

// ════════════════════════════════════════════════════════
// FULLSCREEN
// ════════════════════════════════════════════════════════
let fsContext=[],fsIdx=0;
function openFS(idx){
  fsIdx=idx;
  document.getElementById('fso').style.display='flex';
  updateFS();
  const show=fsContext.length>1;
  document.getElementById('fso-prev').style.display=show?'flex':'none';
  document.getElementById('fso-next').style.display=show?'flex':'none';
}
function updateFS(){
  document.getElementById('fso-img').src=fsContext[fsIdx];
  document.getElementById('fso-count').textContent=fsContext.length>1?`${pN(fsIdx+1)} / ${pN(fsContext.length)}`:'';
}
function fsNav(dir){fsIdx=(fsIdx+dir+fsContext.length)%fsContext.length;updateFS();}
function closeFS(){document.getElementById('fso').style.display='none';}

// ════════════════════════════════════════════════════════
// SUBJECT MANAGER
// ════════════════════════════════════════════════════════
function openSubjMgr(){renderSubjMgrList();document.getElementById('m-subj').style.display='flex';}
function renderSubjMgrList(){
  document.getElementById('subj-mgr-list').innerHTML=S.subjects.map((s,i)=>`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px 12px;background:var(--sur2);border-radius:var(--rs);border:1px solid var(--bdr)">
      <span class="dot" style="background:${CLR[i%CLR.length]};box-shadow:0 0 8px ${CLR[i%CLR.length]}55;width:10px;height:10px"></span>
      <span style="flex:1;font-size:13px;font-weight:600">${esc(s)}</span>
      <button class="btn bd bxs" onclick="rmSubjItem(${i})">حذف</button>
    </div>`).join('');
}
function rmSubjItem(i){S.subjects.splice(i,1);renderSubjMgrList();}
function addSubjItem(){
  const inp=document.getElementById('new-subj-inp');const n=inp.value.trim();if(!n)return;
  if(S.subjects.includes(n)){alert('این درس قبلاً وجود دارد');return;}
  S.subjects.push(n);inp.value='';renderSubjMgrList();
}
function saveSubjs(){saveS();closeM('m-subj');populateSubjSel();refresh();}

// ════════════════════════════════════════════════════════
// SETTINGS
// ════════════════════════════════════════════════════════
function changeField(){
  const f=document.getElementById('field-sel').value;
  if(confirm('دروس با دروس پیش‌فرض این رشته جایگزین می‌شوند. ادامه می‌دهی؟')){
    S.field=f;S.subjects=[...FIELDS[f]];saveS();populateSubjSel();refresh();
  }
}
function exportData(){
  loadQsAsync().then(qs=>{
    const blob=new Blob([JSON.stringify({exams:S.exams,subjects:S.subjects,gz:S.gz,questions:qs},null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='azmooneto-backup.json';a.click();
  });
}
function exportCSV(){
  if(!S.gz.length){alert('هنوز گزارشی ثبت نشده');return;}
  var subjs=getGzSubjects();
  var headers=['تاریخ','حال','یادداشت','هدف فردا','کل ساعت','کل تست'].concat(
    subjs.map(function(s){return s+' (ساعت)';}),
    subjs.map(function(s){return s+' (تست)';})
  );
  var GZ_M={5:'عالی',4:'خوب',3:'معمولی',2:'خسته',1:'ضعیف'};
  var rows=S.gz.slice().sort(function(a,b){return a.date>b.date?1:-1;}).map(function(g){
    var totalH=Object.values(g.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0);
    var totalT=Object.values(g.subjects||{}).reduce(function(a,v){return a+(v.tests||0);},0);
    var row=[g.date,g.mood?GZ_M[g.mood]:'',g.note||'',g.goal||'',totalH.toFixed(2),totalT];
    subjs.forEach(function(s){row.push(g.subjects&&g.subjects[s]?(g.subjects[s].hours||0).toFixed(2):'0');});
    subjs.forEach(function(s){row.push(g.subjects&&g.subjects[s]?(g.subjects[s].tests||0):'0');});
    return row.map(function(c){return '"'+String(c).replace(/"/g,'""')+'"';});
  });
  var csv='\uFEFF'+[headers.map(function(h){return'"'+h+'"';}).join(',')].concat(rows.map(function(r){return r.join(',');})).join('\n');
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='azmooneto-gozaresh.csv';a.click();
}
function importData(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(d.exams)S.exams=d.exams;
      if(d.subjects)S.subjects=d.subjects;
      if(d.gz)S.gz=d.gz;
      if(d.questions)saveQs(d.questions);
      saveS();refresh();populateSubjSel();
      alert('داده‌ها با موفقیت وارد شد ✓');
    }catch{alert('فایل معتبر نیست');}
  };
  r.readAsText(file);e.target.value='';
}
function clearAll(){
  if(!confirm('همه داده‌ها حذف می‌شود؟'))return;
  S.exams=[];saveS();refresh();
}

// ════════════════════════════════════════════════════════
// THEME SWITCHER
// ════════════════════════════════════════════════════════
function updateThemeBadges(t){
  ['pro','glass','ember','aurora'].forEach(function(id){
    var el=document.getElementById('tcb-'+id);
    if(el)el.textContent=t===id?'● فعال':'● انتخاب';
  });
}

function setTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem('az_theme',t);
  ['pro','glass','ember','aurora'].forEach(function(id){
    var el=document.getElementById('tc-'+id);
    if(el)el.classList.toggle('active',t===id);
  });
  updateThemeBadges(t);
  var metaTheme={pro:'#0F1629',glass:'#04050D',ember:'#0C0A0A',aurora:'#050C12'};
  document.querySelector('meta[name="theme-color"]').content=metaTheme[t]||'#0F1629';
  // redraw charts
  setTimeout(()=>{
    if(document.getElementById('sec-dashboard').classList.contains('active'))drawMiniChart();
    if(document.getElementById('sec-charts').classList.contains('active')){drawTotalChart();drawSubjChart();}
  },120);
}

// ════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════
window.addEventListener('load',()=>{
  // sync theme cards with saved theme
  const t=document.documentElement.getAttribute('data-theme')||'pro';
  ['pro','glass','ember','aurora'].forEach(function(id){
    var el=document.getElementById('tc-'+id);
    if(el)el.classList.toggle('active',t===id);
  });
  updateThemeBadges(t);

  // بارگذاری سوالات از IndexedDB (شامل migrate از localStorage)
  loadQsAsync().then(()=>{
    populateSubjSel();refresh();
  });

  // Ctrl+V paste for question modal AND pasakhbarg inline Q
  document.addEventListener('paste',async e=>{
    // Check if we're in the questions add modal
    if(document.getElementById('m-qadd').style.display!=='none'){
      for(const item of Array.from(e.clipboardData.items)){
        if(item.type.startsWith('image/'))qImgs.push(await readFile(item.getAsFile()));
      }
      renderQGrid();
      return;
    }
    // Check if we're in pasakhbarg results with an active qs tab
    if(_pbActiveQSubj&&_pbActiveQSubj.idx!==null&&document.getElementById('sec-pasakhbarg').classList.contains('active')){
      for(const item of Array.from(e.clipboardData.items)){
        if(item.type.startsWith('image/')){
          await pbPasteInlineQ(item.getAsFile());
        }
      }
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown',e=>{
    if(document.getElementById('fso').style.display==='flex'){
      if(e.key==='Escape')closeFS();
      if(e.key==='ArrowRight')fsNav(-1);
      if(e.key==='ArrowLeft')fsNav(1);
    }
  });

  // Chart resize
  let resizeTimer;
  window.addEventListener('resize',()=>{
    clearTimeout(resizeTimer);
    resizeTimer=setTimeout(()=>{
      if(document.getElementById('sec-dashboard').classList.contains('active'))drawMiniChart();
      if(document.getElementById('sec-charts').classList.contains('active')){drawTotalChart();drawSubjChart();drawSpiderChart();}
    },200);
  });
});

// ════════════════════════════════════════════════════════
// PASAKHBARG — پاسخبرگ
// ════════════════════════════════════════════════════════

let PB={
  config:[],      // [{subj,idx,nums:[]}]
  answers:{},     // {num:{val:1|2|3|4|null, late:bool}}
  key:{},         // {num:1|2|3|4|null}
  flags:{},       // {num:{time:bool, doubt:bool, doubtOpts:[]}}
  timerMin:60, timerTotal:0, timeLeft:0,
  timesUp:false, timerInterval:null,
  linkedExamId:null, isNewExam:false, phase:'setup'
};

// ── مرحله ۱: تنظیمات ──────────────────────────────────
function pbInitSetup(){
  const tbody=document.getElementById('pb-subj-tbody');
  tbody.innerHTML=S.subjects.map((s,i)=>{
    const clr=CLR[i%CLR.length];
    return`<tr>
      <td><input type="checkbox" id="pb-chk-${i}" checked style="accent-color:${clr};width:16px;height:16px;cursor:pointer"></td>
      <td><span style="font-weight:700;color:${clr}">${esc(s)}</span></td>
      <td><input type="number" id="pb-cnt-${i}" value="30" min="1" max="9999" class="pb-nf" style="width:72px"></td>
      <td>
        <select id="pb-mode-${i}" class="pb-ni" onchange="pbModeChange(${i})">
          <option value="seq">ترتیبی</option>
          <option value="rand">تصادفی از بازه</option>
        </select>
      </td>
      <td id="pb-params-${i}" style="white-space:nowrap">
        <span style="font-size:11px;color:var(--txt3)">از سوال</span>
        <input type="number" id="pb-from-${i}" value="${i*100+1}" min="1" class="pb-nf">
        <span style="font-size:11px;color:var(--txt3)">فاصله</span>
        <input type="number" id="pb-step-${i}" value="1" min="1" class="pb-nf">
      </td>
    </tr>`;
  }).join('');

  // exam dropdown
  const sel=document.getElementById('pb-link-exam');
  sel.innerHTML=`<option value="">— مستقل —</option><option value="__new__">➕ ایجاد آزمون جدید</option>`+
    [...S.exams].reverse().map(e=>`<option value="${e.id}">${esc(e.name)} (${e.date})</option>`).join('');

  // set default date for new exam
  document.getElementById('pb-new-exam-date').value=todayJ();
  document.getElementById('pb-new-exam-wrap').style.display='none';

  pbShowStage('setup');
}

function pbLinkExamChange(){
  const val=document.getElementById('pb-link-exam').value;
  document.getElementById('pb-new-exam-wrap').style.display=val==='__new__'?'block':'none';
  const hint=document.getElementById('pb-link-hint');
  if(val==='__new__')hint.textContent='یک آزمون جدید مستقل ایجاد و نتیجه در آن ذخیره می‌شود';
  else if(val)hint.textContent='نتیجه قابل ذخیره در این آزمون است';
  else hint.textContent='نتیجه فقط نمایش داده می‌شود، ذخیره نمی‌شود';
}

function pbModeChange(i){
  const mode=document.getElementById('pb-mode-'+i).value;
  const prevFrom=document.getElementById('pb-from-'+i)?.value||(i*100+1);
  const cell=document.getElementById('pb-params-'+i);
  if(mode==='seq'){
    cell.innerHTML=`
      <span style="font-size:11px;color:var(--txt3)">از سوال</span>
      <input type="number" id="pb-from-${i}" value="${prevFrom}" min="1" class="pb-nf">
      <span style="font-size:11px;color:var(--txt3)">فاصله</span>
      <input type="number" id="pb-step-${i}" value="1" min="1" class="pb-nf">`;
  }else{
    const to=parseInt(prevFrom)+100;
    cell.innerHTML=`
      <span style="font-size:11px;color:var(--txt3)">از</span>
      <input type="number" id="pb-from-${i}" value="${prevFrom}" min="1" class="pb-nf">
      <span style="font-size:11px;color:var(--txt3)">تا</span>
      <input type="number" id="pb-to-${i}" value="${to}" min="1" class="pb-nf">
      <span style="font-size:11px;color:var(--txt3)">انتخاب</span>
      <input type="number" id="pb-cnt-${i}" value="20" min="1" class="pb-nf" style="width:56px">
      <span style="font-size:11px;color:var(--txt3)">تصادفی</span>`;
  }
}

function pbGenNums(mode,from,to,step,count){
  from=parseInt(from)||1; count=parseInt(count)||1;
  if(mode==='seq'){
    step=Math.max(1,parseInt(step)||1);
    return Array.from({length:count},(_,k)=>from+k*step);
  }else{
    to=parseInt(to)||(from+100);
    const pool=[];for(let n=from;n<=to;n++)pool.push(n);
    for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
    return pool.slice(0,Math.min(count,pool.length)).sort((a,b)=>a-b);
  }
}

function pbStartExam(){
  PB.config=[];PB.answers={};PB.key={};PB.flags={};PB.timesUp=false;

  S.subjects.forEach((s,i)=>{
    if(!document.getElementById('pb-chk-'+i)?.checked)return;
    const mode=document.getElementById('pb-mode-'+i)?.value||'seq';
    const count=parseInt(document.getElementById('pb-cnt-'+i)?.value)||30;
    const from=document.getElementById('pb-from-'+i)?.value||(i*100+1);
    const step=document.getElementById('pb-step-'+i)?.value||1;
    const to=document.getElementById('pb-to-'+i)?.value||(parseInt(from)+100);
    const nums=pbGenNums(mode,from,to,step,count);
    if(!nums.length)return;
    PB.config.push({subj:s,idx:i,nums,mode});
  });

  if(!PB.config.length){alert('لطفاً حداقل یک درس انتخاب کن');return;}

  // init answers and flags
  PB.config.forEach(cfg=>cfg.nums.forEach(n=>{
    PB.answers[n]={val:null,late:false};
    PB.flags[n]={time:false,doubt:false,doubtOpts:[]};
  }));

  PB.timerMin=parseInt(document.getElementById('pb-timer-min').value)||0;
  const linkVal=document.getElementById('pb-link-exam').value;
  PB.isNewExam=(linkVal==='__new__');
  PB.linkedExamId=(!linkVal||linkVal==='__new__')?null:linkVal;
  PB.timerTotal=PB.timerMin*60;
  PB.timeLeft=PB.timerTotal;
  PB.phase='answer';

  pbShowStage('answer');
  pbRenderAnswer();
  pbStartTimer();
}

function pbShowStage(stage){
  ['setup','answer','key','result'].forEach(s=>{
    document.getElementById('pb-'+s).style.display=s===stage?'block':'none';
  });
}

// ── مرحله ۲: پاسخ‌دهی ─────────────────────────────────
// دروسی که گزینه ثبت شک دقیق دارند
const DOUBT_DETAIL_SUBJS=['زیست‌شناسی','شیمی','زیست','بیولوژی'];
function subjHasDoubtDetail(subjName){
  return DOUBT_DETAIL_SUBJS.some(d=>subjName.includes(d));
}

function pbRenderAnswer(){
  const body=document.getElementById('pb-answer-body');
  let html='';
  PB.config.forEach(cfg=>{
    const clr=CLR[cfg.idx%CLR.length];
    const hasDetail=subjHasDoubtDetail(cfg.subj);
    html+=`<div class="pb-subj-hd" style="background:${clr}20;border:1px solid ${clr}40;color:${clr}">
      <span class="dot" style="background:${clr};width:10px;height:10px;box-shadow:0 0 8px ${clr}66"></span>
      ${esc(cfg.subj)}
      <span style="font-size:11px;font-weight:600;opacity:.75;margin-right:4px">${pN(cfg.nums.length)} سوال</span>
    </div>`;
    cfg.nums.forEach(num=>{
      const doubtDetailHtml=hasDetail?`
        <div class="pb-doubt-opts" id="pb-do-${num}">
          <span style="font-size:10px;color:var(--txt3);font-weight:700">شک روی:</span>
          ${[1,2,3,4].map(v=>`<div class="pb-doubt-opt" id="pb-dopt-${num}-${v}" onclick="pbDoubtOptToggle(${num},${v})">${v}</div>`).join('')}
        </div>`:'';
      html+=`<div class="pb-qrow-wrap">
        <div class="pb-qrow" id="pb-row-${num}">
          <span class="pb-qnum">${pN(num)}</span>
          <div class="pb-circles">
            ${[1,2,3,4].map(v=>`<div class="pb-circle" id="pb-c-${num}-${v}" onclick="pbSelect(${num},${v})">${v}</div>`).join('')}
          </div>
          <div class="pb-flags">
            <button class="pb-flag-btn flag-time" id="pb-ft-${num}" onclick="pbToggleFlag(${num},'time')" title="سوال وقت‌گیر">⏱ وقت‌گیر</button>
            <button class="pb-flag-btn flag-doubt" id="pb-fd-${num}" onclick="pbToggleFlag(${num},'doubt')" title="سوال شک‌دار">❓ شک‌دار</button>
          </div>
        </div>
        ${doubtDetailHtml}
      </div>`;
    });
  });
  body.innerHTML=html;
  pbUpdateLiveInfo();
}

function pbToggleFlag(num,type){
  const f=PB.flags[num];if(!f)return;
  f[type]=!f[type];
  const btn=document.getElementById(`pb-f${type==='time'?'t':'d'}-${num}`);
  if(btn)btn.classList.toggle('active',f[type]);
  // show/hide doubt options panel
  if(type==='doubt'){
    const opts=document.getElementById(`pb-do-${num}`);
    if(opts)opts.classList.toggle('show',f.doubt);
    if(!f.doubt){f.doubtOpts=[];[1,2,3,4].forEach(v=>{const el=document.getElementById(`pb-dopt-${num}-${v}`);if(el)el.classList.remove('sel');});}
  }
}

function pbDoubtOptToggle(num,val){
  const f=PB.flags[num];if(!f)return;
  const idx=f.doubtOpts.indexOf(val);
  if(idx>=0)f.doubtOpts.splice(idx,1);
  else f.doubtOpts.push(val);
  [1,2,3,4].forEach(v=>{
    const el=document.getElementById(`pb-dopt-${num}-${v}`);
    if(el)el.classList.toggle('sel',f.doubtOpts.includes(v));
  });
}

function pbSelect(num,val){
  const ans=PB.answers[num];if(!ans)return;
  ans.val=ans.val===val?null:val;
  ans.late=PB.timesUp;
  // update circles
  [1,2,3,4].forEach(v=>{
    const c=document.getElementById(`pb-c-${num}-${v}`);
    if(c)c.classList.toggle('sel',ans.val===v);
  });
  // update row
  const row=document.getElementById('pb-row-'+num);
  if(row){
    row.classList.remove('answered','answered-late');
    if(ans.val!==null)row.classList.add(ans.late?'answered-late':'answered');
  }
  pbUpdateLiveInfo();
}

function pbUpdateLiveInfo(){
  const allNums=Object.keys(PB.answers);
  const answered=allNums.filter(n=>PB.answers[n].val!==null&&!PB.answers[n].late).length;
  document.getElementById('pb-live-info').textContent=pN(answered)+' / '+pN(allNums.length);
}

// ── تایمر ─────────────────────────────────────────────
function pbStartTimer(){
  if(!PB.timerTotal){
    document.getElementById('pb-timer-wrap').style.display='none';
    return;
  }
  pbRenderTimer();
  PB.timerInterval=setInterval(()=>{
    PB.timeLeft=Math.max(0,PB.timeLeft-1);
    pbRenderTimer();
    if(PB.timeLeft<=0){clearInterval(PB.timerInterval);PB.timesUp=true;pbTimeUp();}
  },1000);
}

function pbRenderTimer(){
  const left=PB.timeLeft;
  const mm=Math.floor(left/60),ss=left%60;
  const disp=document.getElementById('pb-timer-disp');
  const bar=document.getElementById('pb-timer-bar');
  if(!disp)return;
  disp.textContent=pN(mm)+':'+String(ss).padStart(2,'0').replace(/\d/g,d=>'۰۱۲۳۴۵۶۷۸۹'[d]);
  const pct=PB.timerTotal?((left/PB.timerTotal)*100):100;
  bar.style.width=pct+'%';
  if(pct<=20){bar.style.background='var(--P)';disp.className='pb-timer-display danger';}
  else if(pct<=45){bar.style.background='var(--Y)';disp.className='pb-timer-display warning';}
  else{bar.style.background='';disp.className='pb-timer-display';}
}

function pbTimeUp(){
  // هشدار
  const ov=document.createElement('div');
  ov.className='pb-timeup-overlay';
  ov.innerHTML=`<div class="pb-timeup-box">
    <div style="font-size:48px;margin-bottom:14px">⏰</div>
    <div style="font-size:22px;font-weight:900;color:var(--P);margin-bottom:10px">زمان قانونی به پایان رسید</div>
    <div style="font-size:13px;color:var(--txt2);margin-bottom:22px;line-height:1.7">
      می‌توانی به پاسخ‌دهی ادامه دهی،<br>اما پاسخ‌های بعدی در <b>درصد نهایی تأثیر نخواهند داشت</b>.
    </div>
    <button class="btn bp" style="background:var(--P);box-shadow:none;padding:10px 28px" onclick="this.closest('.pb-timeup-overlay').remove()">متوجه شدم</button>
  </div>`;
  document.body.appendChild(ov);
  // تغییر ظاهر تایمر
  const wrap=document.getElementById('pb-timer-wrap');
  if(wrap){wrap.style.borderColor='var(--P)';wrap.style.background='rgba(255,71,87,.07)';}
  const disp=document.getElementById('pb-timer-disp');
  if(disp){disp.textContent='۰۰:۰۰';disp.className='pb-timer-display danger';}
}

function pbGoToKey(){
  clearInterval(PB.timerInterval);
  pbShowStage('key');
  pbRenderKey();
}

// ── مرحله ۳: ورود کلید ────────────────────────────────
function pbRenderKey(){
  const body=document.getElementById('pb-key-body');
  let html='';
  PB.config.forEach(cfg=>{
    const clr=CLR[cfg.idx%CLR.length];
    html+=`<div style="margin-bottom:22px">
      <div class="pb-subj-hd" style="background:${clr}20;border:1px solid ${clr}40;color:${clr}">
        <span class="dot" style="background:${clr};width:10px;height:10px"></span>
        ${esc(cfg.subj)}
      </div>
      <div class="pb-key-grid">`;
    cfg.nums.forEach(num=>{
      const isLate=PB.answers[num]?.late;
      const ansVal=PB.answers[num]?.val;
      const flagF=PB.flags[num];
      const flagBadges=[
        flagF?.time?`<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:var(--Y-d);color:var(--Y);font-weight:700">⏱</span>`:'',
        flagF?.doubt?`<span style="font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(168,85,247,.18);color:var(--V);font-weight:700">❓</span>`:''
      ].join('');
      html+=`<div class="pb-key-row" id="pbkr-${num}">
        <span class="pb-key-num">${pN(num)}${flagBadges}</span>
        ${[1,2,3,4].map(v=>{
          const isSel=ansVal===v;
          // for late answers, show what they selected but in gray
          let cls='pb-key-circ';
          if(isLate&&isSel)cls+=' sel'; // will be overridden after key entry in results
          return`<div class="${cls}" id="pb-k-${num}-${v}" onclick="pbKeySelect(${num},${v})" ${isLate?'style="opacity:.55"':''}>${v}</div>`;
        }).join('')}
        ${isLate?`<span class="pb-late-badge" title="بعد از وقت قانونی پاسخ داده شد">⏰ دیر</span>`:''}
      </div>`;
    });
    html+=`</div></div>`;
  });
  body.innerHTML=html;
  // restore saved key
  Object.entries(PB.key).forEach(([num,val])=>{
    if(val){const el=document.getElementById(`pb-k-${num}-${val}`);if(el)el.classList.add('sel');}
  });
}

function pbKeySelect(num,val){
  PB.key[num]=PB.key[num]===val?null:val;
  [1,2,3,4].forEach(v=>{
    const el=document.getElementById(`pb-k-${num}-${v}`);
    if(el)el.classList.toggle('sel',PB.key[num]===v);
  });
}

// ── مرحله ۴: نتایج ────────────────────────────────────
function pbShowResults(){
  pbShowStage('result');
  pbRenderResults();
  pbInitResultNotes();
}

function pbRenderResults(){
  const body=document.getElementById('pb-result-body');
  let totCor=0,totWrong=0,totUn=0,totLate=0;

  // per-subject calculation
  const subjRes=PB.config.map(cfg=>{
    let cor=0,wr=0,un=0,late=0,lateCor=0,lateWr=0;
    cfg.nums.forEach(num=>{
      const ans=PB.answers[num];const key=PB.key[num];
      if(!ans)return;
      if(ans.late){
        late++;totLate++;
        // still calculate result for late questions (for display only, not percentage)
        if(ans.val===null)lateWr++; // treat unanswered-late same as not answered
        else if(key&&ans.val===key)lateCor++;
        else lateWr++;
        return;
      }
      if(ans.val===null){un++;totUn++;}
      else if(key&&ans.val===key){cor++;totCor++;}
      else{wr++;totWrong++;}
    });
    const tot=cfg.nums.length-late;
    const pct=tot>0?((cor*3-wr)/(tot*3))*100:null;
    return{...cfg,cor,wr,un,late,lateCor,lateWr,pct};
  });

  const inTime=totCor+totWrong+totUn;
  const overallPct=inTime>0?((totCor*3-totWrong)/(inTime*3))*100:null;

  let html='';

  // stats bar
  html+=`<div class="pb-stat-grid">
    <div class="pb-stat-box" style="background:var(--acc-d);border-color:var(--acc)">
      <div class="pb-stat-val" style="color:var(--acc)">${overallPct!=null?overallPct.toFixed(1)+'%':'—'}</div>
      <div class="pb-stat-lbl">درصد کل</div>
    </div>
    <div class="pb-stat-box" style="background:var(--G-d);border-color:var(--G)">
      <div class="pb-stat-val" style="color:var(--G)">${pN(totCor)}</div>
      <div class="pb-stat-lbl">✓ صحیح</div>
    </div>
    <div class="pb-stat-box" style="background:var(--P-d);border-color:var(--P)">
      <div class="pb-stat-val" style="color:var(--P)">${pN(totWrong)}</div>
      <div class="pb-stat-lbl">✗ غلط</div>
    </div>
    <div class="pb-stat-box" style="background:var(--Y-d);border-color:var(--Y)">
      <div class="pb-stat-val" style="color:var(--Y)">${pN(totUn)}</div>
      <div class="pb-stat-lbl">○ نزده</div>
    </div>
  </div>`;

  if(totLate){
    html+=`<div style="font-size:12px;color:#888;background:rgba(100,100,100,.1);border:1px solid #666;border-radius:var(--rs);padding:10px 16px;margin-bottom:16px">
      ⏰ ${pN(totLate)} سوال بعد از اتمام وقت قانونی — در درصد نهایی محاسبه نشد (ولی نتیجه‌شان در کلید نشان داده می‌شود)
    </div>`;
  }

  // legend
  html+=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px">
    <span style="font-size:12px;font-weight:700;background:var(--G-d);color:var(--G);padding:4px 12px;border-radius:7px">🟢 صحیح</span>
    <span style="font-size:12px;font-weight:700;background:var(--P-d);color:var(--P);padding:4px 12px;border-radius:7px">🔴 غلط</span>
    <span style="font-size:12px;font-weight:700;background:var(--Y-d);color:var(--Y);padding:4px 12px;border-radius:7px">🟡 نزده</span>
    <span style="font-size:12px;font-weight:700;background:rgba(100,100,100,.12);color:#888;padding:4px 12px;border-radius:7px">⬛ بعد از وقت (نمایش ولی بی‌تأثیر)</span>
    <span style="font-size:12px;font-weight:700;background:transparent;color:var(--G);border:2px solid var(--G);padding:2px 12px;border-radius:7px">دایره خالی = جواب صحیح</span>
    <span style="font-size:12px;font-weight:700;background:rgba(168,85,247,.15);color:var(--V);padding:4px 12px;border-radius:7px">❓ شک‌دار</span>
    <span style="font-size:12px;font-weight:700;background:var(--Y-d);color:var(--Y);padding:4px 12px;border-radius:7px">⏱ وقت‌گیر</span>
  </div>`;

  // per-subject detail
  subjRes.forEach(sr=>{
    const clr=CLR[sr.idx%CLR.length];
    html+=`<div style="margin-bottom:28px">
      <div class="pb-subj-hd" style="background:${clr}20;border:1px solid ${clr}40;color:${clr}">
        <span class="dot" style="background:${clr};width:10px;height:10px"></span>
        ${esc(sr.subj)}
        <span style="font-size:22px;font-weight:900;margin-right:auto;letter-spacing:-1px">${sr.pct!=null?sr.pct.toFixed(1)+'%':'—'}</span>
        <span style="font-size:11px;font-weight:700;opacity:.8">✓${pN(sr.cor)} ✗${pN(sr.wr)} ○${pN(sr.un)}${sr.late?` ⏰${pN(sr.late)}(✓${pN(sr.lateCor)} ✗${pN(sr.lateWr)})`:''}</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:7px">`;

    sr.nums.forEach(num=>{
      const ans=PB.answers[num];const key=PB.key[num];
      const isLate=ans?.late;
      const flagF=PB.flags[num];

      let rowCls='pb-qrow no-hover ';
      let rowStyle='';
      if(isLate){
        // for late: show correct/wrong with different shade
        if(!ans||ans.val===null)rowCls+='res-late';
        else if(key&&ans.val===key){ rowCls+='res-late'; rowStyle='border-color:var(--G)!important;background:rgba(0,199,129,.07)!important'; }
        else{ rowCls+='res-late'; rowStyle='border-color:var(--P)!important;background:rgba(255,71,87,.07)!important'; }
      }else if(!ans||ans.val===null)rowCls+='res-unanswered';
      else if(key&&ans.val===key)rowCls+='res-correct';
      else rowCls+='res-wrong';

      const circles=[1,2,3,4].map(v=>{
        const isSel=ans?.val===v;
        const isKey=key===v;
        let cls='pb-circle ';
        if(isLate){
          if(isSel&&isKey)cls+='res-late-correct';
          else if(isSel&&!isKey)cls+='res-late-wrong';
          else if(!isSel&&isKey)cls+='res-late-key-mark';
          else cls+='res-blank';
        }else{
          if(isSel&&isKey)cls+='res-correct';
          else if(isSel&&!isKey)cls+='res-wrong';
          else if(!isSel&&isKey)cls+='res-key';
          else cls+='res-blank';
        }
        return`<div class="${cls}">${v}</div>`;
      }).join('');

      const flagBadges=[
        flagF?.time?`<span style="font-size:9px;padding:1px 5px;border-radius:4px;background:var(--Y-d);color:var(--Y);font-weight:700">⏱</span>`:'',
        flagF?.doubt?`<span style="font-size:9px;padding:1px 5px;border-radius:4px;background:rgba(168,85,247,.18);color:var(--V);font-weight:700">❓${flagF.doubtOpts.length?'('+flagF.doubtOpts.join(',')+')'  :''}</span>`:''
      ].filter(Boolean).join(' ');

      html+=`<div class="${rowCls}" ${rowStyle?`style="${rowStyle}"`:''}> 
        <span class="pb-qnum">${pN(num)}${isLate?` <span class="pb-late-badge">⏰ دیر</span>`:''}${flagBadges?` <span>${flagBadges}</span>`:''}</span>
        <div class="pb-circles">${circles}</div>
        ${!key?`<span style="font-size:10px;color:var(--txt3)">بدون کلید</span>`:''}
      </div>`;
    });
    html+=`</div></div>`;
  });

  body.innerHTML=html;

  // save button
  const saveBtn=document.getElementById('pb-save-btn');
  saveBtn.style.display=(PB.linkedExamId||PB.isNewExam)?'inline-flex':'none';

  // doubt analysis
  pbRenderDoubtAnalysis(subjRes);

  // spider chart
  if(subjRes.filter(s=>s.pct!=null).length>=3){
    document.getElementById('pb-spider-wrap').style.display='block';
    setTimeout(()=>pbDrawSpider(subjRes),80);
  } else {
    document.getElementById('pb-spider-wrap').style.display='none';
  }
}

function pbRenderDoubtAnalysis(subjRes){
  // collect all doubt questions per subject
  const hasDoubt=Object.values(PB.flags).some(f=>f.doubt);
  const wrap=document.getElementById('pb-doubt-analysis');
  const statsBody=document.getElementById('pb-doubt-stats-body');
  if(!hasDoubt){wrap.style.display='none';return;}
  wrap.style.display='block';

  let html='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px">';
  PB.config.forEach(cfg=>{
    const doubts=cfg.nums.filter(num=>PB.flags[num]?.doubt);
    if(!doubts.length)return;
    let dCor=0,dWrong=0,dUn=0;
    doubts.forEach(num=>{
      const ans=PB.answers[num]; const key=PB.key[num];
      if(!ans||ans.val===null)dUn++;
      else if(key&&ans.val===key)dCor++;
      else dWrong++;
    });
    const clr=CLR[cfg.idx%CLR.length];
    const pct=doubts.length>0?((dCor*3-dWrong)/(doubts.length*3)*100):null;
    html+=`<div style="background:var(--sur2);border:1px solid var(--bdr);border-radius:var(--rs);padding:14px">
      <div style="font-weight:800;color:${clr};margin-bottom:10px;font-size:13px">${esc(cfg.subj)}</div>
      <div style="font-size:11px;color:var(--txt3);margin-bottom:6px">از ${pN(doubts.length)} سوال شک‌دار:</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <span style="background:var(--G-d);color:var(--G);padding:3px 10px;border-radius:7px;font-size:12px;font-weight:700">✓ ${pN(dCor)}</span>
        <span style="background:var(--P-d);color:var(--P);padding:3px 10px;border-radius:7px;font-size:12px;font-weight:700">✗ ${pN(dWrong)}</span>
        <span style="background:var(--Y-d);color:var(--Y);padding:3px 10px;border-radius:7px;font-size:12px;font-weight:700">○ ${pN(dUn)}</span>
        ${pct!=null?`<span style="background:var(--acc-d);color:var(--acc);padding:3px 10px;border-radius:7px;font-size:12px;font-weight:700">${pct.toFixed(1)}%</span>`:''}
      </div>
    </div>`;
  });
  html+='</div>';
  statsBody.innerHTML=html;
}

function pbDrawSpider(subjRes){
  const canvas=document.getElementById('pb-spider-canvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const data=subjRes.filter(s=>s.pct!=null);
  if(data.length<3)return;

  const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2,cy=H/2;
  const R=Math.min(W,H)/2-60;
  const n=data.length;
  const css=getComputedStyle(document.documentElement);
  const accClr=css.getPropertyValue('--acc').trim()||'#635BFF';
  const gridClr=css.getPropertyValue('--chart-grid').trim()||'#E8ECF8';
  const lblClr=css.getPropertyValue('--chart-lbl').trim()||'#8896BB';
  const txtClr=css.getPropertyValue('--txt').trim()||'#1A2040';

  // draw grid
  const levels=5;
  for(let l=1;l<=levels;l++){
    const r=R*(l/levels);
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const a=(i/n)*Math.PI*2-Math.PI/2;
      const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;ctx.stroke();
    // level label
    const pctVal=Math.round((l/levels)*100);
    ctx.fillStyle=lblClr;ctx.font='10px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText(pctVal+'%',cx,cy-r+3);
  }

  // draw axes
  for(let i=0;i<n;i++){
    const a=(i/n)*Math.PI*2-Math.PI/2;
    ctx.beginPath();ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R*Math.cos(a),cy+R*Math.sin(a));
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;ctx.stroke();
  }

  // draw data polygon
  ctx.beginPath();
  data.forEach((sr,i)=>{
    const a=(i/n)*Math.PI*2-Math.PI/2;
    const pct=Math.max(0,Math.min(100,sr.pct));
    const r=R*(pct/100);
    const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.closePath();
  ctx.fillStyle=accClr+'33';ctx.fill();
  ctx.strokeStyle=accClr;ctx.lineWidth=2.5;ctx.stroke();

  // draw dots
  data.forEach((sr,i)=>{
    const a=(i/n)*Math.PI*2-Math.PI/2;
    const pct=Math.max(0,Math.min(100,sr.pct));
    const r=R*(pct/100);
    const x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);
    ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fillStyle=accClr;ctx.fill();
    ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    // value label
    ctx.fillStyle=accClr;ctx.font='bold 10px Vazirmatn,sans-serif';ctx.textAlign='center';
    const lx=cx+(r+18)*Math.cos(a),ly=cy+(r+18)*Math.sin(a);
    ctx.fillText(pct.toFixed(0)+'%',lx,ly);
  });

  // draw subject labels
  data.forEach((sr,i)=>{
    const a=(i/n)*Math.PI*2-Math.PI/2;
    const lx=cx+(R+36)*Math.cos(a),ly=cy+(R+36)*Math.sin(a);
    const clr=CLR[sr.idx%CLR.length];
    ctx.fillStyle=clr;ctx.font='bold 11px Vazirmatn,sans-serif';ctx.textAlign='center';
    // wrap long names
    const name=sr.subj.length>6?sr.subj.slice(0,6)+'…':sr.subj;
    ctx.fillText(name,lx,ly);
  });
}

function pbSaveToExams(){
  let exam=null;

  if(PB.isNewExam){
    // create new exam
    const name=document.getElementById('pb-new-exam-name')?.value?.trim()||'آزمون پاسخبرگ';
    const date=document.getElementById('pb-new-exam-date')?.value?.trim()||todayJ();
    exam={id:Date.now().toString(),name,date,subjects:{},examType:'full'};
    S.exams.push(exam);
  } else {
    if(!PB.linkedExamId)return;
    exam=S.exams.find(e=>e.id===PB.linkedExamId);
    if(!exam){alert('آزمون پیدا نشد');return;}
    if(!exam.subjects)exam.subjects={};
  }

  PB.config.forEach(cfg=>{
    let cor=0,wr=0,un=0,tot=0;
    cfg.nums.forEach(num=>{
      const ans=PB.answers[num];const key=PB.key[num];
      if(!ans||ans.late)return;
      tot++;
      if(ans.val===null)un++;
      else if(key&&ans.val===key)cor++;
      else wr++;
    });
    if(!tot)return;
    if(!exam.subjects[cfg.subj])exam.subjects[cfg.subj]={};
    exam.subjects[cfg.subj].total=tot;
    exam.subjects[cfg.subj].wrong=wr;
    exam.subjects[cfg.subj].unanswered=un;
    exam.subjects[cfg.subj].pct=calcPct(tot,wr,un);
  });
  saveS();refresh();
  alert('نتایج با موفقیت در آزمون ذخیره شد ✓');
  document.getElementById('pb-save-btn').style.display='none';
}

function pbRestart(){
  clearInterval(PB.timerInterval);
  PB={config:[],answers:{},key:{},flags:{},timerMin:60,timerTotal:0,timeLeft:0,timesUp:false,timerInterval:null,linkedExamId:null,isNewExam:false,phase:'setup'};
  pbShowStage('setup');
  pbInitSetup();
}

// ── نتایج: TODO و یادداشت به تفکیک درس ───────────────
// _pbResultData: {general:{note,todos}, bySubj:{[subjName]:{note,todos:[],questions:[]}}}
let _pbResultData={general:{note:'',todos:[]},bySubj:{}};
let _pbActiveQSubj={idx:null,subj:null};

function pbInitResultNotes(){
  _pbResultData={general:{note:'',todos:[]},bySubj:{}};
  _pbPendingImgs={};
  _pbActiveQSubj={idx:null,subj:null};
  PB.config.forEach(cfg=>{
    _pbResultData.bySubj[cfg.subj]={note:'',todos:[],questions:[]};
  });
  pbRenderResultNotesSection();
}

function pbRenderResultNotesSection(){
  // reset general
  const genNote=document.getElementById('pb-result-note-general');
  if(genNote)genNote.value=_pbResultData.general.note||'';

  const wrap=document.getElementById('pb-result-subj-notes');
  if(!wrap)return;
  let html='<div class="g2">';
  PB.config.forEach(cfg=>{
    const i=cfg.idx;
    const clr=CLR[i%CLR.length];
    const data=_pbResultData.bySubj[cfg.subj]||{note:'',todos:[],questions:[]};
    const todos=data.todos||[];
    const questions=data.questions||[];
    const qCount=questions.length;
    const todoCount=todos.filter(t=>!t.done).length;

    html+=`<div class="res-tab-card" id="rcard-${i}">
      <div class="res-tab-subj-hd">
        <span class="dot" style="background:${clr};box-shadow:0 0 10px ${clr}66;width:10px;height:10px;border-radius:50%;flex-shrink:0"></span>
        <span style="font-size:14px;font-weight:900;color:${clr};flex:1">${esc(cfg.subj)}</span>
        ${todoCount?`<span class="bdg bb" style="font-size:10px">${pN(todoCount)} وظیفه</span>`:''}
        ${qCount?`<span class="bdg" style="background:var(--G-d);color:var(--G);border-color:rgba(0,199,129,.2);font-size:10px">${pN(qCount)} سوال</span>`:''}
      </div>
      <div class="res-tab-head">
        <button class="res-tab-btn active" onclick="pbSwitchTab(${i},'note',this)">📝 یادداشت</button>
        <button class="res-tab-btn" onclick="pbSwitchTab(${i},'todos',this)">✅ وظایف ${todoCount?`<span style="font-size:9px;background:var(--acc);color:#fff;border-radius:10px;padding:1px 5px;margin-right:2px">${pN(todoCount)}</span>`:''}</button>
        <button class="res-tab-btn" onclick="pbSwitchTab(${i},'qs',this)">🖼️ سوالات ${qCount?`<span style="font-size:9px;background:var(--G);color:#fff;border-radius:10px;padding:1px 5px;margin-right:2px">${pN(qCount)}</span>`:''}</button>
      </div>

      <!-- Tab: یادداشت -->
      <div class="res-tab-pane active" id="rtab-${i}-note">
        <textarea id="pb-rnote-${i}" class="nta" placeholder="یادداشت برای ${esc(cfg.subj)}..." style="min-height:80px">${esc(data.note||'')}</textarea>
      </div>

      <!-- Tab: وظایف -->
      <div class="res-tab-pane" id="rtab-${i}-todos">
        <div class="tdl" id="pb-rtdl-${i}">
          ${todos.map((t,ti)=>`<div class="tdi" id="pb-rtdi-${i}-${ti}">
            <input type="checkbox" class="tdcb" ${t.done?'checked':''} onchange="pbResultChkTodo(${i},'${esc(cfg.subj)}',${ti},this.checked)">
            <span class="tdt ${t.done?'dn':''}" style="flex:1">${esc(t.text)}</span>
            <button class="tddl" onclick="pbResultDelTodo(${i},'${esc(cfg.subj)}',${ti})">✕</button>
          </div>`).join('')||`<div style="text-align:center;padding:16px 0;font-size:12px;color:var(--txt3)">هنوز وظیفه‌ای اضافه نشده</div>`}
        </div>
        <div class="tdadd" style="margin-top:8px">
          <input id="pb-rtdinp-${i}" placeholder="وظیفه جدید..." onkeydown="if(event.key==='Enter')pbResultAddTodo(${i},'${esc(cfg.subj)}')" style="font-size:12px;padding:7px 11px">
          <button class="btn bp bxs" onclick="pbResultAddTodo(${i},'${esc(cfg.subj)}')">+ افزودن</button>
        </div>
      </div>

      <!-- Tab: سوالات منتخب -->
      <div class="res-tab-pane" id="rtab-${i}-qs">
        <!-- will be populated by pbRenderInlineQTab when tab is activated -->
        <div style="text-align:center;padding:20px;font-size:12px;color:var(--txt3)">برای افزودن سوال روی تب "🖼️ سوالات" کلیک کن</div>
      </div>
    </div>`;
  });
  html+='</div>';
  wrap.innerHTML=html;
}

function pbResultAddTodo(idx,subj){
  const inp=document.getElementById(`pb-rtdinp-${idx}`);
  const txt=inp?.value?.trim();if(!txt)return;
  if(!_pbResultData.bySubj[subj])_pbResultData.bySubj[subj]={note:'',todos:[]};
  _pbResultData.bySubj[subj].todos.push({text:txt,done:false});
  inp.value='';pbRenderResultNotesSection();
}

function pbResultChkTodo(idx,subj,ti,done){
  if(!_pbResultData.bySubj[subj]?.todos)return;
  _pbResultData.bySubj[subj].todos[ti].done=done;
  pbRenderResultNotesSection();
}

function pbResultDelTodo(idx,subj,ti){
  if(!_pbResultData.bySubj[subj]?.todos)return;
  _pbResultData.bySubj[subj].todos.splice(ti,1);
  pbRenderResultNotesSection();
}

// ── Tab switcher ──────────────────────────────────────────────
function pbSwitchTab(cardIdx,tabName,btn){
  // deactivate all tab buttons and panes in this card
  const card=document.getElementById('rcard-'+cardIdx);
  if(!card)return;
  card.querySelectorAll('.res-tab-btn').forEach(b=>b.classList.remove('active'));
  card.querySelectorAll('.res-tab-pane').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  const pane=document.getElementById('rtab-'+cardIdx+'-'+tabName);
  if(pane)pane.classList.add('active');
  // set active subject for Ctrl+V paste
  if(tabName==='qs'){
    const cfg=PB.config.find(c=>c.idx===cardIdx);
    if(cfg){
      _pbActiveQSubj={idx:cardIdx,subj:cfg.subj};
      // render inline Q tab fresh
      pbRenderInlineQTab(cardIdx,cfg.subj);
    }
  }else{
    _pbActiveQSubj={idx:null,subj:null};
  }
}

// ── Inline question upload — pending buffer approach ──────────────
// buffer: {subjIdx: {imgs:[], note:''}}
var _pbPendingImgs={};  // {subj: [base64,...]}

function pbInlineQOpen(idx,subj){
  // Set active context so Ctrl+V works
  _pbActiveQSubj={idx,subj};
  const fi=document.getElementById('pb-inline-q-file');
  if(fi){fi.value='';fi.dataset.idx=idx;fi.dataset.subj=subj;fi.click();}
}

async function pbInlineQFile(e){
  const idx=parseInt(e.target.dataset.idx);
  const subj=e.target.dataset.subj;
  if(!subj&&subj!==0)return;
  if(!_pbPendingImgs[subj])_pbPendingImgs[subj]=[];
  for(const f of Array.from(e.target.files).filter(f=>f.type.startsWith('image/'))){
    _pbPendingImgs[subj].push(await readFile(f));
  }
  e.target.value='';
  pbRenderInlineQTab(idx,subj);
}

// Called by paste event (global) when pasakhbarg is active
async function pbPasteInlineQ(imgFile){
  const ctx=_pbActiveQSubj;
  if(!ctx||ctx.idx===null)return;
  if(!_pbPendingImgs[ctx.subj])_pbPendingImgs[ctx.subj]=[];
  _pbPendingImgs[ctx.subj].push(await readFile(imgFile));
  pbRenderInlineQTab(ctx.idx,ctx.subj);
}

function pbCommitPendingQ(idx,subj){
  const pending=_pbPendingImgs[subj]||[];
  if(!pending.length){alert('ابتدا حداقل یک تصویر اضافه کن');return;}
  if(!_pbResultData.bySubj[subj])_pbResultData.bySubj[subj]={note:'',todos:[],questions:[]};
  if(!_pbResultData.bySubj[subj].questions)_pbResultData.bySubj[subj].questions=[];
  const noteInp=document.getElementById('pb-rqnote-'+idx);
  const noteTxt=noteInp?noteInp.value.trim():'';
  _pbResultData.bySubj[subj].questions.push({imgs:[...pending],note:noteTxt});
  _pbPendingImgs[subj]=[];
  if(noteInp)noteInp.value='';
  pbRenderInlineQTab(idx,subj);
  // update card header badges
  pbRenderResultNotesSection();
  // switch to qs tab
  const card=document.getElementById('rcard-'+idx);
  if(card){const qBtn=card.querySelectorAll('.res-tab-btn')[2];if(qBtn)pbSwitchTab(idx,'qs',qBtn);}
}

function pbRemovePendingImg(subj,pi){
  if(_pbPendingImgs[subj])_pbPendingImgs[subj].splice(pi,1);
  const ctx=_pbActiveQSubj||{};
  if(ctx.subj===subj)pbRenderInlineQTab(ctx.idx,subj);
}

function pbRenderInlineQTab(idx,subj){
  const tabPane=document.getElementById('rtab-'+idx+'-qs');
  if(!tabPane)return;
  const questions=(_pbResultData.bySubj[subj]||{}).questions||[];
  const pending=_pbPendingImgs[subj]||[];
  const qCount=questions.length;

  let html='';

  // ── Pending buffer ──
  html+=`<div style="margin-bottom:14px;padding:12px;background:var(--acc-d);border:1px solid rgba(99,91,255,.25);border-radius:var(--rs)">
    <div style="font-size:11px;font-weight:800;color:var(--acc);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">📎 تصاویر در انتظار (یک سوال)</div>
    <div style="font-size:10px;color:var(--txt3);margin-bottom:8px">می‌توانی با <b>Ctrl+V</b>، کلیک روی دکمه افزودن، یا کشیدن عکس اضافه کنی. تمام تصاویر به عنوان <b>یک سوال</b> ذخیره می‌شوند.</div>`;

  if(pending.length){
    html+=`<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">`;
    pending.forEach((src,pi)=>{
      html+=`<div style="position:relative;width:70px;height:70px;border-radius:var(--rs);overflow:hidden;border:1px solid var(--acc)">
        <img src="${src}" style="width:100%;height:100%;object-fit:cover;cursor:pointer" onclick="fsContext=['${src}'];openFS(0)">
        <button style="position:absolute;top:2px;left:2px;width:18px;height:18px;background:rgba(244,63,94,.85);border:none;border-radius:4px;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center" onclick="pbRemovePendingImg('${subj}',${pi})">✕</button>
        <div style="position:absolute;bottom:2px;right:2px;background:rgba(0,0,0,.6);color:#fff;font-size:9px;padding:1px 5px;border-radius:5px;font-weight:700">${pN(pi+1)}</div>
      </div>`;
    });
    html+=`</div>`;
  }else{
    html+=`<div style="text-align:center;padding:12px 0;font-size:12px;color:var(--acc);opacity:.6">هنوز تصویری اضافه نشده</div>`;
  }

  html+=`<input id="pb-rqnote-${idx}" placeholder="یادداشت این سوال (اختیاری)..." style="font-size:12px;padding:8px 11px;width:100%;margin-bottom:8px">
    <div style="display:flex;gap:8px">
      <button class="btn bg bsm" onclick="pbInlineQOpen(${idx},'${subj}')">📷 افزودن تصویر</button>
      ${pending.length?`<button class="btn bp bsm" onclick="pbCommitPendingQ(${idx},'${subj}')">💾 ذخیره به عنوان یک سوال (${pN(pending.length)} تصویر)</button>`:''}
    </div>
  </div>`;

  // ── Committed questions ──
  if(qCount){
    html+=`<div style="font-size:11px;font-weight:800;color:var(--txt3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">✅ سوالات ذخیره‌شده (${pN(qCount)})</div>`;
    html+=`<div class="pb-q-grid">`;
    questions.forEach((q,qi)=>{
      html+=`<div class="pb-q-thumb" title="سوال ${pN(qi+1)} — ${pN((q.imgs||[]).length)} تصویر">
        <img src="${q.imgs&&q.imgs[0]?q.imgs[0]:''}" onclick="pbInlineViewQ(${idx},${qi})">
        <button class="rm" onclick="pbResultDelQ(${idx},'${subj}',${qi})">✕</button>
        ${(q.imgs||[]).length>1?`<div style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,.65);color:#fff;font-size:9px;padding:1px 6px;border-radius:7px;font-weight:700">${pN((q.imgs||[]).length)} 🖼️</div>`:''}
      </div>`;
    });
    html+=`</div>`;
    html+=`<div style="font-size:11px;color:var(--txt3);margin-top:8px;padding:8px;background:var(--G-d);border-radius:var(--rs);border:1px solid rgba(0,199,129,.2)">
      ✅ ${pN(qCount)} سوال ثبت‌شده — با کلیک روی "ذخیره همه" در بخش سوالات منتخب ذخیره می‌شن
    </div>`;
  }

  tabPane.innerHTML=html;
}

function pbResultDelQ(idx,subj,qi){
  if(!_pbResultData.bySubj[subj]?.questions)return;
  _pbResultData.bySubj[subj].questions.splice(qi,1);
  pbRenderInlineQTab(idx,subj);
  // update badges in header
  pbRenderResultNotesSection();
  const card=document.getElementById('rcard-'+idx);
  if(card){const qBtn=card.querySelectorAll('.res-tab-btn')[2];if(qBtn)pbSwitchTab(idx,'qs',qBtn);}
}

function pbInlineViewQ(idx,qi){
  const subj=PB.config.find(c=>c.idx===idx)?.subj;
  if(!subj)return;
  const q=_pbResultData.bySubj[subj]?.questions?.[qi];
  if(!q||!q.imgs?.length)return;
  fsContext=q.imgs;
  openFS(0);
}

function pbSaveResultNotes(){
  // collect general note
  _pbResultData.general.note=document.getElementById('pb-result-note-general')?.value?.trim()||'';
  // collect per-subject notes from textareas
  PB.config.forEach(cfg=>{
    const ta=document.getElementById(`pb-rnote-${cfg.idx}`);
    if(ta){
      if(!_pbResultData.bySubj[cfg.subj])_pbResultData.bySubj[cfg.subj]={note:'',todos:[],questions:[]};
      _pbResultData.bySubj[cfg.subj].note=ta.value.trim();
    }
  });

  // find or create exam
  let exam=null;
  if(PB.linkedExamId){
    exam=S.exams.find(e=>e.id===PB.linkedExamId);
  }
  if(!exam&&PB.isNewExam){
    const name=document.getElementById('pb-new-exam-name')?.value?.trim()||'آزمون پاسخبرگ';
    const date=document.getElementById('pb-new-exam-date')?.value?.trim()||todayJ();
    exam=S.exams.find(e=>e.name===name&&e.date===date);
    if(!exam){
      exam={id:Date.now().toString(),name,date,subjects:{},examType:'full'};
      S.exams.push(exam);
      PB.linkedExamId=exam.id;
    }
  }
  if(!exam){
    const name='یادداشت‌های پاسخبرگ '+todayJ();
    exam={id:Date.now().toString(),name,date:todayJ(),subjects:{},examType:'full'};
    S.exams.push(exam);
    PB.linkedExamId=exam.id;
  }
  if(!exam.subjects)exam.subjects={};

  // save general notes to exam._pbNotes
  if(!exam._pbNotes)exam._pbNotes={};
  exam._pbNotes.note=_pbResultData.general.note;
  exam._pbNotes.todos=_pbResultData.general.todos;
  exam._pbNotes.bySubj={};

  // save per-subject notes, todos, and questions
  const qs=loadQs();
  let newQCount=0;
  PB.config.forEach(cfg=>{
    const d=_pbResultData.bySubj[cfg.subj]||{};
    if(!exam.subjects[cfg.subj])exam.subjects[cfg.subj]={};
    exam.subjects[cfg.subj].notes=d.note||'';
    exam.subjects[cfg.subj].todos=d.todos||[];
    exam._pbNotes.bySubj[cfg.subj]={note:d.note||''};

    // save inline questions to questions store
    (d.questions||[]).forEach(q=>{
      if(!q.imgs||!q.imgs.length)return;
      qs.push({
        id:Date.now().toString()+Math.random().toString(36).slice(2),
        subj:cfg.subj,
        examId:exam.id,
        examName:exam.name,
        examDate:exam.date,
        note:q.note||'',
        imgs:q.imgs,
        date:todayJ(),
        reviews:0
      });
      newQCount++;
    });
  });

  saveQs(qs);
  saveS();refresh();
  const msg=newQCount?`یادداشت‌ها، وظایف و ${pN(newQCount)} سوال ذخیره شد ✓`:'یادداشت‌ها و وظایف ذخیره شد ✓';
  alert(msg);
  populateQFilters();renderQs();
}

// ════════════════════════════════════════════════════════
// GOZARESH KAR
// ════════════════════════════════════════════════════════
var _gzEditId=null, _gzMood=0;
var GZ_MOOD={5:'🔥 عالی',4:'😊 خوب',3:'😐 معمولی',2:'😴 خسته',1:'😓 ضعیف'};

function gzInit(){
  var sel=document.getElementById('gz-fsubj');
  if(!sel)return;
  sel.innerHTML='<option value="all">همه دروس</option>'+getGzSubjects().map(function(s){return '<option value="'+esc(s)+'">'+esc(s)+'</option>';}).join('');
}

function gzOpenAdd(id,prefillDate){
  _gzEditId=id||null;
  var rec=id?S.gz.find(function(g){return g.id===id;}):null;
  document.getElementById('gz-modal-ttl').textContent=id?'✏️ ویرایش گزارش':'📊 ثبت گزارش روز';
  document.getElementById('gz-date').value=rec?rec.date:(prefillDate||todayJ());
  document.getElementById('gz-datehint').textContent='امروز: '+todayJ();
  document.getElementById('gz-note').value=rec&&rec.note?rec.note:'';
  document.getElementById('gz-goal').value=rec&&rec.goal?rec.goal:'';
  _gzMood=rec&&rec.mood?rec.mood:0;
  gzRefreshMoodBtns();
  // build rows
  var html='';
  getGzSubjects().forEach(function(s,i){
    var clr=CLR[i%CLR.length];
    var sd=rec&&rec.subjects&&rec.subjects[s]?rec.subjects[s]:{};
    var totalH=sd.hours||0;
    var wholeH=Math.floor(totalH);
    var mins=Math.round((totalH-wholeH)*60);
    html+='<div class="gz-subj-row">'
      +'<div class="gz-subj-name" style="color:'+clr+'"><span class="dot" style="background:'+clr+';margin-left:4px"></span>'+esc(s)+'</div>'
      +'<div><span class="gz-inp-lbl">ساعت</span><input type="number" class="gz-inp" id="gz-h-'+i+'" min="0" max="24" step="1" placeholder="0" value="'+(wholeH||'')+'"></div>'
      +'<div><span class="gz-inp-lbl">دقیقه</span><input type="number" class="gz-inp" id="gz-m-'+i+'" min="0" max="59" step="5" placeholder="0" value="'+(mins||'')+'"></div>'
      +'<div><span class="gz-inp-lbl">تعداد تست</span><input type="number" class="gz-inp" id="gz-t-'+i+'" min="0" placeholder="0" value="'+(sd.tests||'')+'"></div>'
      +'<div><span class="gz-inp-lbl">فعالیت</span><input type="text" class="gz-inp" id="gz-a-'+i+'" placeholder="مثلاً: مرور فصل ۳..." value="'+esc(sd.activity||'')+'"></div>'
      +'</div>';
  });
  document.getElementById('gz-rows').innerHTML=html;
  document.getElementById('m-gz').style.display='flex';
}

function gzMood(v){
  _gzMood=v;
  gzRefreshMoodBtns();
}

function gzRefreshMoodBtns(){
  document.querySelectorAll('.gz-mb').forEach(function(b){
    b.classList.toggle('sel',parseInt(b.dataset.v)===_gzMood);
  });
  var lbl=document.getElementById('gz-moodlbl');
  if(lbl)lbl.textContent=_gzMood?GZ_MOOD[_gzMood]:'';
}

function gzSave(){
  var date=document.getElementById('gz-date').value.trim();
  if(!date){alert('لطفاً تاریخ را وارد کن');return;}
  var note=document.getElementById('gz-note').value.trim();
  var goal=document.getElementById('gz-goal').value.trim();
  var subjects={};
  getGzSubjects().forEach(function(s,i){
    var h=parseInt(document.getElementById('gz-h-'+i).value)||0;
    var m=parseInt(document.getElementById('gz-m-'+i).value)||0;
    var totalHours=h+m/60;
    var t=parseInt(document.getElementById('gz-t-'+i).value)||0;
    var a=(document.getElementById('gz-a-'+i).value||'').trim();
    if(totalHours||t||a)subjects[s]={hours:totalHours,tests:t,activity:a};
  });
  var rec={id:_gzEditId||Date.now().toString(),date:date,mood:_gzMood,note:note,goal:goal,subjects:subjects,ts:Date.now()};
  if(_gzEditId){
    var idx=S.gz.findIndex(function(g){return g.id===_gzEditId;});
    if(idx>=0)S.gz[idx]=rec; else S.gz.push(rec);
  } else {
    var dup=S.gz.find(function(g){return g.date===date;});
    if(dup){if(!confirm('برای این تاریخ قبلاً گزارش ثبت شده. جایگزین شود؟'))return;S.gz=S.gz.filter(function(g){return g.date!==date;});}
    S.gz.push(rec);
  }
  saveS();closeM('m-gz');renderGz();
}

// ── Today inline panel ─────────────────────────────────
var _gzTodayMood=0;
var _gzTodayTargetDate=null;
function gzTodayInit(forDate){
  var today=forDate||todayJ();
  _gzTodayTargetDate=forDate||null;
  var isToday=today===todayJ();
  document.getElementById('gz-today-date').textContent=today+(isToday?' (امروز)':' (فردا 🌅)');
  var rec=S.gz.find(function(g){return g.date===today;});
  _gzTodayMood=rec&&rec.mood?rec.mood:0;
  gzTodayRefreshMoodBtns();

  // build subject rows
  var html='';
  getGzSubjects().forEach(function(s,i){
    var clr=CLR[i%CLR.length];
    var sd=rec&&rec.subjects&&rec.subjects[s]?rec.subjects[s]:{};
    var totalH=sd.hours||0;
    var wholeH=Math.floor(totalH);
    var mins=Math.round((totalH-wholeH)*60);
    html+='<div class="gz-subj-row">'
      +'<div class="gz-subj-name" style="color:'+clr+'"><span class="dot" style="background:'+clr+';margin-left:4px"></span>'+esc(s)+'</div>'
      +'<div><span class="gz-inp-lbl">ساعت</span><input type="number" class="gz-inp" id="gz-td-h-'+i+'" min="0" max="24" step="1" placeholder="0" value="'+(wholeH||'')+'"></div>'
      +'<div><span class="gz-inp-lbl">دقیقه</span><input type="number" class="gz-inp" id="gz-td-m-'+i+'" min="0" max="59" step="5" placeholder="0" value="'+(mins||'')+'"></div>'
      +'<div><span class="gz-inp-lbl">تعداد تست</span><input type="number" class="gz-inp" id="gz-td-t-'+i+'" min="0" placeholder="0" value="'+(sd.tests||'')+'"></div>'
      +'<div><span class="gz-inp-lbl">فعالیت</span><input type="text" class="gz-inp" id="gz-td-a-'+i+'" placeholder="مثلاً: مرور فصل ۳..." value="'+esc(sd.activity||'')+'"></div>'
      +'</div>';
  });
  document.getElementById('gz-today-rows').innerHTML=html;
  document.getElementById('gz-today-note').value=rec?rec.note||'':'';
  document.getElementById('gz-today-goal').value=rec?rec.goal||'':'';

  // show saved badge if exists
  var badge=document.getElementById('gz-today-saved-badge');
  if(badge)badge.style.display=rec?'':'none';
  // update save button label based on date
  var saveBtn=document.getElementById('gz-today-save-btn');
  if(saveBtn)saveBtn.innerHTML=isToday?'💾 ذخیره امروز':'💾 ذخیره فردا';
  var panel=document.getElementById('gz-today-panel');
  if(panel)panel.style.borderRightColor=isToday?'var(--acc)':'var(--G)';
  var backBtn=document.getElementById('gz-back-today-btn');
  if(backBtn)backBtn.style.display=isToday?'none':'';
  if(!isToday&&!rec){
    var todayRec2=S.gz.find(function(g){return g.date===todayJ();});
    var noteEl2=document.getElementById('gz-today-note');
    if(noteEl2&&todayRec2&&todayRec2.goal)noteEl2.placeholder='🎯 هدف امروز: '+todayRec2.goal;
  }
}

function gzTodayMood(v){
  _gzTodayMood=_gzTodayMood===v?0:v;
  gzTodayRefreshMoodBtns();
}
function gzTodayRefreshMoodBtns(){
  var row=document.getElementById('gz-today-moodrow');
  if(!row)return;
  row.querySelectorAll('.gz-mb').forEach(function(b){
    b.classList.toggle('active',parseInt(b.dataset.v)===_gzTodayMood);
  });
}

function gzTodaySave(){
  var today=_gzTodayTargetDate||todayJ();
  var subjects={};
  getGzSubjects().forEach(function(s,i){
    var hEl=document.getElementById('gz-td-h-'+i);
    var mEl=document.getElementById('gz-td-m-'+i);
    var tEl=document.getElementById('gz-td-t-'+i);
    var aEl=document.getElementById('gz-td-a-'+i);
    var h=parseInt((hEl?hEl.value:'')||0)||0;
    var m=parseInt((mEl?mEl.value:'')||0)||0;
    var totalHours=h+m/60;
    var t=parseInt((tEl?tEl.value:'')||0)||0;
    var a=(aEl?aEl.value||'':'').trim();
    if(totalHours||t||a)subjects[s]={hours:totalHours,tests:t,activity:a};
  });
  var note=(document.getElementById('gz-today-note').value||'').trim();
  var goal=(document.getElementById('gz-today-goal').value||'').trim();
  var existing=S.gz.find(function(g){return g.date===today;});
  if(existing){
    existing.mood=_gzTodayMood;existing.note=note;existing.goal=goal;existing.subjects=subjects;existing.ts=Date.now();
  }else{
    S.gz.push({id:Date.now().toString(),date:today,mood:_gzTodayMood,note:note,goal:goal,subjects:subjects,ts:Date.now()});
  }
  saveS();
  renderGz();
  // نشان دادن badge ذخیره‌شده
  var badge=document.getElementById('gz-today-saved-badge');
  if(badge){
    badge.style.display='';
    badge.textContent='✓ ذخیره شد!';
    // بعد از ذخیره‌ی امروز، پنل رو برای فردا آماده کن
    setTimeout(function(){
      gzTodayInit(tomorrowJ());
    },1200);
  }
}

function gzDel(id){
  if(!confirm('این گزارش حذف شود؟'))return;
  S.gz=S.gz.filter(function(g){return g.id!==id;});
  saveS();renderGz();
}

// ── GZ Subjects Manager ─────────────────────────────────
var _gzTmpSubjs=null;
function openGzSubjMgr(){
  _gzTmpSubjs=S.gzSubjects?[...S.gzSubjects]:[...getGzSubjects()];
  renderGzSubjMgrList();
  document.getElementById('m-gz-subj').style.display='flex';
}
function renderGzSubjMgrList(){
  var isSynced=S.gzSubjects===null;
  document.getElementById('gz-subj-mgr-list').innerHTML=(isSynced
    ?'<div style="font-size:11px;color:var(--G);font-weight:700;padding:8px;background:var(--G-d);border-radius:var(--rs);margin-bottom:8px">✅ در حال حاضر همگام با درس‌های آزمون است</div>':'')+
    (_gzTmpSubjs||[]).map(function(s,i){
      return'<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:8px 12px;background:var(--sur2);border-radius:var(--rs);border:1px solid var(--bdr)">'
        +'<span class="dot" style="background:'+CLR[i%CLR.length]+';width:10px;height:10px"></span>'
        +'<span style="flex:1;font-size:13px;font-weight:600">'+esc(s)+'</span>'
        +'<button class="btn bd bxs" onclick="rmGzSubjItem('+i+')">حذف</button>'
      +'</div>';
    }).join('');
}
function rmGzSubjItem(i){if(_gzTmpSubjs)_gzTmpSubjs.splice(i,1);renderGzSubjMgrList();}
function addGzSubjItem(){
  var inp=document.getElementById('new-gz-subj-inp');var n=inp.value.trim();if(!n)return;
  if(!_gzTmpSubjs)_gzTmpSubjs=[];
  if(_gzTmpSubjs.includes(n)){alert('این درس قبلاً وجود دارد');return;}
  _gzTmpSubjs.push(n);inp.value='';renderGzSubjMgrList();
}
function gzSubjSyncWithMain(){
  _gzTmpSubjs=null; // null = sync with S.subjects
  // force renderGzSubjMgrList to show synced state
  S.gzSubjects=null;
  saveS();closeM('m-gz-subj');gzInit();renderGz();
}
function gzSubjCopyFromMain(){
  _gzTmpSubjs=[...S.subjects];renderGzSubjMgrList();
}
function saveGzSubjs(){
  S.gzSubjects=_gzTmpSubjs&&_gzTmpSubjs.length?_gzTmpSubjs:null;
  saveS();closeM('m-gz-subj');gzInit();renderGz();
}

function gzToggle(id){
  var el=document.getElementById(id);
  if(el)el.classList.toggle('open');
}

function renderGz(){
  var range=parseInt(document.getElementById('gz-range').value)||0;
  var fsubj=document.getElementById('gz-fsubj').value||'all';
  var fsort=document.getElementById('gz-fsort').value||'new';
  var all=S.gz.slice();

  // stats from ALL records
  var totH=0,totT=0;
  all.forEach(function(g){
    Object.values(g.subjects||{}).forEach(function(v){totH+=v.hours||0;totT+=v.tests||0;});
  });
  // streak — فقط تا امروز حساب کن (فردا رو نادیده بگیر)
  var streak=0;
  if(all.length){
    var today2=todayJ();
    var pastDates=all.map(function(g){return g.date;}).filter(function(d){return d<=today2;}).sort().reverse();
    var cur=today2;
    for(var di=0;di<pastDates.length;di++){
      if(pastDates[di]===cur){streak++;cur=gzYesterday(cur);}
      else break;
    }
  }
  document.getElementById('gz-days').textContent=pN(all.length);
  document.getElementById('gz-hours').textContent=gzFmtH(totH);
  document.getElementById('gz-tests').textContent=pN(totT);
  document.getElementById('gz-streak').textContent=pN(streak)+' روز';

  // subj bars
  gzSubjBars(all);

  // charts
  setTimeout(function(){gzBarChart('gz-hchart','hours',getCSSVar('--acc'));gzBarChart('gz-tchart','tests',getCSSVar('--G'));gzRenderAnalytics();},60);

  // filter by range
  var recs=all.slice();
  if(range>0){
    // محاسبه تاریخ برش (بر اساس تاریخ جلالی، نه timestamp)
    var cutoffDate=new Date(Date.now()-range*86400000);
    var cj=toJalali(cutoffDate.getFullYear(),cutoffDate.getMonth()+1,cutoffDate.getDate());
    var cutoffStr=cj.jy+'/'+String(cj.jm).padStart(2,'0')+'/'+String(cj.jd).padStart(2,'0');
    recs=recs.filter(function(g){return g.date>=cutoffStr;});
  }
  // filter by subj
  if(fsubj!=='all'){
    recs=recs.filter(function(g){return g.subjects&&g.subjects[fsubj];});
  }
  // sort
  recs.sort(function(a,b){
    if(fsort==='old')return a.ts-b.ts;
    if(fsort==='h'){
      var ha=Object.values(a.subjects||{}).reduce(function(s,v){return s+(v.hours||0);},0);
      var hb=Object.values(b.subjects||{}).reduce(function(s,v){return s+(v.hours||0);},0);
      return hb-ha;
    }
    if(fsort==='t'){
      var ta=Object.values(a.subjects||{}).reduce(function(s,v){return s+(v.tests||0);},0);
      var tb=Object.values(b.subjects||{}).reduce(function(s,v){return s+(v.tests||0);},0);
      return tb-ta;
    }
    return b.ts-a.ts;
  });

  var wrap=document.getElementById('gz-list');
  if(!recs.length){wrap.innerHTML='<div class="empty"><div class="ei">📊</div><h3>هنوز گزارشی ثبت نشده</h3><p>هر روز فعالیتت رو ثبت کن</p></div>';return;}

  var html='';
  recs.forEach(function(g){
    var totalH=Object.values(g.subjects||{}).reduce(function(s,v){return s+(v.hours||0);},0);
    var totalT=Object.values(g.subjects||{}).reduce(function(s,v){return s+(v.tests||0);},0);
    var moodEmoji=g.mood?GZ_MOOD[g.mood].split(' ')[0]:'';
    var hDisp=gzFmtH(totalH);

    var subjRows='';
    S.subjects.forEach(function(s,i){
      var sd=g.subjects&&g.subjects[s];
      if(!sd)return;
      if(fsubj!=='all'&&s!==fsubj)return;
      var clr=CLR[i%CLR.length];
      subjRows+='<div class="gz-subj-row">'
        +'<span class="gz-subj-name" style="color:'+clr+'"><span class="dot" style="background:'+clr+';margin-left:4px"></span>'+esc(s)+'</span>'
        +'<span style="font-size:12px;font-weight:700">'+(sd.hours?'⏱ '+gzFmtH(sd.hours):'—')+'</span>'
        +'<span style="font-size:12px;font-weight:700">'+(sd.tests?'📝 '+pN(sd.tests):'—')+'</span>'
        +'<span style="font-size:12px;color:var(--txt2)">'+esc(sd.activity||'')+'</span>'
        +'</div>';
    });
    if(fsubj!=='all'&&!subjRows)return;

    html+='<div class="gz-day-card">'
      +'<div class="gz-day-hd" onclick="gzToggle(\'gz-b-'+g.id+'\')">'
        +'<div style="display:flex;align-items:center;gap:10px"><span class="gz-day-date">'+esc(g.date)+'</span>'+(moodEmoji?'<span>'+moodEmoji+'</span>':'')+'</div>'
        +'<div class="gz-day-meta">'
          +(totalH?'<span>⏱ '+hDisp+'</span>':'')
          +(totalT?'<span>📝 '+pN(totalT)+' تست</span>':'')
          +(g.goal?'<span style="color:var(--acc)">🎯 هدف</span>':'')
          +'<span>▼</span>'
        +'</div>'
      +'</div>'
      +'<div class="gz-day-body" id="gz-b-'+g.id+'">'
        +(subjRows?'<div style="margin-bottom:12px">'+subjRows+'</div>':'')
        +(g.note?'<div style="background:var(--sur2);border-radius:var(--rs);padding:10px 14px;font-size:13px;line-height:1.6;margin-bottom:8px;border:1px solid var(--bdr)"><b style="font-size:10px;color:var(--txt3)">📝 یادداشت:</b><br>'+esc(g.note)+'</div>':'')
        +(g.goal?'<div style="background:var(--acc-d);border-radius:var(--rs);padding:10px 14px;font-size:13px;color:var(--acc);font-weight:600;margin-bottom:8px">🎯 هدف فردا: '+esc(g.goal)+'</div>':'')
        +'<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">'
          +'<button class="btn bg bsm" onclick="gzOpenAdd(\''+g.id+'\')">✏️ ویرایش</button>'
          +'<button class="btn bd bsm" onclick="gzDel(\''+g.id+'\')">🗑️ حذف</button>'
        +'</div>'
      +'</div>'
    +'</div>';
  });
  wrap.innerHTML=html||'<div class="empty"><div class="ei">🔍</div><h3>موردی پیدا نشد</h3></div>';
  // sync today panel badge
  var badge=document.getElementById('gz-today-saved-badge');
  if(badge){var td=todayJ();badge.style.display=S.gz.find(function(g){return g.date===td;})?'':'none';}
}

function gzSubjBars(all){
  var wrap=document.getElementById('gz-subjbars');
  if(!wrap)return;
  if(!all.length){wrap.innerHTML='<p style="font-size:12px;color:var(--txt3)">هنوز داده‌ای ثبت نشده</p>';return;}
  var totals=getGzSubjects().map(function(s,i){
    var h=all.reduce(function(a,g){return a+(g.subjects&&g.subjects[s]?g.subjects[s].hours||0:0);},0);
    var t=all.reduce(function(a,g){return a+(g.subjects&&g.subjects[s]?g.subjects[s].tests||0:0);},0);
    var days=all.filter(function(g){return g.subjects&&g.subjects[s];}).length;
    return {s:s,i:i,h:h,t:t,days:days};
  }).filter(function(d){return d.h||d.t;});
  if(!totals.length){wrap.innerHTML='<p style="font-size:12px;color:var(--txt3)">هنوز داده‌ای ثبت نشده</p>';return;}
  var maxH=Math.max.apply(null,totals.map(function(d){return d.h;}));
  var html='<div style="display:flex;flex-direction:column;gap:8px;padding-top:4px">';
  totals.forEach(function(d){
    var clr=CLR[d.i%CLR.length];
    var pct=maxH>0?Math.round(d.h/maxH*100):0;
    html+='<div style="display:flex;align-items:center;gap:10px">'
      +'<span style="width:90px;font-size:12px;font-weight:700;color:'+clr+';flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(d.s)+'</span>'
      +'<div class="prt" style="flex:1"><div class="prf" style="width:'+pct+'%;background:'+clr+'"></div></div>'
      +'<span style="font-size:11px;font-weight:800;color:'+clr+';white-space:nowrap;min-width:90px">⏱ '+gzFmtH(d.h)+'  📝 '+pN(d.t)+'</span>'
      +'<span style="font-size:10px;color:var(--txt3);white-space:nowrap">('+pN(d.days)+' روز)</span>'
    +'</div>';
  });
  html+='</div>';
  wrap.innerHTML=html;
}

function gzBarChart(canvasId,field,color){
  var canvas=document.getElementById(canvasId);
  if(!canvas)return;
  var ctx=canvas.getContext('2d');
  canvas.width=canvas.offsetWidth||500;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  var W=canvas.width,H=canvas.height;
  var recs=S.gz.slice().sort(function(a,b){return (a.ts||0)-(b.ts||0);}).slice(-14);
  if(!recs.length){noData(ctx,W,H);return;}
  var vals=recs.map(function(g){return Object.values(g.subjects||{}).reduce(function(s,v){return s+(v[field]||0);},0);});
  var maxV=Math.max.apply(null,vals)||1;
  var pad={top:20,right:10,bottom:34,left:36};
  var cW=W-pad.left-pad.right,cH=H-pad.top-pad.bottom;
  var barW=Math.max(6,cW/recs.length-8);
  var gridClr=getCSSVar('--chart-grid');
  var lblClr=getCSSVar('--chart-lbl');
  [0,0.5,1].forEach(function(t){
    var y=pad.top+cH*(1-t);
    ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(W-pad.right,y);
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;ctx.stroke();
    ctx.fillStyle=lblClr;ctx.font='9px Vazirmatn,sans-serif';ctx.textAlign='right';
    ctx.fillText((maxV*t).toFixed(field==='hours'?1:0),pad.left-3,y+3);
  });
  recs.forEach(function(g,i){
    var v=vals[i];
    var x=pad.left+(cW/recs.length)*i+(cW/recs.length-barW)/2;
    var bH=cH*(v/maxV);
    var y=pad.top+cH-bH;
    ctx.fillStyle=v>0?color+'AA':gridClr;
    ctx.fillRect(x,y,barW,bH);
    if(v>0){ctx.fillStyle=color;ctx.font='bold 9px Vazirmatn,sans-serif';ctx.textAlign='center';ctx.fillText(field==='hours'?gzFmtH(v):String(v),x+barW/2,y-3);}
    ctx.fillStyle=lblClr;ctx.font='9px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText((g.date||'').slice(5),x+barW/2,pad.top+cH+13);
  });
}

function gzYesterday(dateStr){
  // محاسبه دیروز از روی رشته تاریخ جلالی - جمع‌وجورتر و بی‌باگ‌تر
  var parts=dateStr.split('/');
  var jy=parseInt(parts[0]),jm=parseInt(parts[1]),jd=parseInt(parts[2]);
  jd--;
  if(jd>0)return jy+'/'+String(jm).padStart(2,'0')+'/'+String(jd).padStart(2,'0');
  // برو به ماه قبل
  jm--;
  if(jm>0){
    // روزهای ماه‌های جلالی: ۱-۶ = ۳۱ روز، ۷-۱۱ = ۳۰ روز، ۱۲ = ۲۹ (یا ۳۰ کبیسه)
    var daysInMonth=jm<=6?31:jm<=11?30:29;
    return jy+'/'+String(jm).padStart(2,'0')+'/'+String(daysInMonth).padStart(2,'0');
  }
  // برو به سال قبل
  jy--;jm=12;
  return jy+'/12/29';
}


// ════════════════════════════════════════════════════════
// HELPER: format hours to H:MM display
// ════════════════════════════════════════════════════════
function gzFmtH(h){
  if(!h&&h!==0)return'—';
  var wh=Math.floor(h);
  var mm=Math.round((h-wh)*60);
  if(mm===60){wh++;mm=0;}
  return mm>0?pN(wh)+'ساعت '+pN(mm)+'دقیقه':pN(wh)+'ساعت';
}

// ════════════════════════════════════════════════════════
// STANDALONE TODOS
// ════════════════════════════════════════════════════════
function loadStandaloneTodos(){
  try{return JSON.parse(localStorage.getItem('az_std_todos')||'[]');}catch(e){return[];}
}
function saveStandaloneTodos(arr){
  try{localStorage.setItem('az_std_todos',JSON.stringify(arr));}catch(e){}
}

function openAddStandaloneTodo(){
  var sel=document.getElementById('std-todo-subj');
  sel.innerHTML=S.subjects.map(function(s){return'<option value="'+esc(s)+'">'+esc(s)+'</option>';}).join('');
  document.getElementById('std-todo-text').value='';
  document.getElementById('std-todo-priority').value='normal';
  document.getElementById('m-standalone-todo').style.display='flex';
  setTimeout(function(){document.getElementById('std-todo-text').focus();},100);
}

function saveStandaloneTodo(){
  var text=document.getElementById('std-todo-text').value.trim();
  if(!text){alert('متن وظیفه را وارد کن');return;}
  var subj=document.getElementById('std-todo-subj').value;
  var priority=document.getElementById('std-todo-priority').value;
  var arr=loadStandaloneTodos();
  arr.push({id:Date.now().toString(),text:text,subj:subj,priority:priority,done:false,date:todayJ()});
  saveStandaloneTodos(arr);
  closeM('m-standalone-todo');
  renderTodos();
}

function toggleStandaloneTodo(id,done){
  var arr=loadStandaloneTodos();
  var t=arr.find(function(x){return x.id===id;});
  if(t)t.done=done;
  saveStandaloneTodos(arr);
  renderTodos();
}

function deleteStandaloneTodo(id){
  saveStandaloneTodos(loadStandaloneTodos().filter(function(x){return x.id!==id;}));
  renderTodos();
}

// Patch renderTodos to include standalone todos
var _origRenderTodos=renderTodos;
function renderTodos(){
  var filter=document.getElementById('td-filter').value;
  var subjFilter=document.getElementById('td-subj-filter')?.value||'all';
  var wrap=document.getElementById('td-wrap');
  var stats=document.getElementById('td-stats');
  var css=getComputedStyle(document.documentElement);
  var tot=0,done=0,pend=0;
  var bySub={};
  S.subjects.forEach(function(s){bySub[s]=[];});

  // From exams
  S.exams.forEach(function(exam){
    S.subjects.forEach(function(s){
      (exam.subjects?.[s]?.todos||[]).forEach(function(t,ti){
        tot++;t.done?done++:pend++;
        bySub[s].push({...t,examId:exam.id,examName:exam.name,examDate:exam.date,ti:ti,isStandalone:false});
      });
    });
  });

  // Standalone todos
  loadStandaloneTodos().forEach(function(t){
    if(!bySub[t.subj])bySub[t.subj]=[];
    tot++;t.done?done++:pend++;
    var priLabel=t.priority==='high'?'🔴 مهم':t.priority==='low'?'⬇️ کم':' ';
    bySub[t.subj].push({...t,examName:'مستقل '+priLabel,examDate:t.date,isStandalone:true});
  });

  stats.innerHTML=`
    <span class="bdg by" style="padding:5px 14px;font-size:12px">📋 کل: ${pN(tot)}</span>
    <span class="bdg bb" style="padding:5px 14px;font-size:12px">⏳ باقی‌مانده: ${pN(pend)}</span>
    <span class="bdg" style="background:var(--G-d);color:var(--G);padding:5px 14px;font-size:12px;font-weight:700">✅ انجام‌شده: ${pN(done)}</span>`;
  if(!tot){wrap.innerHTML=`<div class="empty"><div class="ei">✅</div><h3>هیچ وظیفه‌ای ثبت نشده</h3><p>با دکمه "وظیفه جدید" کار اضافه کن</p></div>`;return;}

  var html='<div class="g2">',shown=false;
  var subjsToShow=subjFilter==='all'?S.subjects:S.subjects.filter(function(s){return s===subjFilter;});
  subjsToShow.forEach(function(s,idx){
    var i=S.subjects.indexOf(s);
    var clr=CLR[i%CLR.length];
    var items=(bySub[s]||[]).slice();
    if(filter==='pending')items=items.filter(function(t){return!t.done;});
    if(filter==='done')items=items.filter(function(t){return t.done;});
    if(!items.length)return;
    shown=true;
    var p=items.filter(function(t){return!t.done;}).length;
    var d=items.filter(function(t){return t.done;}).length;
    html+=`<div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--bdr)">
        <div style="display:flex;align-items:center;gap:9px">
          <span class="dot" style="background:${clr};box-shadow:0 0 8px ${clr}55;width:10px;height:10px"></span>
          <span style="font-size:14px;font-weight:800;color:${clr}">${esc(s)}</span>
        </div>
        <div style="display:flex;gap:6px">
          ${p?`<span class="bdg bb">${pN(p)} باقی</span>`:''}
          ${d?`<span class="bdg" style="background:var(--G-d);color:var(--G)">${pN(d)} انجام‌شده</span>`:''}
        </div>
      </div>`;
    items.forEach(function(t){
      var doneBadge=t.done?`background:var(--G-d);color:var(--G)`:`background:var(--acc-d);color:var(--acc)`;
      var srcBadge=t.isStandalone?`<span class="td-standalone-badge">📌 مستقل</span>`:' ';
      var chkAttr=t.isStandalone?
        `onchange="toggleStandaloneTodo('${t.id}',this.checked)"`:
        `onchange="globalChkTodo('${t.examId}','${esc(s)}',${t.ti},this.checked)"`;
      var delBtn=t.isStandalone?
        `<button class="tddl" onclick="deleteStandaloneTodo('${t.id}')">✕</button>`:
        '';
      html+=`<div class="tdi" style="padding:9px 4px">
        <input type="checkbox" class="tdcb" ${t.done?'checked':''} ${chkAttr}>
        <div style="flex:1">
          <div class="tdt ${t.done?'dn':''}" style="font-size:13px">${esc(t.text)}</div>
          <div style="font-size:10px;color:var(--txt3);margin-top:2px;font-weight:600;display:flex;gap:6px;align-items:center">${srcBadge} 📝 ${esc(t.examName)} — ${t.examDate}</div>
        </div>
        ${delBtn}
        <span style="font-size:10px;white-space:nowrap;padding:3px 9px;border-radius:7px;${doneBadge};font-weight:700">${t.done?'✅':'⏳'}</span>
      </div>`;
    });
    html+=`</div>`;
  });
  html+='</div>';
  wrap.innerHTML=shown?html:`<div class="empty"><div class="ei">🔍</div><h3>موردی پیدا نشد</h3></div>`;
}

// ════════════════════════════════════════════════════════
// DAILY REPORT (SCREENSHOT)
// ════════════════════════════════════════════════════════
function openDailyReport(){
  var sel=document.getElementById('dr-date-sel');
  var dates=S.gz.slice().sort(function(a,b){return b.ts-a.ts;}).map(function(g){return g.date;});
  if(!dates.length){alert('هنوز گزارشی ثبت نشده');return;}
  sel.innerHTML=dates.map(function(d){return'<option value="'+esc(d)+'">'+esc(d)+'</option>';}).join('');
  renderDailyReport();
  document.getElementById('m-daily-report').style.display='flex';
}

function renderDailyReport(){
  var date=document.getElementById('dr-date-sel').value;
  var rec=S.gz.find(function(g){return g.date===date;});
  var wrap=document.getElementById('daily-report-content');
  if(!rec){wrap.innerHTML='<p style="text-align:center;color:var(--txt3)">گزارشی یافت نشد</p>';return;}

  var totalH=Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0);
  var totalT=Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.tests||0);},0);
  var subjCount=Object.keys(rec.subjects||{}).length;
  var moodTxt=rec.mood?GZ_MOOD[rec.mood]:'';

  var subjRowsHtml='';
  S.subjects.forEach(function(s,i){
    var sd=rec.subjects&&rec.subjects[s];
    if(!sd)return;
    var clr=CLR[i%CLR.length];
    var hStr=sd.hours?gzFmtH(sd.hours):'—';
    var tStr=sd.tests?pN(sd.tests)+' تست':'—';
    subjRowsHtml+=`
      <div class="daily-subj-item">
        <span class="dot" style="background:${clr};box-shadow:0 0 8px ${clr}55;width:10px;height:10px;flex-shrink:0"></span>
        <span style="font-size:13px;font-weight:800;color:${clr};flex:1">${esc(s)}</span>
        <span style="font-size:12px;font-weight:700;color:var(--txt2);margin-left:8px">⏱ ${hStr}</span>
        <span style="font-size:12px;font-weight:700;color:var(--txt2);margin-left:8px">📝 ${tStr}</span>
        ${sd.activity?`<span style="font-size:11px;color:var(--txt3);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(sd.activity)}</span>`:''}
      </div>`;
  });

  wrap.innerHTML=`
    <div class="daily-report-card" id="daily-report-card">
      <div class="daily-header">
        <div class="app-name">⚡ آزمونِتو</div>
        <div class="daily-date">${esc(date)}</div>
        ${moodTxt?`<div style="font-size:16px;margin-top:8px;font-weight:700;color:var(--txt2)">${moodTxt}</div>`:''}
      </div>
      <div class="daily-stat-row">
        <div class="daily-stat-item">
          <div class="sv">${gzFmtH(totalH)}</div>
          <div class="sl">⏱ مطالعه</div>
        </div>
        <div class="daily-stat-item">
          <div class="sv">${pN(totalT)}</div>
          <div class="sl">📝 تست</div>
        </div>
        <div class="daily-stat-item">
          <div class="sv">${pN(subjCount)}</div>
          <div class="sl">📚 درس</div>
        </div>
      </div>
      ${subjRowsHtml?`<div class="daily-subj-list">${subjRowsHtml}</div>`:''}
      ${rec.note?`<div class="daily-note-box"><b style="font-size:10px;color:var(--txt3);font-weight:800">📝 یادداشت روز</b><div style="margin-top:6px">${esc(rec.note)}</div></div>`:''}
      ${rec.goal?`<div class="daily-goal-box">🎯 هدف فردا: ${esc(rec.goal)}</div>`:''}
      <div style="text-align:center;margin-top:18px;font-size:10px;color:var(--txt3);font-weight:700;letter-spacing:.5px">آزمونِتو — پیگیری هوشمند کنکور</div>
    </div>`;
}

// ════════════════════════════════════════════════════════
// GZ ANALYTICS
// ════════════════════════════════════════════════════════
function gzRenderAnalytics(){
  gzRenderHeatmap();
  gzRenderWeekly();
  gzRenderMoodChart();
  gzRenderSummary();
  gzWgRender();
  gzRenderWeekCompare();
  jCalDraw();
}

function gzRenderHeatmap(){
  var el=document.getElementById('gz-heatmap-days');
  if(!el)return;

  // روزهای هفته جلالی: شنبه = 6 در Date.getDay() (0=Sun,6=Sat)
  var dayNames=['ش','ی','د','س','چ','پ','ج']; // شنبه تا جمعه

  // امروز رو پیدا کن
  var now=new Date();
  var nowDay=now.getDay(); // 0=Sun ... 6=Sat
  // تعداد روزهایی که باید به عقب بریم تا برسیم به اول هفته (شنبه)
  var daysToSat=(nowDay+1)%7; // شنبه = (6+1)%7=0, یکشنبه = (0+1)%7=1 ...
  
  // شروع از ۴ هفته کامل پیش (۲۸ روز قبل از شروع هفته فعلی = ۵ هفته کامل)
  var totalDays=35;
  var startOffset=daysToSat+(totalDays-7); // offset از امروز به عقب تا به اول ۵ هفته برسیم
  
  var html='';
  // هدر روزهای هفته
  dayNames.forEach(function(d){
    html+='<div class="gz-heatmap-day-lbl">'+d+'</div>';
  });
  
  // خانه‌های روزها
  for(var i=startOffset;i>=0;i--){
    var d=new Date(now.getTime()-i*86400000);
    var j=toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
    var dateStr=j.jy+'/'+String(j.jm).padStart(2,'0')+'/'+String(j.jd).padStart(2,'0');
    var rec=S.gz.find(function(g){return g.date===dateStr;});
    var h=rec?Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0):0;
    var cls='gz-heatmap-cell';
    if(h>0&&h<=2)cls+=' h1';
    else if(h>2&&h<=5)cls+=' h2';
    else if(h>5&&h<=8)cls+=' h3';
    else if(h>8)cls+=' h4';
    var lbl=String(j.jd).replace(/\d/g,function(x){return'۰۱۲۳۴۵۶۷۸۹'[x];});
    var isFuture=i<0;
    if(isFuture)cls+=' future';
    html+='<div class="'+cls+'" title="'+dateStr+(h?' | '+gzFmtH(h):'')+'">'+lbl+'</div>';
  }
  el.innerHTML=html;
}

function gzRenderWeekly(){
  var barsEl=document.getElementById('gz-weekly-bars');
  var lblsEl=document.getElementById('gz-weekly-lbls');
  if(!barsEl)return;
  // last 8 weeks avg daily hours
  var weeks=[];
  for(var w=7;w>=0;w--){
    var sum=0,cnt=0;
    var now=new Date();
    for(var d=0;d<7;d++){
      var dayOff=(w*7+d);
      var dd=new Date(now.getTime()-dayOff*86400000);
      var j=toJalali(dd.getFullYear(),dd.getMonth()+1,dd.getDate());
      var ds=j.jy+'/'+String(j.jm).padStart(2,'0')+'/'+String(j.jd).padStart(2,'0');
      var rec=S.gz.find(function(g){return g.date===ds;});
      if(rec){sum+=Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0);cnt++;}
    }
    weeks.unshift({avg:cnt?sum/cnt:0,cnt:cnt,w:8-w});
  }
  var maxH=Math.max.apply(null,weeks.map(function(w){return w.avg;}))||1;
  var accClr=getCSSVar('--acc');
  barsEl.innerHTML=weeks.map(function(w,i){
    var pct=Math.round((w.avg/maxH)*100);
    return '<div class="gz-week-bar" style="height:'+Math.max(pct,4)+'%;background:'+accClr+(w.cnt?'':'40')+'" title="'+gzFmtH(w.avg)+' میانگین"></div>';
  }).join('');
  lblsEl.innerHTML=weeks.map(function(w,i){
    return'<div class="gz-week-bar-lbl" style="flex:1">w'+pN(w.w)+'</div>';
  }).join('');
}

function gzRenderMoodChart(){
  var canvas=document.getElementById('gz-mood-chart');
  if(!canvas)return;
  var ctx=canvas.getContext('2d');
  canvas.width=canvas.offsetWidth||300;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  var W=canvas.width,H=canvas.height;
  var recs=S.gz.slice().sort(function(a,b){return (a.ts||0)-(b.ts||0);}).filter(function(g){return g.mood;}).slice(-14);
  if(recs.length<2){noData(ctx,W,H);return;}
  var pad={top:14,right:14,bottom:28,left:28};
  var cW=W-pad.left-pad.right,cH=H-pad.top-pad.bottom;
  var gridClr=getCSSVar('--chart-grid');
  var lblClr=getCSSVar('--chart-lbl');
  var accClr=getCSSVar('--acc');
  // grid
  [1,2,3,4,5].forEach(function(v){
    var y=pad.top+cH*(1-(v-1)/4);
    ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(W-pad.right,y);
    ctx.strokeStyle=gridClr;ctx.lineWidth=1;ctx.stroke();
    ctx.fillStyle=lblClr;ctx.font='9px Vazirmatn,sans-serif';ctx.textAlign='right';
    ctx.fillText(['😓','😴','😐','😊','🔥'][v-1],pad.left-2,y+4);
  });
  var pts=recs.map(function(g,i){
    return{x:pad.left+(cW/(recs.length-1))*i,y:pad.top+cH*(1-(g.mood-1)/4)};
  });
  // line
  ctx.beginPath();pts.forEach(function(p,i){i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y);});
  ctx.strokeStyle=getCSSVar('--Y');ctx.lineWidth=2.5;ctx.lineJoin='round';ctx.stroke();
  // dots
  pts.forEach(function(p,pi){
    ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fillStyle=getCSSVar('--Y');ctx.fill();
    ctx.fillStyle=lblClr;ctx.font='8px Vazirmatn,sans-serif';ctx.textAlign='center';
    ctx.fillText((recs[pi].date||'').slice(5),p.x,H-4);
  });
}

function gzRenderSummary(){
  var el=document.getElementById('gz-summary-stats');
  if(!el)return;
  var all=S.gz;
  if(!all.length){el.innerHTML='<p style="color:var(--txt3);font-size:12px">هنوز داده‌ای ثبت نشده</p>';return;}
  var totalH=0,totalT=0,studyDays=0;
  var moodSum=0,moodCnt=0;
  var dayHours=[];
  all.forEach(function(g){
    var h=Object.values(g.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0);
    var t=Object.values(g.subjects||{}).reduce(function(a,v){return a+(v.tests||0);},0);
    totalH+=h;totalT+=t;
    if(h>0){studyDays++;dayHours.push(h);}
    if(g.mood){moodSum+=g.mood;moodCnt++;}
  });
  var avgH=studyDays?totalH/studyDays:0;
  var maxH=dayHours.length?Math.max.apply(null,dayHours):0;
  var avgMood=moodCnt?moodSum/moodCnt:0;
  var stats=[
    {v:gzFmtH(avgH),l:'میانگین روزانه',e:'📊'},
    {v:gzFmtH(maxH),l:'بهترین روز',e:'🏆'},
    {v:pN(studyDays),l:'روز مطالعه',e:'📅'},
    {v:pN(Math.round(totalT/(all.length||1))),l:'تست روزانه',e:'📝'},
    {v:avgMood?['','😓','😴','😐','😊','🔥'][Math.round(avgMood)]+'':' — ',l:'میانگین خلق',e:'😊'},
    {v:pN(totalT),l:'کل تست',e:'📋'},
  ];
  el.innerHTML=stats.map(function(s){
    return'<div style="background:var(--sur2);border:1px solid var(--bdr);border-radius:var(--rs);padding:14px;text-align:center">'
      +'<div style="font-size:20px;margin-bottom:4px">'+s.e+'</div>'
      +'<div style="font-size:18px;font-weight:900;color:var(--acc);letter-spacing:-.5px">'+s.v+'</div>'
      +'<div style="font-size:10px;color:var(--txt3);margin-top:3px;font-weight:700;text-transform:uppercase;letter-spacing:.3px">'+s.l+'</div>'
      +'</div>';
  }).join('');
}



// ════════════════════════════════════════════════════════
// WEEKLY GOAL
// ════════════════════════════════════════════════════════
function gzWgSave(){
  var v=parseInt(document.getElementById('gz-wg-inp').value)||35;
  localStorage.setItem('az_wg_target',v);
  gzWgRender();
}
function gzWgRender(){
  var target=parseInt(localStorage.getItem('az_wg_target'))||35;
  var inpEl=document.getElementById('gz-wg-inp');
  if(inpEl)inpEl.value=target;
  var lbl=document.getElementById('gz-wg-target-lbl');
  if(lbl)lbl.textContent=pN(target);
  var now=new Date();
  var nowDay=now.getDay();
  var daysFromSat=(nowDay+1)%7;
  var weekH=0;
  for(var i=0;i<=daysFromSat;i++){
    var d=new Date(now.getTime()-(daysFromSat-i)*86400000);
    var j=toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
    var ds=j.jy+'/'+String(j.jm).padStart(2,'0')+'/'+String(j.jd).padStart(2,'0');
    var rec=S.gz.find(function(g){return g.date===ds;});
    if(rec)weekH+=Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0);
  }
  var pct=Math.min(Math.round((weekH/target)*100),999);
  var bar=document.getElementById('gz-wg-bar');
  if(bar){
    bar.style.width=Math.min(pct,100)+'%';
    bar.className='wg-bar-fill'+(weekH>=target?' done':pct>100?' over':'');
  }
  var pctLbl=document.getElementById('gz-wg-pct');
  if(pctLbl)pctLbl.textContent=pN(pct)+'% انجام‌شده';
  var doneLbl=document.getElementById('gz-wg-done');
  if(doneLbl)doneLbl.textContent=gzFmtH(weekH);
}

// ════════════════════════════════════════════════════════
// WEEK COMPARE
// ════════════════════════════════════════════════════════
function gzRenderWeekCompare(){
  var el=document.getElementById('gz-week-compare');
  if(!el)return;
  function getWeekData(offsetWeeks){
    var now=new Date();var nowDay=now.getDay();var daysFromSat=(nowDay+1)%7;
    var h=0,t=0,cnt=0;
    for(var i=0;i<7;i++){
      var dayOff=daysFromSat-i+(offsetWeeks*7);
      var d=new Date(now.getTime()-dayOff*86400000);
      if(d>now)continue;
      var j=toJalali(d.getFullYear(),d.getMonth()+1,d.getDate());
      var ds=j.jy+'/'+String(j.jm).padStart(2,'0')+'/'+String(j.jd).padStart(2,'0');
      var rec=S.gz.find(function(g){return g.date===ds;});
      if(rec){
        h+=Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0);
        t+=Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.tests||0);},0);
        cnt++;
      }
    }
    return{h:h,t:t,cnt:cnt};
  }
  var tw=getWeekData(0),lw=getWeekData(1);
  function diff(a,b){
    if(!b)return{cls:'eq',txt:''};
    var d=a-b,pct=Math.round((d/b)*100);
    if(Math.abs(pct)<2)return{cls:'eq',txt:'≈ مشابه'};
    return d>0?{cls:'up',txt:'▲ '+pN(Math.abs(pct))+'% بیشتر'}:{cls:'dn',txt:'▼ '+pN(Math.abs(pct))+'% کمتر'};
  }
  var hd=diff(tw.h,lw.h),td=diff(tw.t,lw.t);
  var rows=[
    {val:gzFmtH(tw.h),lbl:'ساعت این هفته',dif:hd},
    {val:gzFmtH(lw.h),lbl:'ساعت هفته قبل',dif:{cls:'eq',txt:''}},
    {val:pN(tw.t),lbl:'تست این هفته',dif:td},
    {val:pN(lw.t),lbl:'تست هفته قبل',dif:{cls:'eq',txt:''}},
  ];
  el.innerHTML=rows.map(function(s){
    return '<div class="wc-stat"><div class="wc-val">'+s.val+'</div><div class="wc-lbl">'+s.lbl+'</div>'
      +(s.dif.txt?'<div class="wc-diff '+s.dif.cls+'">'+s.dif.txt+'</div>':'')+'</div>';
  }).join('');
}

// ════════════════════════════════════════════════════════
// JALALI CALENDAR
// ════════════════════════════════════════════════════════
var _jCalYear=0,_jCalMonth=0;
function jCalRender(){
  if(!_jCalYear){var t=todayJ().split('/');_jCalYear=parseInt(t[0]);_jCalMonth=parseInt(t[1]);}
  jCalDraw();
}
function jCalPrev(){_jCalMonth--;if(_jCalMonth<1){_jCalMonth=12;_jCalYear--;}jCalDraw();}
function jCalNext(){_jCalMonth++;if(_jCalMonth>12){_jCalMonth=1;_jCalYear++;}jCalDraw();}
function toGregorian(jy,jm,jd){
  var g=[31,28,31,30,31,30,31,31,30,31,30,31],j=[31,31,31,31,31,31,30,30,30,30,30,29];
  var jy2=jy-979,jm2=jm-1,jd2=jd-1;
  var jdn=365*jy2+Math.floor(jy2/4)*8-Math.floor(jy2/100)*2+Math.floor(jy2/400);
  for(var i=0;i<jm2;i++)jdn+=j[i];jdn+=jd2;
  var gdn=jdn+79,gy=1600+400*Math.floor(gdn/146097);gdn%=146097;
  var leap=true;
  if(gdn>=36525){gdn++;gy+=100*Math.floor(gdn/36524);gdn%=36524;if(gdn>=365)gdn++;else leap=false;}
  gy+=4*Math.floor(gdn/1461);gdn%=1461;
  if(gdn>=366){leap=false;gdn--;gy+=Math.floor(gdn/365);gdn%=365;}
  var ii=0;while(gdn>=g[ii]+(ii===1&&leap?1:0)){gdn-=g[ii]+(ii===1&&leap?1:0);ii++;}
  return{gy:gy,gm:ii+1,gd:gdn+1};
}
function jCalDraw(){
  var el=document.getElementById('jcal-grid');var titleEl=document.getElementById('jcal-title');
  if(!el)return;
  var mN=['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
  if(titleEl)titleEl.textContent=mN[_jCalMonth-1]+' '+pN(_jCalYear);
  var dayN=['ش','ی','د','س','چ','پ','ج'];
  var days=_jCalMonth<=6?31:(_jCalMonth<=11?30:29);
  var fg=toGregorian(_jCalYear,_jCalMonth,1);
  var fd=new Date(fg.gy,fg.gm-1,fg.gd);
  var fdow=fd.getDay();
  var startCol=(fdow===6)?0:(fdow+1)%7;
  var today=todayJ();
  var html=dayN.map(function(d){return'<div class="jcal-day-hdr">'+d+'</div>';}).join('');
  for(var c=0;c<startCol;c++)html+='<div class="jcal-cell empty"></div>';
  for(var d=1;d<=days;d++){
    var ds=_jCalYear+'/'+String(_jCalMonth).padStart(2,'0')+'/'+String(d).padStart(2,'0');
    var rec=S.gz.find(function(g){return g.date===ds;});
    var gd2=toGregorian(_jCalYear,_jCalMonth,d);
    var future=new Date(gd2.gy,gd2.gm-1,gd2.gd)>new Date();
    var cls='jcal-cell';
    if(ds===today)cls+=' today';
    else if(future)cls+=' future';
    else if(rec)cls+=' has-rec';
    else cls+=' no-rec';
    var h2=rec?Object.values(rec.subjects||{}).reduce(function(a,v){return a+(v.hours||0);},0):0;
    html+='<div class="'+cls+'" title="'+ds+(h2?' | '+gzFmtH(h2):'')+'"'
      +(rec&&!future?' onclick="jCalOpenDay(\''+ds+'\')"':'')+'>'+pN(d)+'</div>';
  }
  el.innerHTML=html;
}
function jCalOpenDay(ds){
  var rec=S.gz.find(function(g){return g.date===ds;});
  gzOpenAdd(rec?rec.id:null,ds);
}

// ════════════════════════════════════════════════════════
// WEEKLY PLAN
// ════════════════════════════════════════════════════════
var WPLAN_NAMES=['شنبه','یکشنبه','دوشنبه','سه‌شنبه','چهارشنبه','پنجشنبه','جمعه'];
var WPLAN_DOW=[6,0,1,2,3,4,5];
function loadWPlan(){return JSON.parse(localStorage.getItem('az_wplan')||'[[],[],[],[],[],[],[]]');}
function saveWPlan(p){localStorage.setItem('az_wplan',JSON.stringify(p));}
function renderWeekPlan(){
  var el=document.getElementById('wplan-grid');if(!el)return;
  var plan=loadWPlan();var todayDow=new Date().getDay();
  var html='';
  WPLAN_NAMES.forEach(function(name,i){
    var isToday=WPLAN_DOW[i]===todayDow;
    var items=plan[i]||[];
    html+='<div class="wplan-day'+(isToday?' today':'')+'"><div class="wplan-day-name">'+name+'</div>';
    items.forEach(function(item,j){
      html+='<div class="wplan-item"><span style="font-size:10px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(item)+'</span>'
        +'<button class="wplan-item-del" onclick="wplanDel('+i+','+j+')">✕</button></div>';
    });
    html+='<input class="wplan-add-inp" id="wplan-inp-'+i+'" placeholder="+ برنامه..." '
      +'onkeydown="if(event.key===\'Enter\'){wplanAdd('+i+');event.preventDefault()}">';
    html+='</div>';
  });
  el.innerHTML=html;
}
function wplanAdd(i){
  var inp=document.getElementById('wplan-inp-'+i);
  if(!inp||!inp.value.trim())return;
  var p=loadWPlan();p[i]=p[i]||[];p[i].push(inp.value.trim());saveWPlan(p);
  inp.value='';renderWeekPlan();
  setTimeout(function(){var el2=document.getElementById('wplan-inp-'+i);if(el2)el2.focus();},30);
}
function wplanDel(i,j){var p=loadWPlan();p[i].splice(j,1);saveWPlan(p);renderWeekPlan();}
function wplanReset(){
  if(!confirm('برنامه هفتگی پاک بشه؟'))return;
  saveWPlan([[],[],[],[],[],[],[]]);renderWeekPlan();
}

// ════════════════════════════════════════════════════════
// PWA INSTALL
// ════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════
// PWA DETECTION & INSTALL
// ═══════════════════════════════════════════════════════════
let _deferredInstall=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  _deferredInstall=e;
  const el=document.getElementById('pwa-auto-install');
  if(el)el.style.display='block';
  const mg=document.getElementById('pwa-manual-guide');
  if(mg)mg.style.display='none';
});
function installPWA(){
  if(!_deferredInstall)return;
  _deferredInstall.prompt();
  _deferredInstall.userChoice.then(r=>{
    if(r.outcome==='accepted'){
      const ai=document.getElementById('pwa-auto-install');
      if(ai)ai.style.display='none';
      const im=document.getElementById('pwa-installed-msg');
      if(im)im.style.display='block';
      const mg=document.getElementById('pwa-manual-guide');
      if(mg)mg.style.display='none';
    }
    _deferredInstall=null;
  });
}
window.addEventListener('appinstalled',()=>{
  const ai=document.getElementById('pwa-auto-install');
  if(ai)ai.style.display='none';
  const im=document.getElementById('pwa-installed-msg');
  if(im)im.style.display='block';
  const mg=document.getElementById('pwa-manual-guide');
  if(mg)mg.style.display='none';
  _deferredInstall=null;
});
function pwaDetectAndShowGuide(){
  // اگه standalone هست، نصب شده
  if(window.matchMedia('(display-mode:standalone)').matches||window.navigator.standalone){
    const ai=document.getElementById('pwa-auto-install');if(ai)ai.style.display='none';
    const im=document.getElementById('pwa-installed-msg');if(im)im.style.display='block';
    const mg=document.getElementById('pwa-manual-guide');if(mg)mg.style.display='none';
    return;
  }
  // تشخیص پلتفرم
  var ua=navigator.userAgent;
  var isIOS=/iPhone|iPad|iPod/i.test(ua);
  var isAndroid=/Android/i.test(ua);
  var isChromeDesktop=!isIOS&&!isAndroid&&(/Chrome/i.test(ua)&&!/Edg|OPR/i.test(ua));
  document.getElementById('pwa-guide-ios').style.display=isIOS?'block':'none';
  document.getElementById('pwa-guide-android').style.display=isAndroid?'block':'none';
  document.getElementById('pwa-guide-chrome').style.display=isChromeDesktop?'block':'none';
}
</script>
</body>
</html>
